<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Calendar - GovCon Content Generator</title>
    <!-- FullCalendar 6.x - CSS is bundled in the JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Auth Configuration - GovCon Content Generator project
        const SUPABASE_URL = 'https://krpyelfrbicmvsmwovti.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtycHllbGZyYmljbXZzbXdvdnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNzU1MDAsImV4cCI6MjA4MzY1MTUwMH0.xI3qosl35ieKa5ObeExh0BiSwDdoZy74lZQWg1Fzn6M';

        // API base for Content Generator backend
        const API_BASE = '';

        // Base path is always /content-generator/ since files are in that folder
        function getBasePath() {
            return '/content-generator/';
        }
        function getAppUrl(page) {
            if (page === 'auth') return getBasePath() + 'auth.html';
            return getBasePath() + page;
        }

        if (typeof window.supabase === 'undefined') {
            console.error('Supabase SDK not loaded');
            window.SupabaseAuth = {
                initAuth: async () => null,
                loadUserProfile: async () => null,
                saveUserProfile: async () => null,
                requireAuth: () => false,
                getUserTier: () => 'content-engine',
                hasTierAccess: () => true,
                signOut: async () => { window.location.href = getAppUrl('auth'); },
                getAuthHeaders: () => ({}),
                get user() { return null; },
                get session() { return null; },
                get profile() { return null; }
            };
        } else {
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    persistSession: true,
                    storageKey: 'gcg-auth',
                    storage: window.localStorage,
                    autoRefreshToken: true,
                    detectSessionInUrl: true
                }
            });
            let currentUser = null;
            let currentSession = null;
            let userProfile = null;

            async function initAuth() {
                try {
                    // If we already have a session from onAuthStateChange, use it
                    if (currentSession) {
                        return currentSession;
                    }

                    // Use a timeout to prevent hanging due to region latency
                    const sessionPromise = supabaseClient.auth.getSession();
                    const timeoutPromise = new Promise((_, reject) =>
                        setTimeout(() => reject(new Error('getSession timeout')), 3000)
                    );

                    try {
                        const { data: { session }, error } = await Promise.race([sessionPromise, timeoutPromise]);
                        if (error) { console.error('Auth error:', error); return null; }
                        if (session) {
                            currentSession = session;
                            currentUser = session.user;
                            await loadUserProfile();
                            return session;
                        }
                    } catch (timeoutErr) {
                        // Check if onAuthStateChange set the session while we were waiting
                        if (currentSession) {
                            return currentSession;
                        }
                    }

                    return null;
                } catch (error) { console.error('Init auth error:', error); return null; }
            }

            async function loadUserProfile() {
                if (!currentUser) return null;
                try {
                    const { data, error } = await supabaseClient.from('user_profiles').select('*').eq('user_id', currentUser.id).single();
                    if (error && error.code !== 'PGRST116') { console.error('Profile load error:', error); return null; }
                    userProfile = data;
                    return data;
                } catch (error) { console.error('Load profile error:', error); return null; }
            }

            async function saveUserProfile(profileData) {
                if (!currentUser) return null;
                try {
                    // Validate UUID before write
                    const userId = validateUserId(currentUser.id);
                    const { data, error } = await supabaseClient.from('user_profiles').upsert({
                        user_id: userId, ...profileData, updated_at: new Date().toISOString()
                    }).select().single();
                    if (error) { console.error('Profile save error:', error); return null; }
                    userProfile = data;
                    return data;
                } catch (error) { console.error('Save profile error:', error); return null; }
            }

            function requireAuth(redirectTo = '/auth') {
                if (!currentSession) { window.location.href = getAppUrl('auth'); return false; }
                return true;
            }

            function getUserTier() { return userProfile?.tier || 'content-engine'; }

            function hasTierAccess(requiredTier) {
                const tierLevels = { 'content-engine': 1, 'full-fix': 2 };
                return (tierLevels[getUserTier()] || 0) >= (tierLevels[requiredTier] || 0);
            }

            async function signOut() {
                try {
                    await supabaseClient.auth.signOut();
                    currentUser = null; currentSession = null; userProfile = null;
                    window.location.href = getAppUrl('auth');
                } catch (error) { console.error('Sign out error:', error); }
            }

            function getAuthHeaders() {
                if (!currentSession) return {};
                return { 'Authorization': `Bearer ${currentSession.access_token}`, 'Content-Type': 'application/json' };
            }

            // UUID validation guard - ensures we never accidentally use email as user_id
            function validateUserId(userId) {
                if (!userId) {
                    console.error('[Auth Guard] No user ID provided');
                    throw new Error('No authenticated user');
                }
                // UUID format: 8-4-4-4-12 hex characters
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (typeof userId !== 'string' || !uuidRegex.test(userId)) {
                    console.error('[Auth Guard] Invalid UUID format:', userId);
                    throw new Error('Invalid user ID format - expected UUID');
                }
                return userId;
            }

            // Get validated user ID for write operations
            function getValidatedUserId() {
                if (!currentUser?.id) {
                    throw new Error('No authenticated user');
                }
                return validateUserId(currentUser.id);
            }

            // Safe write wrappers - bulletproof user_id injection
            async function safeInsert(table, data) {
                const userId = getValidatedUserId();
                return supabaseClient.from(table).insert({ ...data, user_id: userId });
            }

            async function safeUpdate(table, id, updates) {
                const userId = getValidatedUserId();
                return supabaseClient.from(table).update({ ...updates, updated_at: new Date().toISOString() }).eq('id', id).eq('user_id', userId);
            }

            async function safeDelete(table, id) {
                const userId = getValidatedUserId();
                return supabaseClient.from(table).delete().eq('id', id).eq('user_id', userId);
            }

            async function safeUpsert(table, data, options = {}) {
                const userId = getValidatedUserId();
                return supabaseClient.from(table).upsert({ ...data, user_id: userId, updated_at: new Date().toISOString() }, options);
            }

            function safeSelect(table, columns = '*') {
                const userId = getValidatedUserId();
                return supabaseClient.from(table).select(columns).eq('user_id', userId);
            }

            // Listen for auth state changes - Global init script
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state:', event, session?.user?.id);
                if (session) {
                    // Update session for any event that provides one (SIGNED_IN, TOKEN_REFRESHED, etc.)
                    currentSession = session;
                    currentUser = session.user;
                    // Store userId globally for quick access
                    window.currentUserId = session.user.id;
                    if (event === 'SIGNED_IN') {
                        await loadUserProfile();
                    }
                } else if (event === 'SIGNED_OUT' || !session) {
                    currentUser = null; currentSession = null; userProfile = null;
                    window.currentUserId = null;
                    window.location.href = getAppUrl('auth');
                }
            });

            window.SupabaseAuth = {
                client: supabaseClient, initAuth, loadUserProfile, saveUserProfile,
                requireAuth, getUserTier, hasTierAccess, signOut, getAuthHeaders,
                validateUserId, getValidatedUserId,
                safeInsert, safeUpdate, safeDelete, safeUpsert, safeSelect,
                get user() { return currentUser; },
                get session() { return currentSession; },
                get profile() { return userProfile; }
            };
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            color: #f1f5f9;
        }

        .header {
            background: rgba(15, 23, 42, 0.8);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }

        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, #22d3ee, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tier-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .tier-badge.content-engine {
            background: rgba(234, 179, 8, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }

        .tier-badge.full-fix {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .nav-links {
            display: flex;
            gap: 0.5rem;
        }

        .nav-link {
            padding: 0.5rem 1rem;
            background: rgba(51, 65, 85, 0.5);
            color: #f1f5f9;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #3b82f6, #22d3ee);
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-header h2 {
            font-size: 1.3rem;
            color: #fff;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #22d3ee);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.5);
            color: #f1f5f9;
            border: 1px solid #334155;
        }

        .btn-secondary:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        #calendar {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid #334155;
            min-height: 600px;
        }

        /* FullCalendar custom styling */
        .fc {
            --fc-border-color: #334155;
            --fc-button-bg-color: rgba(59, 130, 246, 0.3);
            --fc-button-border-color: rgba(59, 130, 246, 0.5);
            --fc-button-hover-bg-color: rgba(59, 130, 246, 0.5);
            --fc-button-hover-border-color: rgba(59, 130, 246, 0.7);
            --fc-button-active-bg-color: #3b82f6;
            --fc-button-active-border-color: #3b82f6;
            --fc-today-bg-color: rgba(34, 211, 238, 0.1);
            --fc-event-bg-color: #3b82f6;
            --fc-event-border-color: #3b82f6;
            --fc-page-bg-color: transparent;
        }

        .fc .fc-toolbar-title {
            color: #f1f5f9;
            font-size: 1.3rem;
        }

        .fc .fc-col-header-cell-cushion,
        .fc .fc-daygrid-day-number {
            color: #f1f5f9;
        }

        .fc .fc-daygrid-day.fc-day-today {
            background: rgba(59, 130, 246, 0.15) !important;
        }

        .fc-event {
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 0.8rem;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .fc-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Post type colors */
        .fc-event.status-scheduled {
            /* Default styling - individual event colors override this */
        }

        .fc-event.post-type-carousel {
            background: #8b5cf6 !important;
            border-color: #8b5cf6 !important;
        }

        .fc-event.post-type-graphic {
            background: #10b981 !important;
            border-color: #10b981 !important;
        }

        .fc-event.status-posted {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
        }

        .fc-event.status-cancelled {
            background: rgba(107, 114, 128, 0.5);
            border-color: #6b7280;
            text-decoration: line-through;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(2, 6, 23, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #334155;
        }

        .modal h3 {
            margin-bottom: 1.5rem;
            color: #fff;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #334155;
            border-radius: 8px;
            background: #0f172a;
            color: #f1f5f9;
            font-size: 0.95rem;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .modal-actions {
            display: flex;
            gap: 0.8rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .library-picker {
            margin-bottom: 1rem;
        }

        .library-item {
            padding: 0.8rem;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .library-item:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .library-item.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }

        .library-item-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.3rem;
        }

        .library-item-preview {
            color: #94a3b8;
            font-size: 0.85rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.scheduled {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .status-badge.posted {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .status-badge.cancelled {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-color.scheduled {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .legend-color.posted {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .legend-color.cancelled {
            background: rgba(107, 114, 128, 0.5);
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Tabs for modal */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #334155;
            padding-bottom: 0.5rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #f1f5f9;
            background: rgba(51, 65, 85, 0.5);
        }

        .tab.active {
            color: #f1f5f9;
            background: rgba(59, 130, 246, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .library-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        /* Pro Upsell Banner */
        .pro-upsell {
            margin-top: 1.5rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(34, 211, 238, 0.15));
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
        }

        .pro-upsell-content {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .pro-upsell-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #22d3ee);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .pro-upsell-text {
            flex: 1;
            min-width: 200px;
        }

        .pro-upsell-text strong {
            color: #22d3ee;
            font-size: 1rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .pro-upsell-text p {
            color: #94a3b8;
            font-size: 0.9rem;
            margin: 0;
        }

        .btn-upgrade {
            background: linear-gradient(135deg, #3b82f6, #22d3ee);
            color: #fff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-upgrade:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .calendar-header {
                flex-direction: column;
                gap: 1rem;
            }

            .modal {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>GovCon Content Generator</h1>
        <div class="header-right">
            <span id="tier-badge" class="tier-badge"></span>
            <nav class="nav-links">
                <a href="/content-generator/" class="nav-link">Generator</a>
                <a href="/content-generator/library.html" class="nav-link">Library</a>
                <a href="/content-generator/calendar.html" class="nav-link active">Calendar</a>
                <button onclick="logout()" class="nav-link" style="border: none; cursor: pointer;">Logout</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="calendar-header">
            <div>
                <h2>Content Calendar</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color scheduled"></div>
                        <span>Scheduled</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color posted"></div>
                        <span>Posted</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color cancelled"></div>
                        <span>Cancelled</span>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 0.75rem;">
                <button class="btn btn-secondary" onclick="exportMonthToPDF()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 4px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download PDF
                </button>
                <button class="btn btn-primary" onclick="openScheduleModal()">+ Schedule Post</button>
            </div>
        </div>

        <div id="calendar"></div>

    </div>

    <!-- Schedule Modal -->
    <div id="schedule-modal" class="modal-overlay">
        <div class="modal">
            <h3 id="modal-title">Schedule New Post</h3>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('library')">From Library</button>
                <button class="tab" onclick="switchTab('custom')">Custom Post</button>
            </div>

            <form id="schedule-form">
                <input type="hidden" id="schedule-id">
                <input type="hidden" id="content-id">

                <!-- Library Tab -->
                <div id="library-tab" class="tab-content active">
                    <div class="form-group">
                        <label>Select from your library:</label>
                        <div id="library-list" class="library-list">
                            <div class="empty-state">Loading library...</div>
                        </div>
                    </div>
                </div>

                <!-- Custom Tab -->
                <div id="custom-tab" class="tab-content">
                    <div class="form-group">
                        <label for="post-title">Title</label>
                        <input type="text" id="post-title" placeholder="Enter a title for this post">
                    </div>

                    <div class="form-group">
                        <label for="post-content">Content</label>
                        <textarea id="post-content" placeholder="Enter your post content..."></textarea>
                    </div>
                </div>

                <!-- Common Fields -->
                <div class="form-group">
                    <label for="schedule-date">Schedule Date & Time</label>
                    <input type="datetime-local" id="schedule-date" required>
                </div>

                <div class="form-group">
                    <label for="post-status">Status</label>
                    <select id="post-status">
                        <option value="scheduled">Scheduled</option>
                        <option value="posted">Posted</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="delete-btn" style="display: none;" onclick="deleteScheduledPost()">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Modal -->
    <div id="view-modal" class="modal-overlay">
        <div class="modal">
            <h3 id="view-title">Scheduled Post</h3>
            <div id="view-content" style="white-space: pre-wrap; margin-bottom: 1rem; color: #e0e0e0;"></div>
            <div style="margin-bottom: 1rem;">
                <span class="status-badge" id="view-status"></span>
                <span style="color: #a0a0a0; margin-left: 1rem;" id="view-date"></span>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeViewModal()">Close</button>
                <button class="btn btn-primary" onclick="editFromView()">Edit</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <!-- First-Time User Welcome Modal -->
    <div id="welcome-modal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #3b82f6, #22d3ee); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>
                        <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01"/>
                    </svg>
                </div>
                <h3 style="color: #fff; font-size: 1.4rem; margin-bottom: 0.5rem;">Your Calendar is Empty!</h3>
                <p style="color: #94a3b8;">Let's fill it with 30 days of AI-generated LinkedIn content.</p>
            </div>

            <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                <p style="color: #60a5fa; font-weight: 600; margin-bottom: 0.5rem;">What you'll get:</p>
                <ul style="color: #f1f5f9; font-size: 0.9rem; list-style: none; padding: 0; margin: 0;">
                    <li style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="#10b981"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        30 unique LinkedIn posts (1 per day)
                    </li>
                    <li style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="#10b981"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        Auto-scheduled to your calendar
                    </li>
                    <li style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="#10b981"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        Targeted to your company & agencies
                    </li>
                    <li style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="#10b981"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        Drag, drop & edit anytime
                    </li>
                </ul>
            </div>

            <p id="profile-warning" style="display: none; color: #fbbf24; font-size: 0.85rem; text-align: center; margin-bottom: 1rem;">
                ⚠️ Please complete your company profile first in the <a href="/content-generator/" style="color: #22d3ee;">Generator</a> page.
            </p>

            <div class="modal-actions" style="justify-content: center;">
                <button class="btn btn-secondary" onclick="closeWelcomeModal()">Maybe Later</button>
                <button id="generate-btn" class="btn btn-primary" onclick="generate30DayCalendar()" style="display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Generate 30 Days
                </button>
            </div>
        </div>
    </div>

    <!-- Generation Progress Modal -->
    <div id="progress-modal" class="modal-overlay">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div style="margin-bottom: 1.5rem;">
                <div class="spinner" style="width: 50px; height: 50px; border: 4px solid rgba(59, 130, 246, 0.2); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
            <h3 style="color: #f1f5f9; margin-bottom: 0.5rem;">Generating Your Calendar</h3>
            <p id="progress-text" style="color: #94a3b8; margin-bottom: 1rem;">Finding target agencies...</p>
            <div style="background: rgba(51,65,85,0.5); border-radius: 8px; height: 8px; overflow: hidden; margin-bottom: 0.5rem;">
                <div id="progress-bar" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #22d3ee); width: 0%; transition: width 0.5s;"></div>
            </div>
            <p id="progress-count" style="color: #94a3b8; font-size: 0.85rem;">0 of 30 posts created</p>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        let calendar;
        let libraryItems = [];
        let selectedLibraryItem = null;
        let currentViewEvent = null;
        let hasCheckedFirstTime = false;

        // Check if user has any scheduled posts (first-time detection)
        async function checkFirstTimeUser() {
            if (hasCheckedFirstTime) return;
            hasCheckedFirstTime = true;

            const user = SupabaseAuth.user;
            if (!user) return;

            // Don't show if user dismissed it before
            if (localStorage.getItem('gcg_calendar_welcome_seen')) return;

            try {
                const { count, error } = await SupabaseAuth.client
                    .from('scheduled_posts')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', user.id);

                if (error) throw error;

                // Show welcome modal if no posts
                if (count === 0) {
                    // Check if user has a profile
                    const profile = SupabaseAuth.profile;
                    if (!profile?.company_name) {
                        document.getElementById('profile-warning').style.display = 'block';
                        document.getElementById('generate-btn').disabled = true;
                        document.getElementById('generate-btn').style.opacity = '0.5';
                    }
                    document.getElementById('welcome-modal').classList.add('active');
                }
            } catch (error) {
                console.error('Error checking first time user:', error);
            }
        }

        function closeWelcomeModal() {
            document.getElementById('welcome-modal').classList.remove('active');
            localStorage.setItem('gcg_calendar_welcome_seen', 'true');
        }

        // Generate 30-day content calendar
        async function generate30DayCalendar() {
            const user = SupabaseAuth.user;
            if (!user) {
                showToast('Please sign in first', 'error');
                return;
            }

            // Close welcome modal, show progress modal
            document.getElementById('welcome-modal').classList.remove('active');
            document.getElementById('progress-modal').classList.add('active');

            const progressText = document.getElementById('progress-text');
            const progressBar = document.getElementById('progress-bar');
            const progressCount = document.getElementById('progress-count');

            try {
                // Step 1: Get company profile
                progressText.textContent = 'Loading your company profile...';
                progressBar.style.width = '5%';

                const profile = SupabaseAuth.profile;
                if (!profile?.company_name) {
                    throw new Error('Please complete your company profile first');
                }

                // Step 2: Find agencies
                progressText.textContent = 'Finding target agencies...';
                progressBar.style.width = '15%';

                const naicsCodes = profile.naics_codes || [];
                let agencies = [];

                if (naicsCodes.length > 0) {
                    const agencyResponse = await fetch(`${API_BASE}/api/agencies/lookup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            naicsCodes: naicsCodes,
                            businessFormation: profile.business_type || ''
                        })
                    });
                    const agencyResult = await agencyResponse.json();
                    if (agencyResult.success) {
                        agencies = agencyResult.agencies.slice(0, 5);
                    }
                }
                progressBar.style.width = '25%';

                // Step 3: Generate 30 posts
                progressText.textContent = 'Generating your content calendar...';
                progressBar.style.width = '30%';

                const generateResponse = await fetch(`${API_BASE}/api/generate-30day`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...SupabaseAuth.getAuthHeaders()
                    },
                    body: JSON.stringify({
                        profile: {
                            companyName: profile.company_name,
                            coreServices: profile.core_services || '',
                            differentiators: profile.differentiators || '',
                            certifications: Array.isArray(profile.certifications) ? profile.certifications.join(', ') : (profile.certifications || ''),
                            contractVehicles: Array.isArray(profile.contract_vehicles) ? profile.contract_vehicles.join(', ') : (profile.contract_vehicles || ''),
                            businessFormation: profile.business_type || ''
                        },
                        agencies: agencies.map(a => a.name),
                        userId: user.id
                    })
                });

                // Handle streaming response
                const reader = generateResponse.body.getReader();
                const decoder = new TextDecoder();
                let postsCreated = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const text = decoder.decode(value);
                    const lines = text.split('\n').filter(l => l.trim());

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.progress) {
                                    postsCreated = data.progress;
                                    const percent = 30 + (postsCreated / 30) * 65;
                                    progressBar.style.width = `${percent}%`;
                                    progressCount.textContent = `${postsCreated} of 30 posts created`;
                                    progressText.textContent = data.message || 'Generating posts...';
                                }
                                if (data.complete) {
                                    progressBar.style.width = '100%';
                                    progressText.textContent = 'All done! Refreshing calendar...';
                                }
                            } catch (e) {}
                        }
                    }
                }

                // Success - refresh calendar
                localStorage.setItem('gcg_calendar_welcome_seen', 'true');
                showToast('30-day calendar generated!', 'success');

                setTimeout(() => {
                    document.getElementById('progress-modal').classList.remove('active');
                    calendar.refetchEvents();
                }, 1500);

            } catch (error) {
                console.error('Error generating calendar:', error);
                document.getElementById('progress-modal').classList.remove('active');
                showToast(error.message || 'Error generating calendar', 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if we just came from auth
            const urlParams = new URLSearchParams(window.location.search);
            const justSignedIn = urlParams.get('auth') === 'success' || sessionStorage.getItem('gcg_just_signed_in');

            // Check auth using Supabase with retry for fresh logins
            let session = await SupabaseAuth.initAuth();

            // Retry a few times - session may not be immediately available
            if (!session) {
                for (let i = 0; i < 5; i++) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    session = await SupabaseAuth.initAuth();
                    if (session) break;
                }
            }

            // Clean up session markers
            if (justSignedIn) {
                sessionStorage.removeItem('gcg_just_signed_in');
                if (urlParams.get('auth')) {
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }

            // All users now have Supabase sessions via magic links
            if (!session) {
                window.location.href = getAppUrl('auth');
                return;
            }

            // Initialize page components
            initializeTier();
            initCalendar();
            loadLibraryItems();
            subscribeToRealtimeUpdates();

            // Check if first-time user (no scheduled posts)
            setTimeout(() => checkFirstTimeUser(), 1000);
        });

        // Subscribe to realtime updates for scheduled posts
        function subscribeToRealtimeUpdates() {
            const user = SupabaseAuth.user;
            if (!user) return;

            SupabaseAuth.client
                .channel('scheduled_posts_changes')
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'scheduled_posts',
                        filter: `user_id=eq.${user.id}`
                    },
                    () => calendar.refetchEvents()
                )
                .subscribe();
        }

        // Logout function
        function logout() {
            // Clear any legacy localStorage (can be removed later)
            localStorage.removeItem('gcg_access');
            localStorage.removeItem('gcg_email');
            localStorage.removeItem('gcg_tier');
            localStorage.removeItem('gcg_tier_name');
            // Sign out of Supabase
            SupabaseAuth.signOut();
        }

        function initializeTier() {
            const tier = SupabaseAuth.profile?.tier;
            const tierBadge = document.getElementById('tier-badge');

            if (tier === 'full-fix') {
                tierBadge.textContent = 'Full Fix';
                tierBadge.className = 'tier-badge full-fix';
                tierBadge.classList.remove('hidden');
            } else if (tier === 'content-engine') {
                tierBadge.textContent = 'Content Engine';
                tierBadge.className = 'tier-badge content-engine';
                tierBadge.classList.remove('hidden');
            } else {
                // No valid tier - hide the badge (no free tier exists)
                tierBadge.classList.add('hidden');
            }

        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl || typeof FullCalendar === 'undefined') {
                console.error('Calendar initialization failed');
                return;
            }
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,dayGridWeek'
                },
                // Fetch events from server API (bypasses RLS issues)
                events: async function(fetchInfo, successCallback, failureCallback) {
                    const user = SupabaseAuth.user;

                    console.log('[Calendar] Fetching events for user:', user?.id);
                    console.log('[Calendar] Date range:', fetchInfo.startStr, 'to', fetchInfo.endStr);

                    if (!user) {
                        console.warn('[Calendar] No user found, returning empty');
                        successCallback([]);
                        return;
                    }
                    try {
                        // All users now have Supabase sessions
                        const headers = SupabaseAuth.getAuthHeaders();
                        const url = `${API_BASE}/api/calendar-events?start=${encodeURIComponent(fetchInfo.startStr)}&end=${encodeURIComponent(fetchInfo.endStr)}`;
                        console.log('[Calendar] Auth headers:', Object.keys(headers), headers.Authorization ? 'has token' : 'no token');

                        const response = await fetch(url, {
                            headers: headers
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('[Calendar] API error:', response.status, errorText.substring(0, 200));
                            successCallback([]);
                            return;
                        }

                        const result = await response.json();
                        console.log('[Calendar] API result:', { count: result.events?.length, success: result.success });

                        if (!result.success) {
                            console.error('[Calendar] Error:', result.error);
                            successCallback([]);
                            return;
                        }

                        const events = (result.events || []).map(post => {
                            // Color based on post type
                            let backgroundColor = '#3b82f6'; // Default blue for LinkedIn text
                            if (post.post_type === 'carousel' || post.title?.toLowerCase().includes('carousel')) {
                                backgroundColor = '#8b5cf6'; // Purple for carousel
                            } else if (post.post_type === 'graphic' || post.title?.toLowerCase().includes('graphic')) {
                                backgroundColor = '#10b981'; // Green for graphic
                            }

                            return {
                                id: post.id,
                                title: post.title,
                                start: post.scheduled_at,
                                backgroundColor: backgroundColor,
                                borderColor: backgroundColor,
                                textColor: '#ffffff',
                                extendedProps: {
                                    content: post.content,
                                    status: post.status || 'scheduled',
                                    content_id: post.content_id,
                                    post_type: post.post_type
                                }
                            };
                        });
                        successCallback(events);
                    } catch (error) {
                        console.error('Error fetching events:', error);
                        successCallback([]);
                    }
                },
                editable: true,
                selectable: true,

                // Click on date to create new post
                select: async function(info) {
                    openScheduleModal(info.start);
                },

                // Click on event to view/edit
                eventClick: function(info) {
                    currentViewEvent = info.event;
                    document.getElementById('view-title').textContent = info.event.title;
                    document.getElementById('view-content').textContent = info.event.extendedProps.content || 'No content';
                    document.getElementById('view-status').textContent = info.event.extendedProps.status;
                    document.getElementById('view-status').className = 'status-badge ' + info.event.extendedProps.status;
                    document.getElementById('view-date').textContent = new Date(info.event.start).toLocaleString();
                    document.getElementById('view-modal').classList.add('active');
                },

                // Drag and drop to reschedule
                eventDrop: async function(info) {
                    try {
                        // Use safeUpdate - bulletproof user_id validation
                        const { error } = await SupabaseAuth.safeUpdate('scheduled_posts', info.event.id, {
                            scheduled_at: info.event.start.toISOString()
                        });

                        if (error) throw error;
                        showToast('Post rescheduled successfully', 'success');
                    } catch (error) {
                        info.revert();
                        showToast('Error rescheduling post', 'error');
                    }
                },

                eventClassNames: function(arg) {
                    return ['status-' + (arg.event.extendedProps.status || 'scheduled')];
                },

                // Tooltip on hover - show content preview
                eventDidMount: function(info) {
                    const content = info.event.extendedProps.content || '';
                    const preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
                    info.el.title = preview || info.event.title;
                },

                // Event display settings
                eventDisplay: 'block'
            });
            calendar.render();
        }

        async function loadLibraryItems() {
            const user = SupabaseAuth.user;

            if (!user) {
                renderLibraryList();
                return;
            }
            try {
                // All users now have Supabase sessions
                const result = await SupabaseAuth.client
                    .from('content_library')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });
                const { data, error } = result;

                if (error) throw error;

                libraryItems = data || [];
                renderLibraryList();
            } catch (error) {
                console.error('Error loading library:', error);
            }
        }

        function renderLibraryList() {
            const container = document.getElementById('library-list');

            if (libraryItems.length === 0) {
                container.innerHTML = '<div class="empty-state">No items in your library yet. Create some content first!</div>';
                return;
            }

            container.innerHTML = libraryItems.map(item => `
                <div class="library-item ${selectedLibraryItem?.id === item.id ? 'selected' : ''}"
                     onclick="selectLibraryItem('${item.id}')">
                    <div class="library-item-title">${item.title || 'Untitled'}</div>
                    <div class="library-item-preview">${item.content.substring(0, 100)}...</div>
                </div>
            `).join('');
        }

        function selectLibraryItem(id) {
            selectedLibraryItem = libraryItems.find(item => item.id === id);
            renderLibraryList();

            // Auto-fill title
            if (selectedLibraryItem) {
                document.getElementById('post-title').value = selectedLibraryItem.title || '';
                document.getElementById('post-content').value = selectedLibraryItem.content || '';
                document.getElementById('content-id').value = selectedLibraryItem.id;
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'library') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('library-tab').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('custom-tab').classList.add('active');
            }
        }

        function openScheduleModal(date = null) {
            document.getElementById('modal-title').textContent = 'Schedule New Post';
            document.getElementById('schedule-form').reset();
            document.getElementById('schedule-id').value = '';
            document.getElementById('content-id').value = '';
            document.getElementById('delete-btn').style.display = 'none';
            selectedLibraryItem = null;
            renderLibraryList();

            // Set default date
            if (date) {
                const dateStr = new Date(date).toISOString().slice(0, 16);
                document.getElementById('schedule-date').value = dateStr;
            } else {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0, 0, 0);
                document.getElementById('schedule-date').value = tomorrow.toISOString().slice(0, 16);
            }

            switchTab('library');
            document.getElementById('schedule-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('schedule-modal').classList.remove('active');
        }

        function closeViewModal() {
            document.getElementById('view-modal').classList.remove('active');
            currentViewEvent = null;
        }

        function handleDateClick(info) {
            openScheduleModal(info.date);
        }

        function handleEventClick(info) {
            currentViewEvent = info.event;

            document.getElementById('view-title').textContent = info.event.title;
            document.getElementById('view-content').textContent = info.event.extendedProps.content;
            document.getElementById('view-status').textContent = info.event.extendedProps.status;
            document.getElementById('view-status').className = 'status-badge ' + info.event.extendedProps.status;
            document.getElementById('view-date').textContent = new Date(info.event.start).toLocaleString();

            document.getElementById('view-modal').classList.add('active');
        }

        function editFromView() {
            closeViewModal();

            if (currentViewEvent) {
                document.getElementById('modal-title').textContent = 'Edit Scheduled Post';
                document.getElementById('schedule-id').value = currentViewEvent.id;
                document.getElementById('content-id').value = currentViewEvent.extendedProps.content_id || '';
                document.getElementById('post-title').value = currentViewEvent.title;
                document.getElementById('post-content').value = currentViewEvent.extendedProps.content;
                document.getElementById('schedule-date').value = new Date(currentViewEvent.start).toISOString().slice(0, 16);
                document.getElementById('post-status').value = currentViewEvent.extendedProps.status;
                document.getElementById('delete-btn').style.display = 'block';

                switchTab('custom');
                document.getElementById('schedule-modal').classList.add('active');
            }
        }

        // Form submission
        document.getElementById('schedule-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const id = document.getElementById('schedule-id').value;
            const contentId = document.getElementById('content-id').value;
            const title = document.getElementById('post-title').value || selectedLibraryItem?.title || 'Untitled';
            const content = document.getElementById('post-content').value || selectedLibraryItem?.content || '';
            const scheduledDate = document.getElementById('schedule-date').value;
            const status = document.getElementById('post-status').value;

            if (!title) {
                showToast('Please enter a title', 'error');
                return;
            }

            try {
                if (id) {
                    // Use safeUpdate - bulletproof user_id validation
                    const { error } = await SupabaseAuth.safeUpdate('scheduled_posts', id, {
                        title,
                        content,
                        scheduled_at: new Date(scheduledDate).toISOString(),
                        status,
                        content_id: contentId || null
                    });

                    if (error) throw error;
                    showToast('Post updated successfully', 'success');
                } else {
                    // Use safeInsert - bulletproof user_id validation
                    const { error } = await SupabaseAuth.safeInsert('scheduled_posts', {
                        title,
                        content,
                        scheduled_at: new Date(scheduledDate).toISOString(),
                        status: 'scheduled',
                        post_type: selectedLibraryItem?.post_type || 'linkedin',
                        content_id: contentId || null
                    });

                    if (error) throw error;
                    showToast('Post scheduled successfully', 'success');
                }

                closeModal();
                calendar.refetchEvents();
            } catch (error) {
                console.error('Error saving scheduled post:', error);
                showToast('Error saving scheduled post', 'error');
            }
        });

        async function deleteScheduledPost() {
            const id = document.getElementById('schedule-id').value;

            if (!id || !confirm('Are you sure you want to delete this scheduled post?')) {
                return;
            }

            try {
                // Use safeDelete - bulletproof user_id validation
                const { error } = await SupabaseAuth.safeDelete('scheduled_posts', id);

                if (error) throw error;

                showToast('Post deleted successfully', 'success');
                closeModal();
                calendar.refetchEvents();
            } catch (error) {
                console.error('Error deleting post:', error);
                showToast('Error deleting post', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Export current month's posts to PDF
        async function exportMonthToPDF() {
            const user = SupabaseAuth.user;
            if (!user) {
                showToast('Please sign in to export', 'error');
                return;
            }

            showToast('Generating PDF...', 'info');

            try {
                // Get current month from calendar view
                const currentDate = calendar.getDate();
                const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59);

                // Fetch posts for current month
                const { data: posts, error } = await SupabaseAuth.client
                    .from('scheduled_posts')
                    .select('*')
                    .eq('user_id', user.id)
                    .gte('scheduled_at', startOfMonth.toISOString())
                    .lte('scheduled_at', endOfMonth.toISOString())
                    .order('scheduled_at', { ascending: true });

                if (error) throw error;

                if (!posts || posts.length === 0) {
                    showToast('No posts found for this month', 'info');
                    return;
                }

                // Format month name
                const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });

                // Generate PDF content
                const pdfContent = generatePDFHTML(posts, monthName);

                // Open print dialog (browser's native PDF export)
                const printWindow = window.open('', '_blank');
                printWindow.document.write(pdfContent);
                printWindow.document.close();
                printWindow.focus();

                // Small delay to ensure styles are loaded
                setTimeout(() => {
                    printWindow.print();
                }, 500);

                showToast('PDF ready for download!', 'success');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showToast('Error generating PDF', 'error');
            }
        }

        function generatePDFHTML(posts, monthName) {
            const postRows = posts.map((post, index) => {
                const date = new Date(post.scheduled_at);
                const dateStr = date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                const timeStr = date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit'
                });
                const statusClass = post.status === 'posted' ? 'posted' :
                                   post.status === 'cancelled' ? 'cancelled' : 'scheduled';

                return `
                    <tr>
                        <td class="date-cell">
                            <strong>${dateStr}</strong><br>
                            <span class="time">${timeStr}</span>
                        </td>
                        <td class="content-cell">
                            <strong>${post.title || 'Untitled'}</strong>
                            <p>${(post.content || '').substring(0, 200)}${post.content?.length > 200 ? '...' : ''}</p>
                        </td>
                        <td class="status-cell">
                            <span class="status ${statusClass}">${post.status}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Content Calendar - ${monthName}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            padding: 2rem;
                            color: #1a1a2e;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 2rem;
                            padding-bottom: 1rem;
                            border-bottom: 2px solid #3b82f6;
                        }
                        .header h1 {
                            color: #3b82f6;
                            font-size: 1.8rem;
                            margin-bottom: 0.5rem;
                        }
                        .header p {
                            color: #666;
                            font-size: 1rem;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 1rem;
                        }
                        th {
                            background: #3b82f6;
                            color: white;
                            padding: 0.75rem;
                            text-align: left;
                            font-size: 0.9rem;
                        }
                        td {
                            padding: 0.75rem;
                            border-bottom: 1px solid #e0e0e0;
                            vertical-align: top;
                            font-size: 0.85rem;
                        }
                        .date-cell { width: 120px; }
                        .date-cell .time { color: #666; font-size: 0.8rem; }
                        .content-cell { }
                        .content-cell strong { display: block; margin-bottom: 0.25rem; color: #0f172a; }
                        .content-cell p { color: #666; margin: 0; line-height: 1.4; }
                        .status-cell { width: 100px; text-align: center; }
                        .status {
                            display: inline-block;
                            padding: 0.25rem 0.5rem;
                            border-radius: 4px;
                            font-size: 0.75rem;
                            font-weight: 600;
                            text-transform: uppercase;
                        }
                        .status.scheduled { background: #dbeafe; color: #3b82f6; }
                        .status.posted { background: #d1fae5; color: #059669; }
                        .status.cancelled { background: #e5e7eb; color: #6b7280; }
                        .footer {
                            margin-top: 2rem;
                            text-align: center;
                            color: #a0a0a0;
                            font-size: 0.8rem;
                        }
                        @media print {
                            body { padding: 0.5rem; }
                            .header { margin-bottom: 1rem; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>LinkedIn Content Calendar</h1>
                        <p>${monthName} - ${posts.length} posts scheduled</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Content</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${postRows}
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>Generated by GovCon Content Generator</p>
                    </div>
                </body>
                </html>
            `;
        }
    </script>
</body>
</html>
