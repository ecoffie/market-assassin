<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovCon Content Generator | AI-Powered LinkedIn Posts for Government Contractors</title>
    <meta name="description" content="Generate personalized LinkedIn content that resonates with government buyers. AI-powered posts tailored to your company and target agencies.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Canvas Confetti for celebration effect -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Swiper.js for carousel preview -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <!-- Export: .docx generation, zip bundling, file download -->
    <script src="https://cdn.jsdelivr.net/npm/docx@9.0.2/build/index.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Market Assassin brand colors
                        ma: {
                            bg: '#0f172a',        // deep navy background
                            bgDark: '#020617',   // near-black
                            card: '#1e293b',     // slate cards
                            border: '#334155',   // subtle borders
                            accent: '#3b82f6',   // blue buttons
                            cyan: '#22d3ee',     // cyan highlights
                            text: '#f1f5f9',     // light text
                            textSec: '#94a3b8',  // secondary text
                        },
                        govcon: {
                            blue: '#3b82f6',     // updated to match MA accent
                            gold: '#c5a028',
                            light: '#f1f5f9'
                        },
                        linkedin: {
                            blue: '#0077B5',
                            dark: '#004182',
                        }
                    }
                }
            }
        }
    </script>
    <script>
        // API Configuration - uses same-origin API routes
        const API_BASE = '';
        const AppConfig = {
            // Get absolute API URL
            getApiUrl(endpoint) {
                // Remove leading slash if present
                const path = endpoint.startsWith('/') ? endpoint.slice(1) : endpoint;
                return `${API_BASE}/${path}`;
            },
            // For debugging - log current context
            logContext() {
                console.log('[Config] API Base:', API_BASE);
                console.log('[Config] Current origin:', window.location.origin);
            }
        };

        // Robust fetch wrapper with proper error handling
        async function apiFetch(endpoint, options = {}) {
            const url = AppConfig.getApiUrl(endpoint);
            console.log('[API] Calling:', url);

            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            // Check for HTTP errors
            if (!response.ok) {
                const text = await response.text();
                console.error('[API] Error:', response.status, text.substring(0, 200));

                // Detect HTML response (proxy/404 error)
                if (text.startsWith('<!DOCTYPE') || text.startsWith('<html')) {
                    throw new Error(`API route not found (${response.status}). Check proxy configuration.`);
                }
                throw new Error(`Server error ${response.status}: ${text.substring(0, 100)}...`);
            }

            // Validate JSON response
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('[API] Unexpected content-type:', contentType, text.substring(0, 100));
                throw new Error(`Expected JSON, got ${contentType || 'unknown'}: ${text.substring(0, 100)}...`);
            }

            return response.json();
        }

        // Log on load for debugging
        if (window.location.search.includes('debug')) {
            AppConfig.logContext();
        }
    </script>
    <style>
        /* Market Assassin brand gradient */
        .gradient-bg {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        /* Dark theme base */
        body {
            background-color: #0f172a;
            color: #f1f5f9;
        }
        /* Dark theme overrides for Tailwind utility classes */
        .bg-white { background-color: #1e293b !important; }
        .bg-gray-50 { background-color: #0f172a !important; }
        .bg-gray-100 { background-color: #1e293b !important; }
        .bg-gray-200 { background-color: #334155 !important; }
        .text-gray-900 { color: #f1f5f9 !important; }
        .text-gray-800 { color: #f1f5f9 !important; }
        .text-gray-700 { color: #e2e8f0 !important; }
        .text-gray-600 { color: #cbd5e1 !important; }
        .text-gray-500 { color: #94a3b8 !important; }
        .border-gray-200 { border-color: #334155 !important; }
        .border-gray-300 { border-color: #475569 !important; }
        /* Form inputs dark theme */
        input, select, textarea {
            background-color: #0f172a !important;
            border-color: #334155 !important;
            color: #f1f5f9 !important;
        }
        input::placeholder, textarea::placeholder {
            color: #64748b !important;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
        }
        /* Card hover states */
        .hover\:bg-gray-50:hover { background-color: #334155 !important; }
        /* Footer */
        footer { background-color: #1e293b !important; }
        /* Labels */
        label { color: #e2e8f0 !important; }
        /* Accent colors */
        .bg-govcon-blue { background-color: #3b82f6 !important; }
        .text-govcon-blue { color: #3b82f6 !important; }
        .border-govcon-blue { border-color: #3b82f6 !important; }
        /* Success/green states - use cyan */
        .bg-green-100 { background-color: rgba(34, 211, 238, 0.1) !important; }
        .text-green-700 { color: #22d3ee !important; }
        /* Profile sections */
        .bg-govcon-light { background-color: #0f172a !important; }
        /* Loading animation styles */
        #tip-text {
            transition: opacity 0.2s ease-in-out;
        }
        .loading-dots {
            animation: dots 1.4s infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        .loading-dots::after {
            content: '';
            animation: dotContent 1.4s infinite;
        }
        @keyframes dotContent {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: ''; }
        }
        /* Enhanced Card Hover Effects */
        .post-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .post-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.25);
        }
        /* Mobile Responsive Enhancements */
        @media (max-width: 768px) {
            .container { padding-left: 1rem; padding-right: 1rem; }
            #tier-badge-container { display: none; }
            .nav-link { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
            .post-card .flex.gap-2.flex-wrap { flex-direction: column; }
            .post-card .flex.gap-2.flex-wrap button { width: 100%; }
            #quick-generate-section .grid { grid-template-columns: 1fr; }
            header h1 { font-size: 1.5rem; }
            header p { font-size: 0.875rem; }
        }
        /* Mobile Hamburger Menu */
        @media (max-width: 640px) {
            .md\\:flex.items-center.gap-3 { flex-wrap: wrap; gap: 0.5rem; }
        }
    </style>
    <!-- Supabase Auth - Inlined to avoid static file issues -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Auth Configuration - GovCon Content Generator project
        const SUPABASE_URL = 'https://krpyelfrbicmvsmwovti.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtycHllbGZyYmljbXZzbXdvdnRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNzU1MDAsImV4cCI6MjA4MzY1MTUwMH0.xI3qosl35ieKa5ObeExh0BiSwDdoZy74lZQWg1Fzn6M';

        // Base path is always /content-generator/ since files are in that folder
        function getBasePath() {
            return '/content-generator/';
        }

        // Get full URL for app pages
        function getAppUrl(page) {
            if (page === 'auth.html') return getBasePath() + 'auth.html';
            return getBasePath() + page;
        }

        if (typeof window.supabase === 'undefined') {
            console.error('Supabase SDK not loaded');
            window.SupabaseAuth = {
                initAuth: async () => null,
                loadUserProfile: async () => null,
                saveUserProfile: async () => null,
                requireAuth: () => false,
                getUserTier: () => 'content-engine',
                hasTierAccess: () => false,
                signOut: async () => { window.location.href = getAppUrl('auth.html'); },
                getAuthHeaders: () => ({}),
                get user() { return null; },
                get session() { return null; },
                get profile() { return null; }
            };
        } else {
            const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    persistSession: true,
                    storageKey: 'gcg-auth',
                    storage: window.localStorage,
                    autoRefreshToken: true,
                    detectSessionInUrl: true
                }
            });
            let currentUser = null;
            let currentSession = null;
            let userProfile = null;

            async function initAuth() {
                try {
                    const { data: { session }, error } = await supabaseClient.auth.getSession();
                    if (error) { console.error('Auth error:', error); return null; }
                    if (session) {
                        currentSession = session;
                        currentUser = session.user;
                        await loadUserProfile();
                        return session;
                    }
                    return null;
                } catch (error) { console.error('Init auth error:', error); return null; }
            }

            async function loadUserProfile() {
                if (!currentUser) return null;
                console.log('[Profile] Loading profile for user:', currentUser.id);
                try {
                    // Use cached session instead of calling getSession() which can hang
                    const session = currentSession;
                    if (!session || !session.access_token) {
                        console.error('[Profile] No valid session in cache');
                        return null;
                    }

                    // Use direct fetch with explicit Authorization header
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/user_profiles?user_id=eq.${currentUser.id}&select=*`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${session.access_token}`
                        }
                    });

                    console.log('[Profile] Load response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('[Profile] Load failed:', response.status, errorText);
                        return null;
                    }

                    const data = await response.json();
                    console.log('[Profile] Loaded data:', data?.length > 0 ? 'found profile' : 'no profile');

                    // data is an array, get first item
                    userProfile = data && data.length > 0 ? data[0] : null;
                    return userProfile;
                } catch (error) {
                    console.error('[Profile] Load error:', error);
                    return null;
                }
            }

            async function saveUserProfile(profileData) {
                if (!currentUser) return null;
                console.log('[Profile] Saving profile for user:', currentUser.id);
                try {
                    // Validate UUID before write
                    const userId = validateUserId(currentUser.id);

                    // Use cached session instead of calling getSession() which can hang
                    const session = currentSession;
                    if (!session || !session.access_token) {
                        console.error('[Profile] No valid session in cache');
                        return null;
                    }

                    const headers = {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${session.access_token}`,
                        'Prefer': 'return=representation'
                    };

                    const dataToSave = {
                        ...profileData,
                        updated_at: new Date().toISOString()
                    };

                    // First, check if profile exists
                    const checkResponse = await fetch(`${SUPABASE_URL}/rest/v1/user_profiles?user_id=eq.${userId}&select=id`, {
                        method: 'GET',
                        headers: headers
                    });
                    const existingProfiles = await checkResponse.json();
                    const profileExists = existingProfiles && existingProfiles.length > 0;

                    let response;
                    if (profileExists) {
                        // UPDATE existing profile using PATCH
                        console.log('[Profile] Updating existing profile...');
                        response = await fetch(`${SUPABASE_URL}/rest/v1/user_profiles?user_id=eq.${userId}`, {
                            method: 'PATCH',
                            headers: headers,
                            body: JSON.stringify(dataToSave)
                        });
                    } else {
                        // INSERT new profile
                        console.log('[Profile] Creating new profile...');
                        response = await fetch(`${SUPABASE_URL}/rest/v1/user_profiles`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({ user_id: userId, ...dataToSave })
                        });
                    }

                    console.log('[Profile] Save response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('[Profile] Save failed:', response.status, errorText);
                        return null;
                    }

                    const data = await response.json();
                    console.log('[Profile] Saved successfully:', data?.[0]?.company_name || 'OK');

                    // data is an array, get first item
                    userProfile = data && data.length > 0 ? data[0] : { user_id: userId, ...dataToSave };
                    return userProfile;
                } catch (error) {
                    console.error('[Profile] Save error:', error);
                    return null;
                }
            }

            function requireAuth(redirectTo = '/auth') {
                if (!currentSession) { window.location.href = redirectTo; return false; }
                return true;
            }

            function getUserTier() { return userProfile?.tier || 'content-engine'; }

            function hasTierAccess(requiredTier) {
                const tierLevels = { 'content-engine': 1, 'full-fix': 2 };
                return (tierLevels[getUserTier()] || 0) >= (tierLevels[requiredTier] || 0);
            }

            async function signOut() {
                try {
                    await supabaseClient.auth.signOut();
                    currentUser = null; currentSession = null; userProfile = null;
                    window.location.href = getAppUrl('auth.html');
                } catch (error) { console.error('Sign out error:', error); }
            }

            function getAuthHeaders() {
                if (!currentSession) return {};
                return { 'Authorization': `Bearer ${currentSession.access_token}`, 'Content-Type': 'application/json' };
            }

            // UUID validation guard - ensures we never accidentally use email as user_id
            function validateUserId(userId) {
                if (!userId) {
                    console.error('[Auth Guard] No user ID provided');
                    throw new Error('No authenticated user');
                }
                // UUID format: 8-4-4-4-12 hex characters (e.g., 550e8400-e29b-41d4-a716-446655440000)
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (typeof userId !== 'string' || !uuidRegex.test(userId)) {
                    console.error('[Auth Guard] Invalid UUID format:', userId);
                    throw new Error('Invalid user ID format - expected UUID');
                }
                return userId;
            }

            // Get validated user ID for write operations
            function getValidatedUserId() {
                if (!currentUser?.id) {
                    throw new Error('No authenticated user');
                }
                return validateUserId(currentUser.id);
            }

            // Safe write wrappers - bulletproof user_id injection (v3 - direct REST with cached session)
            async function safeInsert(table, data) {
                const userId = getValidatedUserId();
                console.log(`[SafeWrite v3] INSERT into ${table} for user ${userId}`, data);
                try {
                    // Use cached session instead of calling getSession() which can hang
                    const session = currentSession;
                    if (!session || !session.access_token) {
                        console.error('[SafeWrite v3] No valid session in cache');
                        return { data: null, error: new Error('Not authenticated - please refresh and try again') };
                    }
                    console.log(`[SafeWrite v3] Using cached session, making direct REST call...`);

                    // Use direct fetch with explicit Authorization header
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${session.access_token}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ ...data, user_id: userId })
                    });

                    console.log(`[SafeWrite v3] Response status: ${response.status}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`[SafeWrite v3] INSERT failed: ${response.status}`, errorText);
                        return { data: null, error: new Error(`Insert failed: ${response.status} ${errorText}`) };
                    }

                    console.log(`[SafeWrite v3] INSERT success!`);
                    return { data: { success: true }, error: null };
                } catch (err) {
                    console.error(`[SafeWrite v3] INSERT exception:`, err);
                    return { data: null, error: err };
                }
            }

            async function safeUpdate(table, id, updates) {
                const userId = getValidatedUserId();
                console.log(`[SafeWrite] UPDATE ${table} id=${id} for user ${userId}`);
                return supabaseClient.from(table).update({ ...updates, updated_at: new Date().toISOString() }).eq('id', id).eq('user_id', userId);
            }

            async function safeDelete(table, id) {
                const userId = getValidatedUserId();
                console.log(`[SafeWrite] DELETE from ${table} id=${id} for user ${userId}`);
                return supabaseClient.from(table).delete().eq('id', id).eq('user_id', userId);
            }

            async function safeUpsert(table, data, options = {}) {
                const userId = getValidatedUserId();
                console.log(`[SafeWrite] UPSERT into ${table} for user ${userId}`);
                return supabaseClient.from(table).upsert({ ...data, user_id: userId, updated_at: new Date().toISOString() }, options);
            }

            function safeSelect(table, columns = '*') {
                const userId = getValidatedUserId();
                return supabaseClient.from(table).select(columns).eq('user_id', userId);
            }

            // Listen for auth state changes - Global init script
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state:', event, session?.user?.id);
                if (session) {
                    // Update session for any event that provides a session (SIGNED_IN, TOKEN_REFRESHED, etc.)
                    currentSession = session;
                    currentUser = session.user;
                    // Store userId globally for quick access
                    window.currentUserId = session.user.id;
                    if (event === 'SIGNED_IN') {
                        await loadUserProfile();
                    }
                } else if (event === 'SIGNED_OUT') {
                    // Only redirect on explicit sign out, not on initial page load
                    currentUser = null; currentSession = null; userProfile = null;
                    window.currentUserId = null;
                    window.location.href = getAppUrl('auth.html');
                } else if (!session) {
                    // No session on initial load - just update state, don't redirect
                    currentUser = null; currentSession = null; userProfile = null;
                    window.currentUserId = null;
                }
            });

            window.SupabaseAuth = {
                client: supabaseClient, initAuth, loadUserProfile, saveUserProfile,
                requireAuth, getUserTier, hasTierAccess, signOut, getAuthHeaders,
                validateUserId, getValidatedUserId,
                safeInsert, safeUpdate, safeDelete, safeUpsert, safeSelect,
                get user() { return currentUser; },
                get session() { return currentSession; },
                get profile() { return userProfile; }
            };
            console.log('SupabaseAuth initialized');
        }
    </script>
</head>
<body class="bg-ma-bg min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4 max-w-6xl">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">GovCon Content Generator</h1>
                    <p class="text-blue-200 mt-1">AI-Powered LinkedIn Posts for Government Contractors</p>
                </div>
                <div class="hidden md:flex items-center gap-3">
                    <!-- Tier Badge - Prominent Display -->
                    <div id="tier-badge-container" class="flex items-center gap-2 px-4 py-2 rounded-xl border-2 cursor-pointer hover:opacity-90 transition" onclick="window.open('https://buy.stripe.com/9B6cN62sm2IO7lb4SIfnO0o', '_blank')">
                        <div id="tier-icon" class="w-8 h-8 rounded-full flex items-center justify-center">
                            <!-- Icon set by JS -->
                        </div>
                        <div class="text-left">
                            <p id="tier-badge" class="font-bold text-sm leading-tight"></p>
                            <p id="tier-subtitle" class="text-xs opacity-80"></p>
                        </div>
                    </div>

                    <div class="h-8 w-px bg-white/30"></div>

                    <!-- Nav Links -->
                    <a href="/content-generator/library.html" class="bg-white/20 hover:bg-white/30 text-white font-semibold px-3 py-1.5 rounded-lg transition flex items-center gap-1 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                        Library
                    </a>
                    <a href="/content-generator/calendar.html" class="bg-white/20 hover:bg-white/30 text-white font-semibold px-3 py-1.5 rounded-lg transition flex items-center gap-1 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Calendar
                    </a>

                    <div class="h-8 w-px bg-white/30"></div>

                    <!-- User Info -->
                    <div class="flex items-center gap-2">
                        <span id="user-email" class="text-sm text-blue-200"></span>
                        <button onclick="logout()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full transition">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Welcome Greeting (shown when profile exists) -->
        <div id="welcome-greeting" class="hidden mb-6">
            <div class="bg-gradient-to-r from-govcon-blue to-linkedin-blue rounded-2xl p-6 text-white">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">Welcome back, <span id="greeting-company-name">Your Company</span>!</h2>
                        <p class="text-blue-200 mt-1">Ready to create today's LinkedIn content?</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <a href="/content-generator/calendar.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            View Calendar
                        </a>
                        <span id="scheduled-count" class="bg-green-500/20 text-green-100 px-3 py-1 rounded-full text-sm font-medium">0 posts scheduled</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Generation Section (Main Daily Action) -->
        <div id="quick-generate-section" class="hidden bg-ma-card rounded-2xl shadow-xl p-6 mb-6 border border-ma-border">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-ma-text">Generate Today's Posts</h3>
                    <p class="text-sm text-ma-textSec">Create LinkedIn content in seconds</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs bg-ma-cyan/20 text-ma-cyan px-2 py-1 rounded-full">Using your saved profile</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <!-- Number of Posts -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Posts to Generate</label>
                    <select id="quick-num-posts" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue">
                        <option value="1">1 Post</option>
                        <option value="3" selected>3 Posts</option>
                        <option value="5">5 Posts</option>
                        <option value="10">10 Posts</option>
                        <option value="15">15 Posts</option>
                        <option value="30">30 Posts</option>
                    </select>
                </div>

                <!-- Content Style -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Content Style</label>
                    <select id="quick-content-style" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue">
                        <option value="mixed">Mixed (Recommended)</option>
                        <option value="story-driven">Story-Driven</option>
                        <option value="thought-leadership">Thought Leadership</option>
                        <option value="qa-format">Q&A Format</option>
                        <option value="listicle">Listicle/Tips</option>
                        <option value="industry-news">Industry News</option>
                    </select>
                </div>

                <!-- GEO Boost Toggle -->
                <div class="flex items-center">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="quick-geo-boost" checked class="w-5 h-5 text-purple-600 rounded">
                        <span class="text-sm font-medium text-gray-700">GEO Boost</span>
                    </label>
                </div>

                <!-- GovCon Model Toggle -->
                <div class="flex items-center">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="quick-fine-tuned" checked class="w-5 h-5 text-green-600 rounded">
                        <span class="text-sm font-medium text-gray-700">GovCon AI</span>
                    </label>
                </div>
            </div>

            <!-- Target Agencies Section -->
            <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-govcon-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                        <span class="font-medium text-gray-700">Target Agencies</span>
                    </div>
                    <button onclick="findAgenciesQuick()" class="text-sm bg-govcon-blue hover:bg-govcon-blue/90 text-white px-3 py-1.5 rounded-lg transition flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                        Refresh
                    </button>
                </div>
                <p class="text-xs text-gray-500 mb-3">Top spending agencies for your NAICS codes (click to remove)</p>
                <div id="quick-agencies-list" class="flex flex-wrap gap-2">
                    <span class="text-sm text-gray-500 italic">Loading agencies...</span>
                </div>
            </div>

            <!-- Usage Display -->
            <div id="usage-display" class="mb-4 p-3 bg-gray-50 rounded-lg">
                <!-- Populated by updateUsageDisplay() -->
            </div>

            <!-- Generate Button - Premium Gold Style -->
            <button onclick="quickGenerate()" id="quick-generate-btn" class="w-full bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 hover:from-amber-400 hover:via-yellow-400 hover:to-amber-400 text-gray-900 font-bold px-6 py-4 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl hover:shadow-amber-500/30 hover:scale-[1.02] flex items-center justify-center gap-3 text-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Generate <span id="quick-post-count">3</span> Posts
                <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
            </button>

            <!-- Upgrade Banner (Content Engine only) -->
            <div id="upgrade-banner" class="hidden mt-4 p-4 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                        <div>
                            <p class="font-bold">Unlock Unlimited Posts + Graphics</p>
                            <p class="text-sm text-purple-200">Upgrade to Full Fix for $200 more</p>
                        </div>
                    </div>
                    <a href="https://buy.stripe.com/9B6cN62sm2IO7lb4SIfnO0o" target="_blank" class="bg-white text-purple-600 font-bold px-4 py-2 rounded-lg hover:bg-purple-50 transition text-sm">
                        Upgrade Now
                    </a>
                </div>
            </div>
        </div>

        <!-- Collapsible Profile Card (shown for returning users) -->
        <div id="profile-card" class="hidden bg-white rounded-2xl shadow-xl mb-6 overflow-hidden">
            <button onclick="toggleProfileCard()" class="w-full p-4 flex items-center justify-between hover:bg-gray-50 transition">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-govcon-blue rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    </div>
                    <div class="text-left">
                        <h3 id="card-company-name" class="font-bold text-govcon-blue">Your Company Profile</h3>
                        <p id="card-summary" class="text-sm text-gray-500">Click to expand and edit</p>
                    </div>
                </div>
                <svg id="profile-card-arrow" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            <div id="profile-card-content" class="hidden border-t border-gray-200 p-6">
                <!-- Profile form will be moved here -->
            </div>
        </div>

        <!-- Content Generator Form (for new users or full form mode) -->
        <div id="generator-form" class="bg-ma-card rounded-2xl shadow-xl p-8 mb-6 border border-ma-border">
            <div class="space-y-6">

                <!-- Profile Summary (shown when profile exists) - Legacy, kept for compatibility -->
                <div id="profile-summary" class="hidden bg-ma-bg border border-ma-border rounded-xl p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-govcon-blue rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                            </div>
                            <div>
                                <h3 id="summary-company-name" class="font-bold text-govcon-blue text-lg"></h3>
                                <p id="summary-details" class="text-sm text-gray-600"></p>
                            </div>
                        </div>
                        <button type="button" onclick="toggleProfileForm()" class="text-sm bg-white hover:bg-gray-50 text-govcon-blue font-medium px-4 py-2 rounded-lg border border-govcon-blue/30 transition flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Edit Profile
                        </button>
                    </div>
                </div>

                <!-- Company Profile Section (Full Form) -->
                <div id="profile-form" class="bg-govcon-light border-2 border-govcon-blue/20 rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-govcon-blue text-lg">Your Company Profile</h3>
                        <div class="flex items-center gap-2">
                            <button type="button" onclick="resetCompanyProfile()" class="text-xs bg-red-100 text-red-700 hover:bg-red-200 px-3 py-1.5 rounded-full transition flex items-center gap-1 font-medium">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                Reset
                            </button>
                            <span class="text-xs bg-govcon-gold/20 text-govcon-blue px-3 py-1 rounded-full font-medium">Required for personalization</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Your Name (for quote graphics) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                            <input type="text" id="display-name" placeholder="e.g., Eric Coffie"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                            <p class="text-xs text-gray-500 mt-1">Used on quote graphics (Photo Quote, Tweet, Highlighter, Classic)</p>
                        </div>

                        <!-- Company Name -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Company Name <span class="text-red-500">*</span></label>
                            <input type="text" id="company-name" placeholder="e.g., Apex Federal Solutions"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                        </div>

                        <!-- Your Role -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Your Role/Title</label>
                            <input type="text" id="user-role" placeholder="e.g., CEO, BD Director, Capture Manager"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                        </div>

                        <!-- Phone Number -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" id="phone-number" placeholder="e.g., (555) 123-4567"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                        </div>

                        <!-- Website -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                            <input type="url" id="website" placeholder="e.g., www.yourcompany.com"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                        </div>

                        <!-- NAICS Codes - KEY INPUT -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NAICS Code(s) <span class="text-red-500">*</span></label>
                            <input type="text" id="naics-codes" placeholder="e.g., 541512, 541511, 518210"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                            <p class="text-xs text-gray-500 mt-1">Separate multiple codes with commas. We'll find agencies that buy these services.</p>
                        </div>

                        <!-- Business Formation -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Business Type</label>
                            <select id="business-formation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                                <option value="">Any / Not specified</option>
                                <option value="small-business">Small Business</option>
                                <option value="8a">8(a) Certified</option>
                                <option value="hubzone">HUBZone</option>
                                <option value="women-owned">Women-Owned (WOSB/EDWOSB)</option>
                                <option value="sdvosb">Service-Disabled Veteran (SDVOSB)</option>
                                <option value="vosb">Veteran-Owned (VOSB)</option>
                            </select>
                        </div>

                        <!-- Core Services -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Core Services/Capabilities <span class="text-red-500">*</span></label>
                            <textarea id="core-services" rows="2" placeholder="e.g., IT modernization, cybersecurity, cloud migration, AI/ML solutions, software development"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue"></textarea>
                        </div>

                        <!-- Differentiators -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">What Makes You Different?</label>
                            <textarea id="differentiators" rows="2" placeholder="e.g., 15 years DoD experience, cleared staff, agile methodology, mission-focused approach"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue"></textarea>
                        </div>

                        <!-- Certifications -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Certifications</label>
                            <input type="text" id="certifications" placeholder="e.g., ISO 27001, CMMI Level 3, FedRAMP"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                        </div>

                        <!-- Contract Vehicles -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Vehicles</label>
                            <input type="text" id="contract-vehicles" placeholder="e.g., GSA MAS, SEWP V, CIO-SP3, OASIS"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                        </div>

                        <!-- Past Performance -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Notable Past Performance (optional)</label>
                            <textarea id="past-performance" rows="2" placeholder="e.g., Supported Navy's IT modernization saving $2M annually, Delivered Army cybersecurity solution ahead of schedule"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue"></textarea>
                        </div>

                        <!-- Brand Colors Section (Full Fix Only) -->
                        <div id="brand-colors-section" class="md:col-span-2 hidden">
                            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-bold text-gray-900">Brand Colors (for Quote Graphics)</label>
                                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full font-medium">Full Fix</span>
                                </div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Primary Color</label>
                                        <div class="flex items-center gap-2">
                                            <input type="color" id="brand-primary-color" value="#1e3a5f"
                                                class="w-10 h-10 rounded cursor-pointer border border-gray-300">
                                            <input type="text" id="brand-primary-hex" value="#1e3a5f" maxlength="7"
                                                class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded font-mono"
                                                onchange="syncColorFromHex('primary')">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Accent Color</label>
                                        <div class="flex items-center gap-2">
                                            <input type="color" id="brand-accent-color" value="#c5a028"
                                                class="w-10 h-10 rounded cursor-pointer border border-gray-300">
                                            <input type="text" id="brand-accent-hex" value="#c5a028" maxlength="7"
                                                class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded font-mono"
                                                onchange="syncColorFromHex('accent')">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Background</label>
                                        <div class="flex items-center gap-2">
                                            <input type="color" id="brand-bg-color" value="#0d1f33"
                                                class="w-10 h-10 rounded cursor-pointer border border-gray-300">
                                            <input type="text" id="brand-bg-hex" value="#0d1f33" maxlength="7"
                                                class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded font-mono"
                                                onchange="syncColorFromHex('bg')">
                                        </div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600 mt-3">These colors will be applied to your AI quote graphics for perfect branding.</p>
                                <div class="mt-3 flex items-center gap-2">
                                    <input type="checkbox" id="use-brand-colors" class="w-4 h-4 text-purple-600">
                                    <label for="use-brand-colors" class="text-sm font-medium text-gray-800">Use my brand colors for graphics</label>
                                </div>

                                <!-- Profile Photo Upload -->
                                <div class="mt-4 pt-4 border-t border-purple-200">
                                    <label class="block text-sm font-bold text-gray-900 mb-2">Profile Photo</label>
                                    <div class="flex items-center gap-4">
                                        <label class="flex-1 cursor-pointer">
                                            <div id="profile-photo-upload-area" class="border-2 border-dashed border-purple-300 rounded-lg p-3 text-center hover:border-purple-500 hover:bg-purple-50/50 transition">
                                                <input type="file" id="profile-photo-upload" accept="image/*" class="hidden" onchange="handleProfilePhotoUpload(event)">
                                                <div class="flex items-center justify-center gap-2">
                                                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                                    </svg>
                                                    <span id="profile-photo-text" class="text-sm text-purple-600">Click to upload headshot</span>
                                                </div>
                                            </div>
                                        </label>
                                        <div id="profile-photo-preview" class="hidden w-16 h-16 rounded-full border-2 border-purple-200 overflow-hidden bg-white shadow-sm">
                                            <img id="profile-photo-preview-img" src="" class="w-full h-full object-cover">
                                        </div>
                                        <button id="remove-profile-photo-btn" onclick="removeProfilePhoto()" class="hidden p-2 text-red-500 hover:bg-red-50 rounded-lg transition" title="Remove photo">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">Small headshot for avatar circles on Tweet Quote and Social Card. <strong>200x200px minimum, square crop.</strong> Max 2MB.</p>
                                    <input type="hidden" id="profile-photo-data" value="">
                                </div>

                                <!-- Profile Tagline for Photo Quote -->
                                <div class="mt-4 pt-4 border-t border-purple-200">
                                    <label class="block text-sm font-bold text-gray-900 mb-1">Profile Tagline</label>
                                    <input type="text" id="profile-tagline" placeholder="e.g., Entrepreneur | Business Development Leader"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-govcon-blue focus:border-govcon-blue">
                                    <p class="text-xs text-gray-500 mt-1">Appears on Photo Quote graphics below your name.</p>
                                </div>

                                <!-- Background Photo Upload (for Photo Quote) -->
                                <div class="mt-4 pt-4 border-t border-purple-200">
                                    <label class="block text-sm font-bold text-gray-900 mb-2">Background Photo <span class="text-xs text-amber-600 font-normal">(Photo Quote)</span></label>
                                    <div class="flex items-center gap-4">
                                        <label class="flex-1 cursor-pointer">
                                            <div id="bg-photo-upload-area" class="border-2 border-dashed border-amber-300 rounded-lg p-3 text-center hover:border-amber-500 hover:bg-amber-50/50 transition">
                                                <input type="file" id="bg-photo-upload" accept="image/*" class="hidden" onchange="handleBgPhotoUpload(event)">
                                                <div class="flex items-center justify-center gap-2">
                                                    <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                    </svg>
                                                    <span id="bg-photo-text" class="text-sm text-amber-600">Click to upload hero photo</span>
                                                </div>
                                            </div>
                                        </label>
                                        <div id="bg-photo-preview" class="hidden w-16 h-20 rounded-lg border-2 border-amber-200 overflow-hidden bg-white shadow-sm">
                                            <img id="bg-photo-preview-img" src="" class="w-full h-full object-cover">
                                        </div>
                                        <button id="remove-bg-photo-btn" onclick="removeBgPhoto()" class="hidden p-2 text-red-500 hover:bg-red-50 rounded-lg transition" title="Remove photo">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">Large professional photo used as the full background on Photo Quote. <strong>1080x1350px recommended (4:5 portrait).</strong> Max 5MB.</p>
                                    <input type="hidden" id="bg-photo-data" value="">
                                </div>

                                <!-- Company Logo Upload -->
                                <div class="mt-4 pt-4 border-t border-purple-200">
                                    <label class="block text-sm font-bold text-gray-900 mb-2">Company Logo</label>
                                    <div class="flex items-center gap-4">
                                        <label class="flex-1 cursor-pointer">
                                            <div id="profile-logo-upload-area" class="border-2 border-dashed border-purple-300 rounded-lg p-3 text-center hover:border-purple-500 hover:bg-purple-50/50 transition">
                                                <input type="file" id="profile-logo-upload" accept="image/*" class="hidden" onchange="handleProfileLogoUpload(event)">
                                                <div class="flex items-center justify-center gap-2">
                                                    <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                    </svg>
                                                    <span id="profile-logo-text" class="text-sm text-purple-600">Click to upload logo</span>
                                                </div>
                                            </div>
                                        </label>
                                        <div id="profile-logo-preview" class="hidden w-16 h-16 rounded-lg border-2 border-purple-200 overflow-hidden bg-white shadow-sm">
                                            <img id="profile-logo-preview-img" src="" class="w-full h-full object-contain">
                                        </div>
                                        <button id="remove-profile-logo-btn" onclick="removeProfileLogo()" class="hidden p-2 text-red-500 hover:bg-red-50 rounded-lg transition" title="Remove logo">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">Logo will appear on carousel slides. <strong>240x120px minimum, PNG with transparency preferred.</strong> Max 2MB.</p>
                                    <input type="hidden" id="profile-logo-data" value="">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 flex items-center gap-2">
                        <input type="checkbox" id="save-profile" checked class="w-4 h-4 text-govcon-blue">
                        <label for="save-profile" class="text-sm text-gray-600">Remember my profile for next time</label>
                    </div>

                    <!-- Save Profile Button -->
                    <button type="button" onclick="saveProfileManually()" id="save-profile-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-3 rounded-lg transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        Save Profile
                    </button>
                </div>

                <!-- Target Agencies (Auto-populated from NAICS) -->
                <div id="agencies-section" class="hidden">
                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-green-800 text-lg">Target Agencies Found</h3>
                            <span id="agency-count-badge" class="text-xs bg-green-200 text-green-800 px-3 py-1 rounded-full font-medium">0 agencies</span>
                        </div>
                        <p class="text-sm text-green-700 mb-4">Based on your NAICS codes, these agencies spend the most in your industry:</p>
                        <div id="target-agencies-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Agencies will be populated here -->
                        </div>
                        <p class="text-xs text-green-600 mt-3">Data from USAspending.gov (last 3 fiscal years)</p>
                    </div>
                </div>

                <!-- Find Agencies Button -->
                <button type="button" onclick="findAgencies()" id="find-agencies-btn" class="w-full bg-govcon-blue hover:bg-govcon-blue/90 text-white font-bold px-6 py-3 rounded-lg transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    Find Target Agencies from NAICS
                </button>

                <input type="hidden" id="num-posts" value="10">

                <!-- Advanced Options -->
                <div class="border border-gray-200 rounded-lg">
                    <button type="button" onclick="toggleAdvancedOptions()" class="w-full flex items-center justify-between p-4 text-left hover:bg-gray-50 transition">
                        <span class="text-sm font-medium text-gray-600">Advanced Options (Content Styles)</span>
                        <svg id="advanced-arrow" class="w-4 h-4 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div id="advanced-options" class="hidden border-t border-gray-200 p-4 space-y-4">
                        <p class="text-xs text-gray-500">Customize which content styles to use (optional - we'll pick great defaults if you skip this)</p>
                        <div id="templates-container" class="grid grid-cols-2 md:grid-cols-3 gap-2"></div>
                    </div>
                </div>

                <!-- GEO Boost -->
                <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="geo-boost" checked class="mt-1 w-5 h-5 text-purple-600">
                        <div>
                            <label for="geo-boost" class="font-semibold text-gray-900 cursor-pointer">
                                GEO Boost (Generative Engine Optimization)
                            </label>
                            <p class="text-sm text-gray-600 mt-1">
                                Optimize content for AI search engines (ChatGPT, Perplexity) with clear Q&A structure.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- AI Model Selection -->
                <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6">
                    <div class="flex items-start gap-3">
                        <input type="checkbox" id="use-fine-tuned" checked class="mt-1 w-5 h-5 text-green-600">
                        <div>
                            <label for="use-fine-tuned" class="font-semibold text-gray-900 cursor-pointer">
                                Use GovCon-Tuned AI Model
                            </label>
                            <p class="text-sm text-gray-600 mt-1">
                                Custom model trained on 146 high-performing government contracting LinkedIn posts.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <button onclick="quickGenerate()" id="generate-btn" disabled class="w-full gradient-bg hover:opacity-90 text-white font-bold px-8 py-4 rounded-lg transition duration-200 text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    Generate LinkedIn Posts
                </button>
                <p id="generate-help" class="text-center text-sm text-gray-500 mt-2">Fill in your company info above to get started</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="text-center">
                <!-- Animated icon -->
                <div class="relative mx-auto mb-6 w-20 h-20">
                    <div class="absolute inset-0 rounded-full border-4 border-gray-200"></div>
                    <div id="progress-ring" class="absolute inset-0 rounded-full border-4 border-govcon-blue border-t-transparent animate-spin"></div>
                    <div class="absolute inset-2 bg-gradient-to-br from-govcon-blue to-blue-600 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-gray-900 mb-1" id="loading-title">Finding Target Agencies...</h3>
                <p class="text-sm text-gray-500 mb-4" id="loading-subtitle">This usually takes 10-20 seconds</p>

                <!-- Progress bar -->
                <div class="w-full max-w-xs mx-auto bg-gray-200 rounded-full h-2 mb-6">
                    <div id="progress-bar" class="bg-gradient-to-r from-govcon-blue to-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>

                <!-- Steps with enhanced messaging -->
                <div id="loading-steps" class="space-y-3 text-sm max-w-md mx-auto text-left">
                    <div id="step-1" class="flex items-center gap-3 text-gray-400 transition-all duration-300">
                        <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0">
                            <span class="step-number text-xs">1</span>
                        </div>
                        <span class="step-text">Analyzing target agency pain points...</span>
                    </div>
                    <div id="step-2" class="flex items-center gap-3 text-gray-400 transition-all duration-300">
                        <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0">
                            <span class="step-number text-xs">2</span>
                        </div>
                        <span class="step-text">Personalizing for <span id="step-company-name">your company</span>...</span>
                    </div>
                    <div id="step-3" class="flex items-center gap-3 text-gray-400 transition-all duration-300">
                        <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0">
                            <span class="step-number text-xs">3</span>
                        </div>
                        <span class="step-text">Writing in your authentic voice...</span>
                    </div>
                    <div id="step-4" class="flex items-center gap-3 text-gray-400 transition-all duration-300">
                        <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0">
                            <span class="step-number text-xs">4</span>
                        </div>
                        <span class="step-text">Adding GEO optimization & hashtags...</span>
                    </div>
                </div>

                <!-- Rotating tips -->
                <div id="loading-tip" class="mt-6 p-3 bg-blue-50 rounded-lg text-sm text-blue-700 max-w-sm mx-auto">
                    <span class="font-medium">Tip:</span> <span id="tip-text">Posts with specific agency names get 3x more engagement</span>
                </div>
            </div>
        </div>

        <!-- Generated Posts -->
        <div id="generated-posts" class="hidden space-y-6">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Your LinkedIn Posts</h2>
                <p class="text-gray-600">Click to copy and paste into LinkedIn</p>
            </div>

            <!-- Export buttons -->
            <div id="export-buttons" class="flex flex-wrap justify-center gap-3 mb-6">
                <button onclick="exportAllPostsToDocx()" class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    Export All as .docx
                </button>
                <button onclick="downloadAllVisuals()" class="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-semibold rounded-lg transition shadow-md">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    Download All Visuals (.zip)
                </button>
            </div>
            <div id="export-progress" class="hidden text-center mb-4">
                <div class="inline-flex items-center gap-2 px-4 py-2 bg-purple-50 border border-purple-200 rounded-lg text-purple-700 text-sm font-medium">
                    <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span id="export-progress-text">Generating visuals...</span>
                </div>
            </div>

            <div id="posts-container" class="space-y-6"></div>

            <div class="text-center pt-6">
                <button onclick="resetGenerator()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold px-8 py-3 rounded-lg transition">
                    Generate More Posts
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-govcon-blue text-white py-6 mt-12">
        <div class="container mx-auto px-4 max-w-6xl text-center">
            <p class="text-blue-200">GovCon Content Generator - AI-Powered LinkedIn Posts for Government Contractors</p>
        </div>
    </footer>

    <!-- Paywall Modal (No access) -->
    <div id="paywall-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
            <!-- Already Have Access Banner -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 text-center">
                <h3 class="text-xl font-bold text-white mb-2">Already have access?</h3>
                <p class="text-green-100 text-sm mb-4">Sign in with your purchase email to start generating content</p>
                <button onclick="goToSignIn()" class="inline-flex items-center gap-2 px-8 py-3 bg-white text-green-600 font-bold rounded-lg hover:bg-green-50 transition shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                    </svg>
                    Sign In Now
                </button>
            </div>

            <!-- Divider -->
            <div class="relative py-4 bg-gray-50">
                <div class="absolute inset-0 flex items-center px-8">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center">
                    <span class="px-4 bg-gray-50 text-sm text-gray-500 font-medium">Or get access now</span>
                </div>
            </div>

            <!-- Pricing Options -->
            <div class="p-8 pt-4">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <!-- Content Engine Tier -->
                    <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-govcon-blue transition">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Content Engine</h3>
                        <div class="text-3xl font-bold text-govcon-blue mb-4">$197 <span class="text-sm font-normal text-gray-500">one-time</span></div>
                        <ul class="space-y-2 text-sm text-gray-600 mb-6">
                            <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> 100 posts/day generation</li>
                            <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Real-time agency spending data</li>
                            <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> 15 content templates</li>
                            <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Company personalization</li>
                        </ul>
                        <a href="https://buy.stripe.com/dRmcN64Au6Z4axn84UfnO0m" target="_blank" class="block w-full text-center px-6 py-3 border-2 border-govcon-blue text-govcon-blue font-semibold rounded-lg hover:bg-govcon-light transition">
                            Get Content Engine
                        </a>
                    </div>

                    <!-- Full Fix Tier -->
                    <div class="border-2 border-govcon-blue rounded-xl p-6 bg-govcon-light/30 relative">
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-govcon-gold text-white text-xs font-bold px-3 py-1 rounded-full">BEST VALUE</div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Full Fix</h3>
                        <div class="text-3xl font-bold text-govcon-blue mb-4">$397 <span class="text-sm font-normal text-gray-500">one-time</span></div>
                        <ul class="space-y-2 text-sm text-gray-600 mb-6">
                            <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> <strong>Unlimited</strong> post generation</li>
                            <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> AI graphics generation</li>
                            <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Post scheduling & calendar</li>
                            <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Priority support</li>
                        </ul>
                        <a href="https://buy.stripe.com/aFa9AU4Au1EKaxn5WMfnO0n" target="_blank" class="block w-full text-center px-6 py-3 gradient-bg text-white font-semibold rounded-lg hover:opacity-90 transition">
                            Get Full Fix
                        </a>
                    </div>
                </div>

                <div class="text-center text-sm text-gray-500">
                    <button onclick="recheckAccess()" class="text-govcon-blue hover:underline">Re-check my access</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal (First-time setup) -->
    <div id="welcome-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden">
            <!-- Header with gradient -->
            <div class="gradient-bg p-6 text-center">
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white">Welcome to GovCon Content Generator!</h2>
                <p class="text-blue-200 mt-2">Your profile is all set up</p>
            </div>

            <!-- Content -->
            <div class="p-6">
                <p class="text-gray-700 text-center mb-6">
                    Would you like us to generate <strong>10 LinkedIn posts</strong> right now?
                    We'll create personalized posts tailored to your company and target agencies.
                </p>

                <div class="bg-govcon-light rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-govcon-blue mb-2">What you'll get:</h4>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            10 unique LinkedIn posts
                        </li>
                        <li class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            Saved to your content library
                        </li>
                        <li class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            Targeted to your agencies & NAICS codes
                        </li>
                        <li class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            Edit, regenerate, or export anytime
                        </li>
                    </ul>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeWelcomeModal()" class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold rounded-lg transition">
                        I'll Do It Myself
                    </button>
                    <button onclick="skipWelcomeAndGenerate()" class="flex-1 px-6 py-3 gradient-bg hover:opacity-90 text-white font-semibold rounded-lg transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Yes, Generate 10 Posts!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generation Progress Modal -->
    <div id="generation-progress-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-govcon-blue mx-auto mb-6"></div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Generating Your Posts</h3>
                <p class="text-gray-600 mb-4" id="generation-progress-text">Creating LinkedIn content...</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="generation-progress-bar" class="bg-govcon-blue h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-500 mt-4" id="generation-count">Generating posts...</p>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full mx-4 p-6">
            <div class="text-center">
                <div class="mx-auto w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-900 mb-2">Reset Profile?</h3>
                <p class="text-gray-600 text-sm mb-6">This will clear all your company information. You'll need to enter it again.</p>
                <div class="flex gap-3">
                    <button onclick="closeResetModal()" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-lg transition">
                        Cancel
                    </button>
                    <button onclick="confirmResetProfile()" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition">
                        Yes, Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let availableTemplates = [];
        let foundAgencies = [];
        let generatedPosts = [];
        let userTier = null; // 'content-engine' or 'full-fix'
        let hasGraphicsAccess = false;
        let loadingTipInterval = null;
        let progressInterval = null;

        // Loading tips that rotate during content generation
        const loadingTips = [
            "Posts with specific agency names get 3x more engagement",
            "LinkedIn posts perform best between 7-8am on weekdays",
            "Using numbers in your hook increases click-through by 36%",
            "Questions in your opening line boost comments by 50%",
            "Personal stories get 2x more shares than pure advice",
            "Tagging relevant decision-makers increases visibility",
            "Posts under 1,300 characters get 25% more engagement",
            "Adding a clear CTA doubles your response rate"
        ];

        // Enhanced loading animation helpers
        function startLoadingAnimation(steps, title, subtitle) {
            // Clear any existing intervals
            stopLoadingAnimation();

            // Set title and subtitle
            document.getElementById('loading-title').textContent = title;
            document.getElementById('loading-subtitle').textContent = subtitle || 'This usually takes 10-20 seconds';

            // Reset progress bar
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = '0%';

            // Reset all steps
            steps.forEach((stepText, index) => {
                const step = document.getElementById(`step-${index + 1}`);
                if (step) {
                    step.className = 'flex items-center gap-3 text-gray-400 transition-all duration-300';
                    step.innerHTML = `
                        <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0">
                            <span class="step-number text-xs">${index + 1}</span>
                        </div>
                        <span class="step-text">${stepText}</span>
                    `;
                }
            });

            // Start rotating tips
            let tipIndex = Math.floor(Math.random() * loadingTips.length);
            const tipText = document.getElementById('tip-text');
            if (tipText) {
                tipText.textContent = loadingTips[tipIndex];
                loadingTipInterval = setInterval(() => {
                    tipIndex = (tipIndex + 1) % loadingTips.length;
                    tipText.style.opacity = '0';
                    setTimeout(() => {
                        tipText.textContent = loadingTips[tipIndex];
                        tipText.style.opacity = '1';
                    }, 200);
                }, 4000);
            }

            // Animate progress bar smoothly
            let progress = 0;
            progressInterval = setInterval(() => {
                // Slow down as we approach 90%
                const increment = progress < 30 ? 2 : progress < 60 ? 1 : progress < 85 ? 0.5 : 0.1;
                progress = Math.min(progress + increment, 90);
                progressBar.style.width = progress + '%';
            }, 200);
        }

        function completeLoadingStep(stepNum, text) {
            const step = document.getElementById(`step-${stepNum}`);
            if (step) {
                step.className = 'flex items-center gap-3 text-green-600 transition-all duration-300';
                step.innerHTML = `
                    <div class="step-icon w-6 h-6 rounded-full bg-green-500 flex items-center justify-center flex-shrink-0">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <span class="step-text font-medium">${text}</span>
                `;
            }
        }

        function activateLoadingStep(stepNum, text) {
            const step = document.getElementById(`step-${stepNum}`);
            if (step) {
                step.className = 'flex items-center gap-3 text-govcon-blue transition-all duration-300';
                step.innerHTML = `
                    <div class="step-icon w-6 h-6 rounded-full border-2 border-govcon-blue flex items-center justify-center flex-shrink-0 animate-pulse">
                        <div class="w-2 h-2 bg-govcon-blue rounded-full"></div>
                    </div>
                    <span class="step-text font-medium">${text}</span>
                    <span class="loading-dots text-govcon-blue">...</span>
                `;
            }
        }

        function completeLoadingAnimation() {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = '100%';
            }
            stopLoadingAnimation();
        }

        function stopLoadingAnimation() {
            if (loadingTipInterval) {
                clearInterval(loadingTipInterval);
                loadingTipInterval = null;
            }
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        // Initialize on page load with Supabase Auth
        window.addEventListener('DOMContentLoaded', async function() {
            // Check if SupabaseAuth is available (should be since it's inlined)
            if (typeof SupabaseAuth === 'undefined') {
                console.error('SupabaseAuth not available - Supabase SDK may have failed to load');
                alert('Authentication service failed to load. Please refresh the page.');
                return;
            }

            // Check if we just came from auth (might need to wait for session)
            const urlParams = new URLSearchParams(window.location.search);
            const justSignedIn = urlParams.get('auth') === 'success' || sessionStorage.getItem('gcg_just_signed_in');

            // Initialize Supabase Auth with retry for fresh logins
            let session = await SupabaseAuth.initAuth();

            // If no session but we just signed in, retry a few times
            if (!session && justSignedIn) {
                console.log('Just signed in, waiting for session...');
                for (let i = 0; i < 5; i++) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    session = await SupabaseAuth.initAuth();
                    if (session) {
                        console.log('Session established after retry');
                        break;
                    }
                }
                // Clear the flag
                sessionStorage.removeItem('gcg_just_signed_in');
                // Clean up URL
                if (urlParams.get('auth')) {
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }

            // All users now authenticate via Supabase magic links
            // No more localStorage workarounds needed
            if (!session) {
                // Not logged in - show paywall first (don't redirect to auth)
                console.log('[App] No session - showing paywall for new visitors');
                showPaywall();
                return;
            }

            // Initialize tier from profile (includes paywall check)
            await initializeTier();

            // If no access, don't continue loading
            if (!hasContentGeneratorAccess) {
                console.log('[App] No access - stopping initialization');
                return;
            }

            // Update UI with user info
            updateUserUI();

            // Load data
            await loadCompanyProfile();
            await loadTemplates();
        });

        // ========== PAYWALL / ACCESS VERIFICATION ==========
        let hasContentGeneratorAccess = false;

        // Verify access via market-assassin API
        async function verifyContentGeneratorAccess() {
            const user = SupabaseAuth.user;
            if (!user?.email) {
                console.log('[Access] No user email, showing paywall');
                showPaywall();
                return false;
            }

            try {
                console.log('[Access] Checking access for:', user.email);
                const response = await fetch('https://tools.govcongiants.org/api/verify-content-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: user.email })
                });

                const result = await response.json();
                console.log('[Access] Verification result:', result);

                if (result.hasAccess) {
                    hasContentGeneratorAccess = true;
                    // Store the tier from the access check
                    if (result.tier) {
                        localStorage.setItem('gcg_tier', result.tier);
                    }
                    hidePaywall();
                    return result.tier || 'content-engine';
                } else {
                    hasContentGeneratorAccess = false;
                    showPaywall();
                    return false;
                }
            } catch (error) {
                console.error('[Access] Error verifying access:', error);
                // On error, check localStorage for cached access
                const cachedTier = localStorage.getItem('gcg_tier');
                if (cachedTier) {
                    console.log('[Access] Using cached tier:', cachedTier);
                    hasContentGeneratorAccess = true;
                    hidePaywall();
                    return cachedTier;
                }
                showPaywall();
                return false;
            }
        }

        function showPaywall() {
            const modal = document.getElementById('paywall-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            // Hide main content
            document.querySelector('main')?.classList.add('blur-sm', 'pointer-events-none');
        }

        function hidePaywall() {
            const modal = document.getElementById('paywall-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            // Show main content
            document.querySelector('main')?.classList.remove('blur-sm', 'pointer-events-none');
        }

        async function recheckAccess() {
            showInfoToast('Checking access...');
            const tier = await verifyContentGeneratorAccess();
            if (tier) {
                showSuccessToast('Access verified! Refreshing...');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showErrorToast('No access found. Please purchase to continue.');
            }
        }

        function goToSignIn() {
            window.location.href = getAppUrl('auth.html');
        }
        // ========== END PAYWALL ==========

        // Initialize tier from access verification or Supabase profile
        async function initializeTier() {
            // First check access via market-assassin API
            const verifiedTier = await verifyContentGeneratorAccess();

            if (!verifiedTier) {
                // No access - paywall is already shown
                return;
            }

            const profile = SupabaseAuth.profile;
            // Use verified tier from API, fall back to profile/localStorage
            const tier = verifiedTier || profile?.tier || localStorage.getItem('gcg_tier') || 'content-engine';

            // Map tiers (only Content Engine or Full Fix - no free tier)
            if (tier === 'full-fix') {
                userTier = 'full-fix';
                hasGraphicsAccess = true;
            } else {
                // Default to Content Engine
                userTier = 'content-engine';
                hasGraphicsAccess = false;
            }

            console.log(`[Tier] Initialized: ${userTier}, Graphics: ${hasGraphicsAccess}`);

            // Initialize usage tracking
            initializeUsageTracking();

            // Update tier badge - Prominent Header Display
            const tierBadge = document.getElementById('tier-badge');
            const tierContainer = document.getElementById('tier-badge-container');
            const tierIcon = document.getElementById('tier-icon');
            const tierSubtitle = document.getElementById('tier-subtitle');

            if (tierBadge && tierContainer && tierIcon && tierSubtitle) {
                if (userTier === 'full-fix') {
                    tierBadge.textContent = 'Full Fix';
                    tierSubtitle.textContent = 'Posts + Graphics';
                    tierContainer.className = 'flex items-center gap-2 px-4 py-2 rounded-xl border-2 cursor-pointer hover:opacity-90 transition bg-gradient-to-r from-purple-500/30 to-indigo-500/30 border-purple-400/50';
                    tierIcon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-purple-500';
                    tierIcon.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>';
                    tierContainer.onclick = null; // No need to upgrade
                    tierContainer.style.cursor = 'default';
                } else {
                    // Default to Content Engine (no free tier)
                    tierBadge.textContent = 'Content Engine';
                    tierSubtitle.innerHTML = '<span class="text-yellow-300">Text Only</span>  <span class="underline">Upgrade $200</span>';
                    tierContainer.className = 'flex items-center gap-2 px-4 py-2 rounded-xl border-2 cursor-pointer hover:scale-105 transition-all bg-gradient-to-r from-yellow-500/20 to-amber-500/20 border-yellow-400/50 hover:border-yellow-400 hover:shadow-lg hover:shadow-yellow-500/20';
                    tierIcon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-gradient-to-br from-yellow-400 to-amber-500';
                    tierIcon.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>';
                    tierContainer.onclick = () => window.open('https://buy.stripe.com/9B6cN62sm2IO7lb4SIfnO0o', '_blank');
                }
            }

            // Show/hide upgrade banner (show only for Content Engine users)
            const upgradeBanner = document.getElementById('upgrade-banner');
            if (upgradeBanner) {
                if (userTier !== 'full-fix') {
                    upgradeBanner.classList.remove('hidden');
                } else {
                    upgradeBanner.classList.add('hidden');
                }
            }

            // Show/hide brand colors section (Full Fix only)
            const brandColorsSection = document.getElementById('brand-colors-section');
            if (brandColorsSection) {
                if (userTier === 'full-fix') {
                    brandColorsSection.classList.remove('hidden');
                } else {
                    brandColorsSection.classList.add('hidden');
                }
            }

        }

        // ========== USAGE TRACKING & LIMITS (Supabase-based) ==========
        let cachedUsage = { remaining: 100, limit: 100, postsUsed: 0, tier: 'content-engine', isUnlimited: false };

        // Check if user can generate posts (calls server API)
        async function canGeneratePosts(numPosts) {
            try {
                const bodyData = { numPosts };
                const response = await fetch('/api/usage/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...SupabaseAuth.getAuthHeaders()
                    },
                    body: JSON.stringify(bodyData)
                });
                const result = await response.json();
                if (result.success) {
                    // Full Fix users are unlimited
                    if (result.isUnlimited) {
                        cachedUsage = {
                            remaining: null,
                            limit: null,
                            postsUsed: 0,
                            tier: result.tier,
                            isUnlimited: true
                        };
                    } else {
                        cachedUsage = {
                            remaining: result.remaining,
                            limit: result.limit,
                            postsUsed: result.limit - result.remaining,
                            tier: result.tier,
                            isUnlimited: false
                        };
                    }
                    return { canGenerate: result.canGenerate, message: result.message };
                }
                return { canGenerate: true, message: null }; // Fallback to allow if API fails
            } catch (error) {
                console.error('Error checking usage:', error);
                return { canGenerate: true, message: null }; // Fallback to allow if API fails
            }
        }

        // Record post generation (calls server API)
        async function recordPostGeneration(numPosts) {
            try {
                const bodyData = { count: numPosts };
                const response = await fetch('/api/usage/increment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...SupabaseAuth.getAuthHeaders()
                    },
                    body: JSON.stringify(bodyData)
                });
                const result = await response.json();
                if (result.success) {
                    cachedUsage.postsUsed = result.newCount;
                    cachedUsage.remaining = cachedUsage.limit - result.newCount;
                }
                updateUsageDisplay();
            } catch (error) {
                console.error('Error recording usage:', error);
            }
        }

        // Initialize usage tracking (fetch from server)
        async function initializeUsageTracking() {
            await fetchUsageFromServer();
        }

        // Fetch usage from server
        async function fetchUsageFromServer() {
            try {
                const url = '/api/usage';
                const response = await fetch(url, {
                    method: 'GET',
                    headers: SupabaseAuth.getAuthHeaders()
                });
                const result = await response.json();
                if (result.success) {
                    cachedUsage = {
                        remaining: result.usage.remaining,
                        limit: result.usage.limit,
                        postsUsed: result.usage.postsUsed,
                        tier: result.usage.tier,
                        isUnlimited: result.usage.isUnlimited || false
                    };
                    updateUsageDisplay();
                }
            } catch (error) {
                console.error('Error fetching usage:', error);
            }
        }

        // Reset usage counter (calls server API)
        async function resetUsageCounter() {
            if (!confirm('Reset your daily usage counter to 0?')) return;

            try {
                const response = await fetch('/api/usage/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...SupabaseAuth.getAuthHeaders()
                    },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                if (result.success) {
                    cachedUsage.postsUsed = 0;
                    cachedUsage.remaining = cachedUsage.limit;
                    updateUsageDisplay();
                    showSuccessToast('Usage counter reset!');
                } else {
                    showErrorToast('Failed to reset: ' + result.error);
                }
            } catch (error) {
                console.error('Error resetting usage:', error);
                showErrorToast('Failed to reset usage');
            }
        }

        // Update usage display UI
        function updateUsageDisplay() {
            const container = document.getElementById('usage-display');
            if (!container) return;

            const { remaining, limit, postsUsed, isUnlimited } = cachedUsage;

            // Full Fix users = unlimited
            if (isUnlimited) {
                container.innerHTML = `
                    <div class="flex items-center gap-2 text-green-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        <span class="text-sm font-medium">Unlimited posts (Full Fix)</span>
                    </div>
                `;
                return;
            }

            const isLow = remaining <= 20;
            const isEmpty = remaining === 0;
            const percentUsed = limit > 0 ? Math.round((postsUsed / limit) * 100) : 0;

            container.innerHTML = `
                <div class="flex items-center gap-2 ${isEmpty ? 'text-red-600' : isLow ? 'text-orange-600' : 'text-green-600'}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <span class="text-sm font-medium">Posts today: ${postsUsed}/${limit}</span>
                    ${postsUsed > 0 ? `<button onclick="resetUsageCounter()" class="ml-2 text-xs text-gray-500 hover:text-govcon-blue underline">Reset</button>` : ''}
                    ${percentUsed >= 80 && !isEmpty ? `<span class="ml-2 text-xs text-orange-500">Upgrade to Full Fix for unlimited!</span>` : ''}
                </div>
            `;
        }
        // ========== END USAGE TRACKING ==========

        // Update UI with user info
        function updateUserUI() {
            const user = SupabaseAuth.user;
            const emailEl = document.getElementById('user-email');
            if (emailEl && user) {
                emailEl.textContent = user.email;
            }
        }

        // Update UI for email-based login (non-Supabase)
        function updateEmailBasedUI(email) {
            const emailEl = document.getElementById('user-email');
            if (emailEl) {
                emailEl.textContent = email;
            }

            // Get tier from localStorage
            const tier = localStorage.getItem('gcg_tier') || 'content-engine';
            const tierEl = document.getElementById('user-tier');
            if (tierEl) {
                tierEl.textContent = tier === 'full-fix' ? 'Full Fix' : 'Content Engine';
            }

            // Set tier variables for email-only users (both local and window scope)
            userTier = tier;
            hasGraphicsAccess = (tier === 'full-fix');
            window.userTier = tier;
            window.hasGraphicsAccess = hasGraphicsAccess;
            console.log('[Tier] Email-only user tier set:', tier, '| Graphics access:', hasGraphicsAccess);

            // Update tier badge in header (same as initializeTier does)
            const tierBadge = document.getElementById('tier-badge');
            const tierContainer = document.getElementById('tier-badge-container');
            const tierIcon = document.getElementById('tier-icon');
            const tierSubtitle = document.getElementById('tier-subtitle');

            if (tierBadge && tierContainer && tierIcon && tierSubtitle) {
                if (tier === 'full-fix') {
                    tierBadge.textContent = 'Full Fix';
                    tierSubtitle.textContent = 'Posts + Graphics';
                    tierContainer.className = 'flex items-center gap-2 px-4 py-2 rounded-xl border-2 cursor-pointer hover:opacity-90 transition bg-gradient-to-r from-purple-500/30 to-indigo-500/30 border-purple-400/50';
                    tierIcon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-purple-500';
                    tierIcon.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>';
                    tierContainer.onclick = null;
                    tierContainer.style.cursor = 'default';
                } else {
                    tierBadge.textContent = 'Content Engine';
                    tierSubtitle.innerHTML = '<span class="text-yellow-300">Text Only</span>  <span class="underline">Upgrade $200</span>';
                    tierContainer.className = 'flex items-center gap-2 px-4 py-2 rounded-xl border-2 cursor-pointer hover:scale-105 transition-all bg-gradient-to-r from-yellow-500/20 to-amber-500/20 border-yellow-400/50 hover:border-yellow-400 hover:shadow-lg hover:shadow-yellow-500/20';
                    tierIcon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-gradient-to-br from-yellow-400 to-amber-500';
                    tierIcon.innerHTML = '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>';
                    tierContainer.onclick = () => window.open('https://buy.stripe.com/9B6cN62sm2IO7lb4SIfnO0o', '_blank');
                }
                console.log('[Tier] Badge updated for email-only user:', tier);
            }

            // Show/hide upgrade banner
            const upgradeBanner = document.getElementById('upgrade-banner');
            if (upgradeBanner) {
                if (tier !== 'full-fix') {
                    upgradeBanner.classList.remove('hidden');
                } else {
                    upgradeBanner.classList.add('hidden');
                }
            }

            // Show/hide brand colors section (Full Fix only)
            const brandColorsSection = document.getElementById('brand-colors-section');
            if (brandColorsSection) {
                if (tier === 'full-fix') {
                    brandColorsSection.classList.remove('hidden');
                } else {
                    brandColorsSection.classList.add('hidden');
                }
            }
        }

        // Logout function
        function logout() {
            // Clear any legacy localStorage (can be removed later)
            localStorage.removeItem('gcg_access');
            localStorage.removeItem('gcg_email');
            localStorage.removeItem('gcg_tier');
            localStorage.removeItem('gcg_tier_name');
            // Sign out of Supabase
            SupabaseAuth.signOut();
        }

        // Load company profile from Supabase
        async function loadCompanyProfile() {
            // All users now have proper Supabase sessions via magic links
            let profile = SupabaseAuth.profile;
            console.log('[Profile] Loading profile:', profile ? 'Found' : 'Not found');

            if (profile) {
                console.log('[Profile] Company:', profile.company_name, '| Services:', profile.core_services?.substring(0, 30) + '...');

                // Fill form fields
                document.getElementById('company-name').value = profile.company_name || '';
                document.getElementById('user-role').value = profile.role_title || '';
                document.getElementById('phone-number').value = profile.phone_number || '';
                document.getElementById('website').value = profile.website || '';
                document.getElementById('naics-codes').value = (profile.naics_codes || []).join(', ');
                document.getElementById('business-formation').value = profile.business_type || 'Small Business';
                document.getElementById('core-services').value = profile.core_services || '';
                document.getElementById('differentiators').value = profile.differentiators || '';
                document.getElementById('certifications').value = (profile.certifications || []).join(', ');
                document.getElementById('contract-vehicles').value = (profile.contract_vehicles || []).join(', ');
                document.getElementById('past-performance').value = '';

                // Load brand colors (Full Fix only)
                if (profile.brand_colors) {
                    const colors = profile.brand_colors;
                    document.getElementById('brand-primary-color').value = colors.primary || '#1e3a5f';
                    document.getElementById('brand-primary-hex').value = colors.primary || '#1e3a5f';
                    document.getElementById('brand-accent-color').value = colors.accent || '#c5a028';
                    document.getElementById('brand-accent-hex').value = colors.accent || '#c5a028';
                    document.getElementById('brand-bg-color').value = colors.background || '#0d1f33';
                    document.getElementById('brand-bg-hex').value = colors.background || '#0d1f33';
                    document.getElementById('use-brand-colors').checked = colors.enabled || false;

                    // Load company logo URL if saved
                    if (colors.logo_url) {
                        loadProfileLogo(colors.logo_url);
                    }

                    // Load profile photo if saved
                    if (colors.photo_url) {
                        loadProfilePhoto(colors.photo_url);
                    }

                    // Load background photo if saved
                    if (colors.background_photo_url) {
                        loadBgPhoto(colors.background_photo_url);
                    }

                    // Load tagline if saved
                    if (colors.tagline) {
                        document.getElementById('profile-tagline').value = colors.tagline;
                    }

                    // Load display name if saved
                    if (colors.display_name) {
                        document.getElementById('display-name').value = colors.display_name;
                    }
                }

                // Check if profile is complete (has required fields)
                const hasCompleteProfile = profile.company_name && profile.core_services && profile.naics_codes?.length > 0;
                console.log('[Profile] Complete:', hasCompleteProfile);

                // Always check form validity after loading profile to enable button
                checkFormValidity();

                if (hasCompleteProfile) {
                    // Show the daily dashboard experience for returning users
                    showDailyDashboard(profile);
                } else {
                    // Show full form for incomplete profiles
                    showProfileForm();
                }

                console.log('[Profile] Loaded profile from Supabase');
            } else {
                console.log('[Profile] No profile found - showing empty form');
                // New user - show full form
                showProfileForm();
            }
        }

        // Show profile summary (condensed view)
        function showProfileSummary(profile) {
            const summaryEl = document.getElementById('profile-summary');
            const formEl = document.getElementById('profile-form');
            const summaryName = document.getElementById('summary-company-name');
            const summaryDetails = document.getElementById('summary-details');

            // Set summary content
            summaryName.textContent = profile.company_name;

            // Build details string
            const details = [];
            if (profile.naics_codes && profile.naics_codes.length > 0) {
                details.push(`NAICS: ${profile.naics_codes.slice(0, 3).join(', ')}${profile.naics_codes.length > 3 ? '...' : ''}`);
            }
            if (profile.business_type && profile.business_type !== 'Small Business') {
                details.push(profile.business_type.replace('-', ' '));
            }
            if (profile.core_services) {
                const services = profile.core_services.split(',')[0].trim();
                details.push(services.substring(0, 30) + (services.length > 30 ? '...' : ''));
            }
            summaryDetails.textContent = details.join('  ') || 'Click Edit to add more details';

            // Show summary, hide form
            summaryEl.classList.remove('hidden');
            formEl.classList.add('hidden');
        }

        // Show full profile form
        function showProfileForm() {
            const summaryEl = document.getElementById('profile-summary');
            const formEl = document.getElementById('profile-form');

            summaryEl.classList.add('hidden');
            formEl.classList.remove('hidden');

            // Set up form validation listeners
            setupFormValidation();
        }

        // Check if required form fields are filled
        function checkFormValidity() {
            const companyName = document.getElementById('company-name')?.value?.trim();
            const coreServices = document.getElementById('core-services')?.value?.trim();
            const naicsCodes = document.getElementById('naics-codes')?.value?.trim();

            const isValid = companyName && coreServices && naicsCodes;
            const generateBtn = document.getElementById('generate-btn');
            const helpText = document.getElementById('generate-help');

            if (generateBtn) {
                generateBtn.disabled = !isValid;
            }
            if (helpText) {
                if (isValid) {
                    helpText.textContent = 'Ready to generate your LinkedIn posts!';
                } else {
                    const missing = [];
                    if (!companyName) missing.push('company name');
                    if (!coreServices) missing.push('core services');
                    if (!naicsCodes) missing.push('NAICS codes');
                    helpText.textContent = `Please fill in: ${missing.join(', ')}`;
                }
            }
            return isValid;
        }

        // Set up form validation listeners
        function setupFormValidation() {
            const fields = ['company-name', 'core-services', 'naics-codes'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', checkFormValidity);
                }
            });
            // Initial check
            checkFormValidity();
        }

        // Toggle between summary and form
        function toggleProfileForm() {
            const formEl = document.getElementById('profile-form');
            const isHidden = formEl.classList.contains('hidden');

            if (isHidden) {
                showProfileForm();
            } else {
                const profile = SupabaseAuth.profile;
                if (profile && profile.company_name) {
                    showProfileSummary(profile);
                }
            }
        }

        // Welcome Modal Functions
        function showWelcomeModal() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        async function closeWelcomeModal() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            // Mark that user has seen the welcome modal in their Supabase profile
            if (typeof SupabaseAuth !== 'undefined' && SupabaseAuth.user) {
                try {
                    await SupabaseAuth.saveUserProfile({ welcome_modal_seen: true });
                    console.log('[Welcome] Marked welcome modal as seen in profile');
                } catch (e) {
                    console.error('[Welcome] Failed to save welcome modal state:', e);
                }
            }
        }

        // Skip welcome and continue with regular generation
        async function skipWelcomeAndGenerate() {
            await closeWelcomeModal();

            // Transition to dashboard view (hide old form, show quick generate section)
            const profile = SupabaseAuth?.profile;
            if (profile) {
                showDailyDashboard(profile);
            }

            // Set to generate 10 posts for initial setup
            const numPostsSelect = document.getElementById('quick-num-posts');
            if (numPostsSelect) {
                numPostsSelect.value = '10';
            }

            // Continue with quick generate (10 posts)
            quickGenerate();
        }

        // Check if this is a first-time setup (show welcome modal after profile save)
        function checkFirstTimeSetup(isFirstSave) {
            const profile = SupabaseAuth?.profile;
            const welcomeSeen = profile?.welcome_modal_seen;
            if (isFirstSave && !welcomeSeen) {
                showWelcomeModal();
            }
        }

        // ============================================
        // DAILY DASHBOARD FUNCTIONS
        // ============================================

        // Show the daily dashboard for returning users
        function showDailyDashboard(profile) {
            // Show welcome greeting
            const greetingEl = document.getElementById('welcome-greeting');
            const greetingName = document.getElementById('greeting-company-name');
            greetingName.textContent = profile.company_name || 'Your Company';
            greetingEl.classList.remove('hidden');

            // Show quick generate section
            document.getElementById('quick-generate-section').classList.remove('hidden');

            // Update profile card
            const cardName = document.getElementById('card-company-name');
            const cardSummary = document.getElementById('card-summary');
            cardName.textContent = profile.company_name || 'Your Company Profile';

            const summaryParts = [];
            if (profile.naics_codes?.length) summaryParts.push(`NAICS: ${profile.naics_codes[0]}`);
            if (profile.business_type) summaryParts.push(profile.business_type.replace(/-/g, ' '));
            cardSummary.textContent = summaryParts.join('  ') || 'Click to expand and edit';

            // Show profile card, hide old generator form
            document.getElementById('profile-card').classList.remove('hidden');
            document.getElementById('generator-form').classList.add('hidden');

            // Load scheduled posts count
            loadScheduledPostsCount();

            // Load user preferences and set up listeners
            loadUserPreferences();
            setupPreferenceListeners();

            // Display target agencies
            displayQuickAgencies(profile);
        }

        // Display target agencies in quick generate section
        async function displayQuickAgencies(profile) {
            const container = document.getElementById('quick-agencies-list');
            if (!container) return;

            let agencies = profile.target_agencies || [];

            // If no agencies saved but we have NAICS codes, auto-fetch them
            if (agencies.length === 0 && profile.naics_codes?.length) {
                container.innerHTML = '<span class="text-sm text-govcon-blue"><svg class="inline animate-spin w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Loading agencies...</span>';

                try {
                    // Ensure NAICS codes are an array of strings
                    let naicsCodes = profile.naics_codes;
                    if (typeof naicsCodes === 'string') {
                        naicsCodes = naicsCodes.split(',').map(c => c.trim()).filter(Boolean);
                    }
                    if (!Array.isArray(naicsCodes)) {
                        naicsCodes = [String(naicsCodes)];
                    }

                    console.log('[Auto-fetch] NAICS codes:', naicsCodes);

                    const response = await fetch('/api/agencies/lookup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            naicsCodes: naicsCodes,
                            businessFormation: profile.business_type || ''
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('[Auto-fetch] Result:', result);

                        if (result.success && result.agencies?.length) {
                            agencies = result.agencies.slice(0, 15).map(a => a.name);

                            // Save to profile for next time
                            await SupabaseAuth.saveUserProfile({
                                ...profile,
                                target_agencies: agencies
                            });

                            // Refresh profile cache
                            SupabaseAuth.profile.target_agencies = agencies;
                        }
                    } else {
                        console.error('[Auto-fetch] Response not OK:', response.status);
                    }
                } catch (error) {
                    console.error('Error auto-fetching agencies:', error);
                }
            }

            if (agencies.length === 0) {
                container.innerHTML = '<span class="text-sm text-gray-500 italic">Click "Find Agencies" to discover your target market.</span>';
                return;
            }

            container.innerHTML = agencies.map((agency, index) => {
                const name = typeof agency === 'string' ? agency : agency.name;
                return `<span class="inline-flex items-center gap-1 px-3 py-1 bg-govcon-blue/10 text-govcon-blue text-sm rounded-full cursor-pointer hover:bg-red-100 hover:text-red-600 transition group" onclick="removeAgency(${index})" title="Click to remove">
                    ${name}
                    <svg class="w-3 h-3 opacity-0 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </span>`;
            }).join('');
        }

        // Remove an agency from the list
        async function removeAgency(index) {
            const profile = SupabaseAuth.profile;
            if (!profile?.target_agencies) return;

            const agencies = [...profile.target_agencies];
            const removed = agencies.splice(index, 1);

            console.log('[Remove Agency] Removing:', removed[0]);

            // Update profile
            SupabaseAuth.profile.target_agencies = agencies;

            // Save to database
            try {
                await SupabaseAuth.saveUserProfile({
                    ...profile,
                    target_agencies: agencies
                });
            } catch (e) {
                console.log('[Remove Agency] Could not save:', e.message);
            }

            // Update display
            displayQuickAgencies({ ...profile, target_agencies: agencies });
        }

        // Find agencies for returning users
        async function findAgenciesQuick() {
            const profile = SupabaseAuth.profile;
            if (!profile?.naics_codes?.length) {
                showInfoToast('Please add NAICS codes to your profile first');
                return;
            }

            const container = document.getElementById('quick-agencies-list');
            container.innerHTML = '<span class="text-sm text-govcon-blue"><svg class="inline animate-spin w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Finding agencies...</span>';

            try {
                // Ensure NAICS codes are an array of strings
                let naicsCodes = profile.naics_codes;
                if (typeof naicsCodes === 'string') {
                    naicsCodes = naicsCodes.split(',').map(c => c.trim()).filter(Boolean);
                }
                if (!Array.isArray(naicsCodes)) {
                    naicsCodes = [String(naicsCodes)];
                }

                console.log('[Find Agencies] NAICS codes:', naicsCodes);

                const response = await fetch('/api/agencies/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        naicsCodes: naicsCodes,
                        businessFormation: profile.business_type || ''
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Find Agencies] Response error:', response.status, errorText);
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Find Agencies] Result:', result);

                if (result.success && result.agencies?.length) {
                    const agencyNames = result.agencies.slice(0, 15).map(a => a.name);

                    // Save to profile
                    await SupabaseAuth.saveUserProfile({
                        ...profile,
                        target_agencies: agencyNames
                    });

                    // Refresh profile cache
                    SupabaseAuth.profile.target_agencies = agencyNames;

                    // Update display
                    displayQuickAgencies({ ...profile, target_agencies: agencyNames });
                } else {
                    container.innerHTML = '<span class="text-sm text-orange-600">No agencies found for NAICS ' + naicsCodes.join(', ') + '. Try different codes.</span>';
                }
            } catch (error) {
                console.error('Error finding agencies:', error);
                container.innerHTML = '<span class="text-sm text-red-600">Error: ' + error.message + '. Please try again.</span>';
            }
        }

        // Load count of scheduled posts
        async function loadScheduledPostsCount() {
            const user = SupabaseAuth.user;
            if (!user) return;

            try {
                const { count, error } = await SupabaseAuth.client
                    .from('scheduled_posts')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', user.id)
                    .eq('status', 'scheduled');

                if (!error) {
                    const countEl = document.getElementById('scheduled-count');
                    countEl.textContent = `${count || 0} posts scheduled`;
                }
            } catch (e) {
                console.error('Error loading scheduled count:', e);
            }
        }

        // Toggle profile card expand/collapse
        function toggleProfileCard() {
            const content = document.getElementById('profile-card-content');
            const arrow = document.getElementById('profile-card-arrow');
            const isHidden = content.classList.contains('hidden');

            if (isHidden) {
                // Move the actual profile form element (not just innerHTML) to preserve values
                const profileForm = document.getElementById('profile-form');
                if (profileForm && !content.contains(profileForm)) {
                    // Clear any stale innerHTML that might exist
                    content.innerHTML = '';
                    // Move the actual DOM element - this preserves all form values!
                    content.appendChild(profileForm);
                    profileForm.classList.remove('hidden');
                }
                content.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        // Quick Generate - streamlined daily generation
        async function quickGenerate() {
            const user = SupabaseAuth.user;
            const profile = SupabaseAuth.profile;

            // All users now have Supabase sessions
            if (!user) {
                showInfoToast('Please sign in first');
                return;
            }

            if (!profile?.company_name) {
                showInfoToast('Please complete your company profile first');
                return;
            }

            const numPosts = parseInt(document.getElementById('quick-num-posts').value);
            const contentStyle = document.getElementById('quick-content-style').value;
            const geoBoost = document.getElementById('quick-geo-boost').checked;
            const fineTuned = document.getElementById('quick-fine-tuned').checked;

            // Check usage limits via Supabase API
            const usageCheck = await canGeneratePosts(numPosts);
            if (!usageCheck.canGenerate) {
                alert(usageCheck.message || `You've reached your daily limit. Try again tomorrow or upgrade to Full Fix!`);
                updateUsageDisplay();
                return;
            }

            // Show loading state with animated progress on both buttons
            const quickBtn = document.getElementById('quick-generate-btn');
            const mainBtn = document.getElementById('generate-btn');
            const quickBtnOriginalText = quickBtn ? quickBtn.innerHTML : '';
            const mainBtnOriginalText = mainBtn ? mainBtn.innerHTML : '';

            if (quickBtn) quickBtn.disabled = true;
            if (mainBtn) mainBtn.disabled = true;

            // Check if we already have agencies
            const hasAgencies = profile.target_agencies?.length > 0;
            const startMessage = hasAgencies ? 'Analyzing your profile...' : 'Finding agencies...';
            const startProgress = hasAgencies ? 25 : 10;

            // Create progress bar HTML with percentage
            const progressHTML = `
                <div class="w-full flex flex-col items-center">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="gen-status-text">${startMessage}</span>
                        <span class="gen-percent-text font-bold ml-2">${startProgress}%</span>
                    </div>
                    <div class="w-full bg-white/30 rounded-full h-3 overflow-hidden">
                        <div class="gen-progress-bar bg-white h-3 rounded-full transition-all duration-700 ease-out relative" style="width: ${startProgress}%">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent animate-shimmer"></div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes shimmer {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                    .animate-shimmer { animation: shimmer 1.5s infinite; }
                </style>
            `;

            // Apply loading state to both buttons
            if (quickBtn) quickBtn.innerHTML = progressHTML;
            if (mainBtn) mainBtn.innerHTML = progressHTML;

            // Animated progress updates - skip agency step if we have them
            const statusMessages = hasAgencies ? [
                { text: 'Analyzing your profile...', progress: 25 },
                { text: 'Crafting content angles...', progress: 40 },
                { text: 'Writing posts...', progress: 55 },
                { text: 'Adding viral hooks...', progress: 70 },
                { text: 'Optimizing for engagement...', progress: 85 },
                { text: 'Polishing final draft...', progress: 95 }
            ] : [
                { text: 'Finding agencies...', progress: 10 },
                { text: 'Analyzing your profile...', progress: 25 },
                { text: 'Crafting content angles...', progress: 40 },
                { text: 'Writing posts...', progress: 60 },
                { text: 'Optimizing for engagement...', progress: 80 },
                { text: 'Almost there...', progress: 90 }
            ];

            let statusIndex = 0;
            let currentPercent = startProgress;

            // Function to animate percentage counting
            function animatePercent(from, to, duration = 700) {
                const startTime = performance.now();
                const diff = to - from;

                function update(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const current = Math.round(from + (diff * progress));
                    document.querySelectorAll('.gen-percent-text').forEach(el => el.textContent = current + '%');
                    if (progress < 1) {
                        requestAnimationFrame(update);
                    }
                }
                requestAnimationFrame(update);
            }

            const progressInterval = setInterval(() => {
                statusIndex++;
                if (statusIndex < statusMessages.length) {
                    const status = statusMessages[statusIndex];
                    // Update all progress elements (both buttons have these classes)
                    document.querySelectorAll('.gen-status-text').forEach(el => el.textContent = status.text);
                    document.querySelectorAll('.gen-progress-bar').forEach(el => el.style.width = status.progress + '%');
                    // Animate the percentage counter
                    animatePercent(currentPercent, status.progress);
                    currentPercent = status.progress;
                }
            }, 3000);

            try {
                // Get saved agencies or find new ones
                let agencies = profile.target_agencies || [];
                if (!agencies.length && profile.naics_codes?.length) {
                    const agencyResponse = await fetch('/api/agencies/lookup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            naicsCodes: profile.naics_codes,
                            businessFormation: profile.business_type || ''
                        })
                    });
                    const agencyResult = await agencyResponse.json();
                    if (agencyResult.success) {
                        agencies = agencyResult.agencies.slice(0, 15).map(a => a.name);
                    }
                }

                // Generate posts
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...SupabaseAuth.getAuthHeaders()
                    },
                    body: JSON.stringify({
                        companyProfile: {
                            companyName: profile.company_name,
                            coreServices: profile.core_services || '',
                            differentiators: profile.differentiators || '',
                            certifications: Array.isArray(profile.certifications) ? profile.certifications.join(', ') : '',
                            contractVehicles: Array.isArray(profile.contract_vehicles) ? profile.contract_vehicles.join(', ') : '',
                            businessFormation: profile.business_type || ''
                        },
                        targetAgencies: agencies,
                        numPosts: numPosts,
                        contentStyle: contentStyle,
                        geoBoost: geoBoost,
                        useFineTuned: fineTuned
                    })
                });

                // Check for HTTP errors before parsing
                if (!response.ok) {
                    const text = await response.text();
                    console.error('[Generate] HTTP Error:', response.status, text.substring(0, 200));
                    if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                        throw new Error('API route not found. Please refresh and try again.');
                    }
                    throw new Error(`Server error (${response.status}): ${text.substring(0, 100)}`);
                }

                // Validate JSON content-type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('[Generate] Invalid content-type:', contentType);
                    throw new Error('Server returned invalid response. Please try again.');
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Generation failed');
                }

                // Store generated posts
                generatedPosts = result.posts || [];

                // Record usage for tier limits (server-side)
                await recordPostGeneration(generatedPosts.length);

                // Display posts with action buttons
                displayQuickGeneratedPosts(generatedPosts);

            } catch (error) {
                console.error('Quick generate error:', error);
                showErrorToast('Error generating posts: ' + error.message);
            } finally {
                // Clear the progress interval
                clearInterval(progressInterval);
                // Restore both buttons
                if (quickBtn) {
                    quickBtn.disabled = false;
                    quickBtn.innerHTML = quickBtnOriginalText;
                }
                if (mainBtn) {
                    mainBtn.disabled = false;
                    mainBtn.innerHTML = mainBtnOriginalText;
                }
            }
        }

        // Display posts with daily action buttons
        function displayQuickGeneratedPosts(posts) {
            const container = document.getElementById('posts-container');
            container.innerHTML = '';

            posts.forEach((post, index) => {
                const postEl = document.createElement('div');
                postEl.className = 'bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden';
                postEl.innerHTML = `
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-3">
                            <h4 class="font-bold text-govcon-blue">${post.title || `Post ${index + 1}`}</h4>
                            <span class="text-xs bg-govcon-light text-govcon-blue px-2 py-1 rounded">${post.template || 'LinkedIn'}</span>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 mb-4 whitespace-pre-wrap text-sm text-gray-700 max-h-64 overflow-y-auto">${post.content.replace(/\*\*/g, '')}</div>
                        ${post.hashtags ? `<p class="text-sm text-linkedin-blue mb-4">${post.hashtags}</p>` : ''}

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-2 pt-3 border-t border-gray-100">
                            <button id="copy-btn-${index}" onclick="copyPost(${index})" class="flex items-center gap-1 px-3 py-2 bg-govcon-blue hover:bg-govcon-blue/90 text-white text-sm rounded-lg transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                Copy
                            </button>
                            <button id="save-btn-${index}" onclick="saveToLibrary(${index}, event)" class="flex items-center gap-1 px-3 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                                Save
                            </button>
                            <button id="schedule-btn-${index}" onclick="openScheduleModal(${index})" class="flex items-center gap-1 px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                Schedule
                            </button>
                            <button onclick="regeneratePost(${index})" class="flex items-center gap-1 px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-lg transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                Try Again
                            </button>
                            ${hasGraphicsAccess ? `
                            <button onclick="openVisualModal(${index})" class="flex items-center gap-1 px-3 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white text-sm rounded-lg transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                Create Visual
                            </button>
                            ` : `
                            <button onclick="showGraphicsUpgradeModal()" class="relative flex items-center gap-1 px-3 py-2 bg-gradient-to-r from-purple-400 to-indigo-400 text-white text-sm rounded-lg transition hover:from-purple-500 hover:to-indigo-500">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                Create Visual
                                <span class="absolute -top-2 -right-2 bg-yellow-400 text-xs text-gray-900 px-1.5 py-0.5 rounded-full font-bold">PRO</span>
                            </button>
                            `}
                        </div>

                        <!-- Image Generation Area (hidden by default) -->
                        <div id="image-area-${index}" class="hidden mt-4 pt-4 border-t border-gray-200">
                            <div id="image-loading-${index}" class="hidden text-center py-4">
                                <div class="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-2"></div>
                                <p class="text-sm text-gray-600">Creating graphic...</p>
                            </div>
                            <div id="image-result-${index}" class="hidden">
                                <img id="generated-img-${index}" class="w-full max-w-lg mx-auto rounded-lg shadow-lg mb-3" />
                                <div class="flex justify-center gap-2">
                                    <a id="download-link-${index}" download="linkedin-quote.png" class="flex items-center gap-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                        Download
                                    </a>
                                    <button onclick="cycleGraphicStyle(${index})" class="flex items-center gap-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded-lg transition">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                        New Style
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(postEl);
            });

            // Show generated posts section
            document.getElementById('generated-posts').classList.remove('hidden');

            // Scroll to posts
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Copy post to clipboard
        function copyPost(index) {
            const post = generatedPosts[index];
            if (!post) return;

            const text = post.content + (post.hashtags ? '\n\n' + post.hashtags : '');
            navigator.clipboard.writeText(text).then(() => {
                // Show permanent feedback
                const btn = document.getElementById(`copy-btn-${index}`);
                if (btn) {
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied';
                    btn.classList.remove('bg-govcon-blue', 'hover:bg-govcon-blue/90');
                    btn.classList.add('bg-emerald-500');
                    btn.disabled = true;
                }
                showSuccessToast('Post copied to clipboard!');
            });
        }

        // ========== BULK EXPORT FUNCTIONS ==========

        // Parse a line into TextRun segments: **bold**, *italic*, and plain text
        // LinkedIn doesn't support markdown, so we render bold/italic in Word and strip the asterisks
        function parseMarkdownLine(line) {
            const { TextRun } = docx;
            const runs = [];
            // Match **bold** first, then *italic*, then plain text between them
            const regex = /(\*\*(.+?)\*\*|\*(.+?)\*)/g;
            let lastIndex = 0;
            let match;

            while ((match = regex.exec(line)) !== null) {
                // Plain text before this match
                if (match.index > lastIndex) {
                    runs.push(new TextRun({
                        text: line.slice(lastIndex, match.index),
                        size: 24,
                        font: 'Calibri'
                    }));
                }
                if (match[2]) {
                    // **bold**
                    runs.push(new TextRun({
                        text: match[2],
                        bold: true,
                        size: 24,
                        font: 'Calibri'
                    }));
                } else if (match[3]) {
                    // *italic*
                    runs.push(new TextRun({
                        text: match[3],
                        italics: true,
                        size: 24,
                        font: 'Calibri'
                    }));
                }
                lastIndex = match.index + match[0].length;
            }

            // Remaining plain text after last match
            if (lastIndex < line.length) {
                runs.push(new TextRun({
                    text: line.slice(lastIndex),
                    size: 24,
                    font: 'Calibri'
                }));
            }

            // If the line was empty or had no text, push an empty run
            if (runs.length === 0) {
                runs.push(new TextRun({ text: '', size: 24, font: 'Calibri' }));
            }

            return runs;
        }

        // Export all generated posts to a Word (.docx) file
        function exportAllPostsToDocx() {
            if (!generatedPosts || generatedPosts.length === 0) {
                showErrorToast('No posts to export. Generate posts first.');
                return;
            }

            try {
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, BorderStyle, PageBreak } = docx;

                const children = [];

                generatedPosts.forEach((post, i) => {
                    // Post header
                    children.push(new Paragraph({
                        heading: HeadingLevel.HEADING_2,
                        children: [
                            new TextRun({
                                text: `Post ${i + 1}`,
                                bold: true,
                                size: 28,
                                color: '333333'
                            }),
                            new TextRun({
                                text: post.style ? `  ${post.style}` : '',
                                size: 28,
                                color: '666666',
                                italics: true
                            })
                        ]
                    }));

                    // Separator line
                    children.push(new Paragraph({
                        border: { bottom: { style: BorderStyle.SINGLE, size: 1, color: 'CCCCCC' } },
                        spacing: { after: 200 }
                    }));

                    // Post content  split by newline, parse markdown bold/italic into Word formatting
                    const contentLines = (post.content || '').split('\n');
                    contentLines.forEach(line => {
                        children.push(new Paragraph({
                            children: parseMarkdownLine(line),
                            spacing: { after: 80 }
                        }));
                    });

                    // Hashtags in LinkedIn blue
                    if (post.hashtags) {
                        children.push(new Paragraph({ spacing: { before: 120 } }));
                        children.push(new Paragraph({
                            children: [
                                new TextRun({
                                    text: post.hashtags,
                                    size: 22,
                                    color: '0077B5',
                                    font: 'Calibri'
                                })
                            ]
                        }));
                    }

                    // Page break between posts (not after last)
                    if (i < generatedPosts.length - 1) {
                        children.push(new Paragraph({
                            children: [new PageBreak()]
                        }));
                    }
                });

                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: children
                    }]
                });

                const today = new Date().toISOString().slice(0, 10);
                Packer.toBlob(doc).then(blob => {
                    saveAs(blob, `linkedin-posts-${today}.docx`);
                    showSuccessToast(`Exported ${generatedPosts.length} posts to .docx`);
                });
            } catch (err) {
                console.error('[Export DOCX]', err);
                showErrorToast('Failed to export posts. Please try again.');
            }
        }

        // Download all posts as mixed visual cards in a .zip
        async function downloadAllVisuals() {
            if (!generatedPosts || generatedPosts.length === 0) {
                showErrorToast('No posts to export. Generate posts first.');
                return;
            }

            if (!hasGraphicsAccess) {
                showGraphicsUpgradeModal();
                return;
            }

            const progressEl = document.getElementById('export-progress');
            const progressText = document.getElementById('export-progress-text');
            progressEl.classList.remove('hidden');

            try {
                const zip = new JSZip();
                const companyName = SupabaseAuth?.profile?.company_name || document.getElementById('company-name')?.value || 'Your Company';
                const total = generatedPosts.length;

                // Cycle through 4 layout types (skip photoquote  needs uploaded photo)
                const layoutKeys = ['classic', 'tweet', 'social', 'highlighter'];

                for (let i = 0; i < total; i++) {
                    const post = generatedPosts[i];
                    progressText.textContent = `Generating visual ${i + 1} of ${total}...`;

                    // Extract a quote for the card
                    let quote = '';
                    try {
                        const res = await fetch('/api/generate-graphic', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content: post.content })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            quote = data.quote || data.text || '';
                        }
                    } catch (e) {
                        // Fallback silently
                    }
                    if (!quote) {
                        quote = getFirstLine(post.content || '');
                    }

                    // Pick layout and theme  cycle through all 4 layouts and their themes
                    const layoutKey = layoutKeys[i % layoutKeys.length];
                    const themes = graphicLayouts[layoutKey]?.themes || quoteCardStyles;
                    const theme = themes[Math.floor(i / layoutKeys.length) % themes.length];

                    // Render using the unified renderGraphic router
                    const dataUrl = await renderGraphic(layoutKey, quote, companyName, theme);

                    // Convert data URL to binary for zip
                    const base64 = dataUrl.split(',')[1];
                    const layoutLabel = (graphicLayouts[layoutKey]?.label || 'post').replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                    zip.file(`post-${String(i + 1).padStart(2, '0')}-${layoutLabel}.png`, base64, { base64: true });
                }

                progressText.textContent = 'Bundling zip file...';
                const blob = await zip.generateAsync({ type: 'blob' });
                const today = new Date().toISOString().slice(0, 10);
                saveAs(blob, `linkedin-visuals-${today}.zip`);

                progressEl.classList.add('hidden');
                showSuccessToast(`Downloaded ${total} visual cards as .zip`);
            } catch (err) {
                console.error('[Download Visuals]', err);
                progressEl.classList.add('hidden');
                showErrorToast('Failed to generate visuals. Please try again.');
            }
        }

        // Track style index for each quick post
        const quickStyleIndex = {};

        // Generate graphic for quick posts (default classic quote, used as fallback)
        async function generateQuickImage(index) {
            const post = generatedPosts[index];
            if (!post) return;

            // If no layout stored yet, open the visual modal instead
            if (!post.graphicLayout) {
                openVisualModal(index);
                return;
            }

            // Otherwise cycle style (same as New Style)
            cycleGraphicStyle(index);
        }

        // Save post to library with retry logic
        async function saveToLibrary(index, evt) {
            const post = generatedPosts[index];
            if (!post) {
                console.error('[SaveToLibrary] No post at index:', index);
                return;
            }

            // Get button element for feedback
            const btn = evt?.target?.closest('button') || document.querySelector(`[onclick*="saveToLibrary(${index}"]`) || document.getElementById(`save-btn-${index}`);

            // Show saving state immediately
            if (btn) {
                btn.disabled = true;
                btn.dataset.originalHtml = btn.innerHTML;
                btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Saving...';
            }

            try {
                const postTitle = post.title || post.template || `Post ${index + 1}`;
                console.log('[SaveToLibrary] Saving post:', index, postTitle);

                // Convert hashtags to array format for 'tags' column
                const tagsArray = Array.isArray(post.hashtags)
                    ? post.hashtags
                    : (post.hashtags ? post.hashtags.split(/\s+/).filter(t => t) : []);

                // All users now have Supabase sessions - use safeInsert directly
                // Retry logic - try up to 2 times
                let lastError = null;
                for (let attempt = 1; attempt <= 2; attempt++) {
                    try {
                        // Use Supabase for all authenticated users
                        const insertPromise = SupabaseAuth.safeInsert('content_library', {
                            title: postTitle,
                            content: post.content,
                            post_type: 'linkedin',
                            tags: tagsArray,
                            goal: post.template || null
                        });

                        // 20-second timeout
                        const timeoutPromise = new Promise((_, reject) =>
                            setTimeout(() => reject(new Error('Save timed out')), 20000)
                        );

                        const result = await Promise.race([insertPromise, timeoutPromise]);
                        const { data, error } = result;

                        if (error) {
                            throw error;
                        }

                        console.log('[SaveToLibrary] Success:', data);
                        lastError = null;
                        break; // Success, exit retry loop
                    } catch (attemptError) {
                        lastError = attemptError;
                        console.warn(`[SaveToLibrary] Attempt ${attempt} failed:`, attemptError.message);
                        if (attempt < 2) {
                            console.log('[SaveToLibrary] Retrying in 1 second...');
                            if (btn) btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity="0.25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Retrying...';
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }

                if (lastError) {
                    throw lastError;
                }

                // Show success feedback - keep button as "Saved" permanently
                if (btn) {
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-emerald-500');
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Saved';
                    btn.disabled = true; // Keep disabled to prevent duplicate saves
                }
            } catch (error) {
                console.error('[SaveToLibrary] Error:', error);

                // Show error feedback
                if (btn) {
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-red-500');
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg> Failed';

                    setTimeout(() => {
                        btn.innerHTML = btn.dataset.originalHtml || '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg> Save';
                        btn.classList.remove('bg-red-500');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                        btn.disabled = false;
                    }, 3000);
                }
                const errorMsg = error.message || 'Unknown error';
                if (errorMsg.includes('timed out')) {
                    alert('Save timed out. Please check your internet connection and try again.');
                } else {
                    alert('Error saving to library: ' + errorMsg);
                }
            }
        }

        // Open schedule modal for a post
        function openScheduleModal(index) {
            const post = generatedPosts[index];
            if (!post) return;

            // Store post for scheduling
            window.postToSchedule = { ...post, index };

            // Create and show schedule modal
            showQuickScheduleModal(post);
        }

        // Show quick schedule modal
        function showQuickScheduleModal(post) {
            // Remove existing modal if any
            const existing = document.getElementById('quick-schedule-modal');
            if (existing) existing.remove();

            // Calculate suggested dates (today, tomorrow, day after)
            const today = new Date();
            const dates = [
                { label: 'Today 9 AM', date: new Date(today.setHours(9, 0, 0, 0)) },
                { label: 'Tomorrow 9 AM', date: new Date(new Date().setDate(new Date().getDate() + 1)) },
                { label: 'In 2 Days', date: new Date(new Date().setDate(new Date().getDate() + 2)) }
            ];
            dates[1].date.setHours(9, 0, 0, 0);
            dates[2].date.setHours(9, 0, 0, 0);

            const modal = document.createElement('div');
            modal.id = 'quick-schedule-modal';
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Schedule This Post</h3>
                    <p class="text-sm text-gray-600 mb-4">"${(post.title || post.content.substring(0, 50) + '...')}"</p>

                    <div class="space-y-2 mb-4">
                        ${dates.map((d, i) => `
                            <button onclick="schedulePostQuick('${d.date.toISOString()}')" class="w-full p-3 text-left rounded-lg border border-gray-200 hover:border-govcon-blue hover:bg-govcon-light transition">
                                <span class="font-medium">${d.label}</span>
                                <span class="text-sm text-gray-500 ml-2">${d.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                            </button>
                        `).join('')}
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Or pick a date:</label>
                        <input type="datetime-local" id="custom-schedule-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="flex gap-3">
                        <button onclick="closeQuickScheduleModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition">Cancel</button>
                        <button onclick="schedulePostCustom()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition">Schedule</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeQuickScheduleModal() {
            const modal = document.getElementById('quick-schedule-modal');
            if (modal) modal.remove();
        }

        // ===================== CAROUSEL FROM POST MODAL =====================

        // Store post for carousel conversion
        let carouselSourcePost = null;
        let carouselSlideImages = [];

        // Carousel themes with colors
        const carouselThemes = {
            mybrand: {
                name: 'My Brand Colors',
                bg: 'dynamic', // Will be set from profile
                text: '#ffffff',
                accent: 'dynamic',
                secondary: '#e8f4fd',
                icon: ''
            },
            corporate: {
                name: 'Professional Corporate',
                bg: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%)',
                text: '#ffffff',
                accent: '#0077B5',
                secondary: '#e8f4fd'
            },
            veteran: {
                name: 'Veteran Pride',
                bg: 'linear-gradient(135deg, #1a2a3a 0%, #2c4a5f 100%)',
                text: '#ffffff',
                accent: '#c9a227',
                secondary: '#f0e8d0'
            },
            bold: {
                name: 'Bold Modern',
                bg: 'linear-gradient(135deg, #ff6b35 0%, #f72585 100%)',
                text: '#ffffff',
                accent: '#ffbe0b',
                secondary: '#ffffff'
            },
            minimal: {
                name: 'Minimalist',
                bg: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)',
                text: '#212529',
                accent: '#0077B5',
                secondary: '#6c757d'
            },
            tech: {
                name: 'Tech Blueprint',
                bg: 'linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%)',
                text: '#e0e1dd',
                accent: '#00d4ff',
                secondary: '#415a77'
            },
            growth: {
                name: 'Growth Green',
                bg: 'linear-gradient(135deg, #004d40 0%, #00796b 100%)',
                text: '#ffffff',
                accent: '#a5d6a7',
                secondary: '#e8f5e9'
            }
        };

        // Store visual modal state
        let visualSourcePost = null;
        let visualActiveTab = 'graphic';
        let visualSelectedLayout = 'classic';
        let visualSelectedThemeIndex = 0;

        // Open unified visual modal (replaces openCarouselModal)
        function openVisualModal(index, defaultTab) {
            const post = generatedPosts[index];
            if (!post) return;

            visualSourcePost = { ...post, index };
            carouselSourcePost = { ...post, index };
            visualActiveTab = defaultTab || 'graphic';
            visualSelectedLayout = 'classic';
            visualSelectedThemeIndex = 0;

            const existing = document.getElementById('visual-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'visual-modal';
            modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center overflow-y-auto py-8';

            const excerpt = (post.title || post.content.substring(0, 80) + '...').replace(/"/g, '&quot;');

            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 p-6" style="max-height: 90vh; overflow-y: auto;">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-xl font-bold text-gray-900">Create Visual from Post</h3>
                        <button onclick="closeVisualModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <p class="text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-lg italic">"${excerpt}"</p>

                    <!-- Tab Toggle -->
                    <div class="flex bg-gray-100 rounded-lg p-1 mb-5">
                        <button id="visual-tab-graphic" onclick="switchVisualTab('graphic')" class="flex-1 py-2.5 px-4 rounded-md text-sm font-semibold transition ${visualActiveTab === 'graphic' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">
                            Single Graphic
                        </button>
                        <button id="visual-tab-carousel" onclick="switchVisualTab('carousel')" class="flex-1 py-2.5 px-4 rounded-md text-sm font-semibold transition ${visualActiveTab === 'carousel' ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">
                            Carousel
                        </button>
                    </div>

                    <!-- SINGLE GRAPHIC TAB -->
                    <div id="visual-graphic-tab" class="${visualActiveTab === 'graphic' ? '' : 'hidden'}">
                        <!-- Layout Picker (2x2 grid) -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Layout</label>
                            <div class="grid grid-cols-2 gap-2" id="layout-picker">
                                ${Object.entries(graphicLayouts).map(([key, layout]) => `
                                    <button onclick="selectGraphicLayout('${key}')" id="layout-${key}" class="p-3 rounded-lg border-2 transition text-left ${key === 'classic' ? 'border-govcon-blue bg-blue-50' : 'border-gray-200 hover:border-gray-300'} ${key === 'photoquote' ? 'col-span-2' : ''}">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-lg">${layout.icon}</span>
                                            <span class="text-sm font-semibold ${key === 'classic' ? 'text-govcon-blue' : 'text-gray-800'}">${layout.label}</span>
                                            ${key === 'photoquote' ? '<span class="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded ml-auto">Requires photo</span>' : ''}
                                        </div>
                                        <p class="text-xs text-gray-500">${layout.description}</p>
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Color Theme Picker (dynamic per layout) -->
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Color Theme</label>
                            <div id="theme-picker" class="flex gap-2 flex-wrap">
                                ${buildThemePicker('classic', 0)}
                            </div>
                        </div>

                        <input type="hidden" id="visual-layout" value="classic">
                        <input type="hidden" id="visual-theme-index" value="0">
                    </div>

                    <!-- CAROUSEL TAB -->
                    <div id="visual-carousel-tab" class="${visualActiveTab === 'carousel' ? '' : 'hidden'}">
                        <!-- Number of Slides -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Number of Slides</label>
                            <div class="grid grid-cols-4 gap-2">
                                ${[3, 4, 5, 6].map(num => `
                                    <button onclick="selectSlideCount(${num})" id="slide-count-${num}" class="p-3 rounded-lg border-2 transition ${num === 4 ? 'border-govcon-blue bg-govcon-light' : 'border-gray-200 hover:border-gray-300'}">
                                        <span class="text-xl font-bold ${num === 4 ? 'text-govcon-blue' : 'text-gray-700'}">${num}</span>
                                        <span class="block text-xs text-gray-500">slides</span>
                                    </button>
                                `).join('')}
                            </div>
                            <input type="hidden" id="carousel-slide-count" value="4">
                        </div>

                        <!-- Theme Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Visual Theme</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${Object.entries(carouselThemes).map(([key, theme], i) => {
                                    const brandBg = document.getElementById("brand-bg-color")?.value || "#0d1f33";
                                    const brandAccent = document.getElementById("brand-accent-color")?.value || "#c5a028";
                                    const bgStyle = key === "mybrand" ? brandBg : theme.bg;
                                    const accentStyle = key === "mybrand" ? brandAccent : theme.accent;
                                    const isSelected = key === "mybrand";
                                    return "<button onclick=\"selectCarouselTheme('" + key + "')\" id=\"theme-" + key + "\" class=\"p-3 rounded-lg border-2 transition text-left " + (isSelected ? "border-govcon-blue bg-govcon-light" : "border-gray-200 hover:border-gray-300") + "\">" +
                                        "<div class=\"flex items-center gap-2\">" +
                                            "<div class=\"w-6 h-6 rounded-full flex items-center justify-center text-xs\" style=\"background: " + bgStyle + "; border: 2px solid " + accentStyle + "\">" + (theme.icon || "") + "</div>" +
                                            "<span class=\"text-sm font-medium " + (isSelected ? "text-govcon-blue" : "text-gray-700") + "\">" + theme.name + "</span>" +
                                        "</div>" +
                                    "</button>";
                                }).join("")}
                            </div>
                            <input type="hidden" id="carousel-theme" value="mybrand">
                        </div>

                        <!-- Slide Focus Options -->
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Slide Focus (optional)</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="focus-hook" class="w-4 h-4 text-govcon-blue rounded" checked>
                                    <span class="text-sm text-gray-700">Hook + Problem Statement</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="focus-solution" class="w-4 h-4 text-govcon-blue rounded" checked>
                                    <span class="text-sm text-gray-700">Your Solution / Approach</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="focus-proof" class="w-4 h-4 text-govcon-blue rounded">
                                    <span class="text-sm text-gray-700">Proof / Case Study / Stats</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="focus-cta" class="w-4 h-4 text-govcon-blue rounded" checked>
                                    <span class="text-sm text-gray-700">Call-to-Action Slide</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="closeVisualModal()" class="flex-1 px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition font-medium">
                            Cancel
                        </button>
                        <button onclick="generateVisualFromModal()" id="generate-visual-btn" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-lg transition font-medium flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            Generate
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeVisualModal();
            });
        }

        // Backward compat alias
        function openCarouselModal(index) {
            openVisualModal(index, 'carousel');
        }

        function closeVisualModal() {
            const modal = document.getElementById('visual-modal');
            if (modal) modal.remove();
        }

        function closeCarouselConfigModal() {
            closeVisualModal();
        }

        // Build theme picker circles for a given layout
        function buildThemePicker(layout, selectedIdx) {
            const themes = graphicLayouts[layout]?.themes || quoteCardStyles;
            return themes.map((theme, i) => {
                const bgColor = theme.accent || theme.bg || theme.bgGradient?.[0] || '#333';
                const isSelected = i === selectedIdx;
                const ring = isSelected ? 'ring-2 ring-offset-2 ring-blue-500' : '';
                return `<button onclick="selectGraphicTheme(${i})" class="w-9 h-9 rounded-full border-2 border-gray-300 transition hover:scale-110 ${ring}" style="background: ${bgColor};" title="${theme.name}"></button>`;
            }).join('');
        }

        // Switch tabs in visual modal
        function switchVisualTab(tab) {
            visualActiveTab = tab;
            const graphicTab = document.getElementById('visual-graphic-tab');
            const carouselTab = document.getElementById('visual-carousel-tab');
            const graphicBtn = document.getElementById('visual-tab-graphic');
            const carouselBtn = document.getElementById('visual-tab-carousel');

            if (tab === 'graphic') {
                graphicTab.classList.remove('hidden');
                carouselTab.classList.add('hidden');
                graphicBtn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                graphicBtn.classList.remove('text-gray-500');
                carouselBtn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                carouselBtn.classList.add('text-gray-500');
            } else {
                graphicTab.classList.add('hidden');
                carouselTab.classList.remove('hidden');
                carouselBtn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                carouselBtn.classList.remove('text-gray-500');
                graphicBtn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                graphicBtn.classList.add('text-gray-500');
            }
        }

        // Select a graphic layout in the modal
        function selectGraphicLayout(layout) {
            visualSelectedLayout = layout;
            visualSelectedThemeIndex = 0;

            // Update layout picker highlight
            Object.keys(graphicLayouts).forEach(key => {
                const btn = document.getElementById('layout-' + key);
                if (!btn) return;
                if (key === layout) {
                    btn.classList.add('border-govcon-blue', 'bg-blue-50');
                    btn.classList.remove('border-gray-200');
                    btn.querySelector('.text-sm.font-semibold')?.classList.add('text-govcon-blue');
                    btn.querySelector('.text-sm.font-semibold')?.classList.remove('text-gray-800');
                } else {
                    btn.classList.remove('border-govcon-blue', 'bg-blue-50');
                    btn.classList.add('border-gray-200');
                    btn.querySelector('.text-sm.font-semibold')?.classList.remove('text-govcon-blue');
                    btn.querySelector('.text-sm.font-semibold')?.classList.add('text-gray-800');
                }
            });

            // Update theme picker
            document.getElementById('theme-picker').innerHTML = buildThemePicker(layout, 0);
            document.getElementById('visual-layout').value = layout;
            document.getElementById('visual-theme-index').value = '0';
        }

        // Select a theme in the modal
        function selectGraphicTheme(idx) {
            visualSelectedThemeIndex = idx;
            document.getElementById('visual-theme-index').value = String(idx);
            document.getElementById('theme-picker').innerHTML = buildThemePicker(visualSelectedLayout, idx);
        }

        // Dispatch generation from modal
        function generateVisualFromModal() {
            if (visualActiveTab === 'graphic') {
                generateGraphicFromModal();
            } else {
                generateCarouselFromPost();
            }
        }

        // Generate a single graphic from the modal config
        async function generateGraphicFromModal() {
            if (!visualSourcePost) return;

            const index = visualSourcePost.index;
            const layout = document.getElementById('visual-layout').value;
            const themeIdx = parseInt(document.getElementById('visual-theme-index').value) || 0;
            const themes = graphicLayouts[layout]?.themes || quoteCardStyles;
            const theme = themes[themeIdx] || themes[0];
            const apiType = graphicLayouts[layout]?.apiType || 'quote';

            // Photo Quote requires a background photo
            if (layout === 'photoquote' && !backgroundPhotoUrl) {
                showErrorToast('Photo Quote requires a Background Photo. Upload one in your Profile settings.');
                return;
            }

            // Close modal
            closeVisualModal();

            // Show loading in the image area
            const imageArea = document.getElementById(`image-area-${index}`);
            const loadingEl = document.getElementById(`image-loading-${index}`);
            const resultEl = document.getElementById(`image-result-${index}`);

            if (imageArea) imageArea.classList.remove('hidden');
            if (loadingEl) loadingEl.classList.remove('hidden');
            if (resultEl) resultEl.classList.add('hidden');

            // Also handle expanded view loading
            const expLoadingEl = document.getElementById(`image-loading-${index}`);
            const expContainerEl = document.getElementById(`image-container-${index}`);
            if (expLoadingEl) expLoadingEl.classList.remove('hidden');
            if (expContainerEl) expContainerEl.classList.add('hidden');

            try {
                const post = visualSourcePost;
                const cleanContent = post.content.replace(/\*\*/g, '');
                const companyName = SupabaseAuth.profile?.company_name || document.getElementById('company-name')?.value || 'Your Company';

                // Call API
                let graphicData;
                try {
                    const response = await fetch('/api/generate-graphic', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ postContent: cleanContent, type: apiType })
                    });
                    const result = await response.json();
                    if (result.success) {
                        graphicData = result.data;
                    }
                } catch (e) {
                    console.log('API graphic generation failed, using fallback');
                }

                if (!graphicData) {
                    graphicData = { quote: getFirstLine(post.content) };
                }

                // Render
                const imageDataUrl = await renderGraphic(layout, graphicData, companyName, theme);

                // Display in quick view
                const imgEl = document.getElementById(`generated-img-${index}`);
                const downloadLink = document.getElementById(`download-link-${index}`);
                if (imgEl) imgEl.src = imageDataUrl;
                if (downloadLink) {
                    downloadLink.href = imageDataUrl;
                    downloadLink.download = `linkedin-${layout}-graphic.png`;
                }

                // Display in expanded view
                const expImageEl = document.getElementById(`generated-image-${index}`);
                const expDownloadBtn = document.getElementById(`download-btn-${index}`);
                const styleEl = document.getElementById(`image-style-${index}`);
                const quoteDisplayEl = document.getElementById(`quote-display-${index}`);

                if (expImageEl) expImageEl.src = imageDataUrl;
                if (expDownloadBtn) {
                    expDownloadBtn.href = imageDataUrl;
                    expDownloadBtn.download = `linkedin-${layout}-graphic.png`;
                }
                if (styleEl) styleEl.textContent = `${graphicTypeLabels[layout] || 'Classic Quote'} \u00B7 ${theme.name}`;
                if (quoteDisplayEl) {
                    const displayP = quoteDisplayEl.querySelector('p');
                    if (displayP) displayP.textContent = graphicData.quote || graphicData;
                }

                if (loadingEl) loadingEl.classList.add('hidden');
                if (resultEl) resultEl.classList.remove('hidden');
                if (expLoadingEl) expLoadingEl.classList.add('hidden');
                if (expContainerEl) expContainerEl.classList.remove('hidden');

                // Store state for New Style
                generatedPosts[index].imageUrl = imageDataUrl;
                generatedPosts[index].extractedQuote = graphicData.quote || graphicData;
                generatedPosts[index].imageStyle = theme.name;
                generatedPosts[index].graphicLayout = layout;
                generatedPosts[index].graphicThemeIndex = themeIdx;
                generatedPosts[index].graphicData = graphicData;

                showSuccessToast(`${graphicTypeLabels[layout] || 'Graphic'} created (${theme.name})`);
            } catch (error) {
                console.error('Error generating graphic from modal:', error);
                if (loadingEl) loadingEl.classList.add('hidden');
                if (imageArea) imageArea.classList.add('hidden');
                if (expLoadingEl) expLoadingEl.classList.add('hidden');
                showErrorToast('Failed to generate graphic: ' + error.message);
            }
        }

        // Cycle to next theme within the same layout (New Style button)
        async function cycleGraphicStyle(index) {
            const post = generatedPosts[index];
            if (!post) return;

            const layout = post.graphicLayout || 'classic';
            const themes = graphicLayouts[layout]?.themes || quoteCardStyles;
            const currentIdx = post.graphicThemeIndex !== undefined ? post.graphicThemeIndex : -1;
            const nextIdx = (currentIdx + 1) % themes.length;
            const theme = themes[nextIdx];
            const graphicData = post.graphicData || { quote: post.extractedQuote || getFirstLine(post.content) };

            const companyName = SupabaseAuth.profile?.company_name || document.getElementById('company-name')?.value || 'Your Company';

            // Show loading
            const imageArea = document.getElementById(`image-area-${index}`);
            const loadingEl = document.getElementById(`image-loading-${index}`);
            const resultEl = document.getElementById(`image-result-${index}`);
            if (imageArea) imageArea.classList.remove('hidden');
            if (loadingEl) loadingEl.classList.remove('hidden');
            if (resultEl) resultEl.classList.add('hidden');

            const expLoadingEl = document.getElementById(`image-loading-${index}`);
            const expContainerEl = document.getElementById(`image-container-${index}`);
            if (expLoadingEl) expLoadingEl.classList.remove('hidden');
            if (expContainerEl) expContainerEl.classList.add('hidden');

            try {
                const imageDataUrl = await renderGraphic(layout, graphicData, companyName, theme);

                // Quick view
                const imgEl = document.getElementById(`generated-img-${index}`);
                const downloadLink = document.getElementById(`download-link-${index}`);
                if (imgEl) imgEl.src = imageDataUrl;
                if (downloadLink) {
                    downloadLink.href = imageDataUrl;
                    downloadLink.download = `linkedin-${layout}-graphic.png`;
                }

                // Expanded view
                const expImageEl = document.getElementById(`generated-image-${index}`);
                const expDownloadBtn = document.getElementById(`download-btn-${index}`);
                const styleEl = document.getElementById(`image-style-${index}`);
                if (expImageEl) expImageEl.src = imageDataUrl;
                if (expDownloadBtn) {
                    expDownloadBtn.href = imageDataUrl;
                    expDownloadBtn.download = `linkedin-${layout}-graphic.png`;
                }
                if (styleEl) styleEl.textContent = `${graphicTypeLabels[layout] || 'Classic Quote'} \u00B7 ${theme.name}`;

                if (loadingEl) loadingEl.classList.add('hidden');
                if (resultEl) resultEl.classList.remove('hidden');
                if (expLoadingEl) expLoadingEl.classList.add('hidden');
                if (expContainerEl) expContainerEl.classList.remove('hidden');

                // Update stored state
                post.imageUrl = imageDataUrl;
                post.imageStyle = theme.name;
                post.graphicThemeIndex = nextIdx;

                showSuccessToast(`${graphicTypeLabels[layout] || 'Graphic'} (${theme.name})`);
            } catch (error) {
                console.error('Error cycling style:', error);
                if (loadingEl) loadingEl.classList.add('hidden');
                if (expLoadingEl) expLoadingEl.classList.add('hidden');
                showErrorToast('Failed to generate graphic');
            }
        }

        function selectSlideCount(count) {
            // Update hidden input
            document.getElementById('carousel-slide-count').value = count;

            // Update button styles
            [3, 4, 5, 6].forEach(num => {
                const btn = document.getElementById(`slide-count-${num}`);
                if (num === count) {
                    btn.classList.add('border-govcon-blue', 'bg-govcon-light');
                    btn.classList.remove('border-gray-200');
                    btn.querySelector('span:first-child').classList.add('text-govcon-blue');
                    btn.querySelector('span:first-child').classList.remove('text-gray-700');
                } else {
                    btn.classList.remove('border-govcon-blue', 'bg-govcon-light');
                    btn.classList.add('border-gray-200');
                    btn.querySelector('span:first-child').classList.remove('text-govcon-blue');
                    btn.querySelector('span:first-child').classList.add('text-gray-700');
                }
            });
        }

        function selectCarouselTheme(theme) {
            // Update hidden input
            document.getElementById('carousel-theme').value = theme;

            // Update button styles
            Object.keys(carouselThemes).forEach(key => {
                const btn = document.getElementById(`theme-${key}`);
                if (key === theme) {
                    btn.classList.add('border-govcon-blue', 'bg-govcon-light');
                    btn.classList.remove('border-gray-200');
                    btn.querySelector('span').classList.add('text-govcon-blue');
                    btn.querySelector('span').classList.remove('text-gray-700');
                } else {
                    btn.classList.remove('border-govcon-blue', 'bg-govcon-light');
                    btn.classList.add('border-gray-200');
                    btn.querySelector('span').classList.remove('text-govcon-blue');
                    btn.querySelector('span').classList.add('text-gray-700');
                }
            });
        }

        // Profile logo upload handlers (saved to Supabase Storage)
        let profileLogoUrl = null;

        async function handleProfileLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showErrorToast('Please upload an image file');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                showErrorToast('Logo must be under 2MB');
                return;
            }

            // Check if user is authenticated
            const user = SupabaseAuth.user;
            if (!user) {
                showErrorToast('Please sign in to upload a logo');
                return;
            }

            // Show uploading state
            const logoText = document.getElementById('profile-logo-text');
            if (logoText) {
                logoText.textContent = 'Uploading...';
                logoText.classList.remove('text-purple-600', 'text-green-600');
                logoText.classList.add('text-blue-600');
            }

            try {
                // Create unique filename
                const fileExt = file.name.split('.').pop();
                const fileName = `${user.id}/logo.${fileExt}`;

                // Upload to Supabase Storage
                const { data, error } = await SupabaseAuth.client.storage
                    .from('company-logos')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true  // Replace existing logo
                    });

                if (error) {
                    console.error('Upload error:', error);
                    throw new Error(error.message || 'Upload failed');
                }

                // Get public URL
                const { data: urlData } = SupabaseAuth.client.storage
                    .from('company-logos')
                    .getPublicUrl(fileName);

                profileLogoUrl = urlData.publicUrl + '?t=' + Date.now();
                document.getElementById('profile-logo-data').value = profileLogoUrl;

                // Update UI with preview
                const preview = document.getElementById('profile-logo-preview');
                const previewImg = document.getElementById('profile-logo-preview-img');
                const removeBtn = document.getElementById('remove-profile-logo-btn');

                previewImg.src = profileLogoUrl;
                preview.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
                logoText.textContent = 'Logo uploaded!';
                logoText.classList.remove('text-blue-600');
                logoText.classList.add('text-green-600');

                showSuccessToast('Logo uploaded! Click Save Profile to save.');

            } catch (error) {
                console.error('Logo upload error:', error);
                if (logoText) {
                    logoText.textContent = 'Click to upload logo';
                    logoText.classList.remove('text-blue-600');
                    logoText.classList.add('text-purple-600');
                }
                showErrorToast('Failed to upload logo: ' + error.message);
            }
        }

        async function removeProfileLogo() {
            const user = SupabaseAuth.user;

            // Reset UI first
            const preview = document.getElementById('profile-logo-preview');
            const removeBtn = document.getElementById('remove-profile-logo-btn');
            const logoText = document.getElementById('profile-logo-text');
            const input = document.getElementById('profile-logo-upload');

            preview.classList.add('hidden');
            removeBtn.classList.add('hidden');
            logoText.textContent = 'Click to upload logo';
            logoText.classList.remove('text-green-600');
            logoText.classList.add('text-purple-600');
            if (input) input.value = '';

            // Try to delete from storage if user is authenticated
            if (user && profileLogoUrl) {
                try {
                    const fileName = `${user.id}/logo`;
                    // Try common extensions
                    for (const ext of ['png', 'jpg', 'jpeg', 'gif', 'webp']) {
                        await SupabaseAuth.client.storage
                            .from('company-logos')
                            .remove([`${fileName}.${ext}`]);
                    }
                } catch (e) {
                    console.log('Could not delete old logo:', e);
                }
            }

            profileLogoUrl = null;
            document.getElementById('profile-logo-data').value = '';
        }

        function loadProfileLogo(logoUrl) {
            if (!logoUrl) return;

            profileLogoUrl = logoUrl;
            document.getElementById('profile-logo-data').value = logoUrl;

            const preview = document.getElementById('profile-logo-preview');
            const previewImg = document.getElementById('profile-logo-preview-img');
            const removeBtn = document.getElementById('remove-profile-logo-btn');
            const logoText = document.getElementById('profile-logo-text');

            if (preview && previewImg) {
                previewImg.src = logoUrl;
                preview.classList.remove('hidden');
                if (removeBtn) removeBtn.classList.remove('hidden');
                if (logoText) {
                    logoText.textContent = 'Logo uploaded!';
                    logoText.classList.add('text-green-600');
                    logoText.classList.remove('text-purple-600');
                }
            }
        }

        // ========== PROFILE PHOTO UPLOAD ==========
        let profilePhotoUrl = null;

        async function handleProfilePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showErrorToast('Please upload an image file');
                return;
            }
            if (file.size > 2 * 1024 * 1024) {
                showErrorToast('Photo must be under 2MB');
                return;
            }

            const user = SupabaseAuth.user;
            if (!user) {
                showErrorToast('Please sign in to upload a photo');
                return;
            }

            const photoText = document.getElementById('profile-photo-text');
            if (photoText) {
                photoText.textContent = 'Uploading...';
                photoText.classList.remove('text-purple-600', 'text-green-600');
                photoText.classList.add('text-blue-600');
            }

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${user.id}/photo.${fileExt}`;

                const { data, error } = await SupabaseAuth.client.storage
                    .from('company-logos')
                    .upload(fileName, file, { cacheControl: '0', upsert: true });

                if (error) throw new Error(error.message || 'Upload failed');

                const { data: urlData } = SupabaseAuth.client.storage
                    .from('company-logos')
                    .getPublicUrl(fileName);

                profilePhotoUrl = urlData.publicUrl + '?t=' + Date.now();
                document.getElementById('profile-photo-data').value = profilePhotoUrl;

                const preview = document.getElementById('profile-photo-preview');
                const previewImg = document.getElementById('profile-photo-preview-img');
                const removeBtn = document.getElementById('remove-profile-photo-btn');

                previewImg.src = profilePhotoUrl;
                preview.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
                photoText.textContent = 'Photo uploaded!';
                photoText.classList.remove('text-blue-600');
                photoText.classList.add('text-green-600');

                showSuccessToast('Photo uploaded! Click Save Profile to save.');
            } catch (error) {
                console.error('Photo upload error:', error);
                if (photoText) {
                    photoText.textContent = 'Click to upload headshot';
                    photoText.classList.remove('text-blue-600');
                    photoText.classList.add('text-purple-600');
                }
                showErrorToast('Failed to upload photo: ' + error.message);
            }
        }

        function removeProfilePhoto() {
            const preview = document.getElementById('profile-photo-preview');
            const removeBtn = document.getElementById('remove-profile-photo-btn');
            const photoText = document.getElementById('profile-photo-text');
            const input = document.getElementById('profile-photo-upload');

            preview.classList.add('hidden');
            removeBtn.classList.add('hidden');
            photoText.textContent = 'Click to upload headshot';
            photoText.classList.remove('text-green-600');
            photoText.classList.add('text-purple-600');
            if (input) input.value = '';

            profilePhotoUrl = null;
            document.getElementById('profile-photo-data').value = '';
        }

        function loadProfilePhoto(photoUrl) {
            if (!photoUrl) return;

            profilePhotoUrl = photoUrl;
            document.getElementById('profile-photo-data').value = photoUrl;

            const preview = document.getElementById('profile-photo-preview');
            const previewImg = document.getElementById('profile-photo-preview-img');
            const removeBtn = document.getElementById('remove-profile-photo-btn');
            const photoText = document.getElementById('profile-photo-text');

            if (preview && previewImg) {
                previewImg.src = photoUrl;
                preview.classList.remove('hidden');
                if (removeBtn) removeBtn.classList.remove('hidden');
                if (photoText) {
                    photoText.textContent = 'Photo uploaded!';
                    photoText.classList.add('text-green-600');
                    photoText.classList.remove('text-purple-600');
                }
            }
        }

        // Background photo for Photo Quote layout
        let backgroundPhotoUrl = null;

        async function handleBgPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                showErrorToast('Please upload an image file');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                showErrorToast('Background photo must be under 5MB');
                return;
            }

            const user = SupabaseAuth.user;
            if (!user) {
                showErrorToast('Please sign in to upload a photo');
                return;
            }

            const bgText = document.getElementById('bg-photo-text');
            if (bgText) {
                bgText.textContent = 'Uploading...';
                bgText.classList.remove('text-amber-600', 'text-green-600');
                bgText.classList.add('text-blue-600');
            }

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${user.id}/background.${fileExt}`;

                const { data, error } = await SupabaseAuth.client.storage
                    .from('company-logos')
                    .upload(fileName, file, { cacheControl: '0', upsert: true });

                if (error) throw new Error(error.message || 'Upload failed');

                const { data: urlData } = SupabaseAuth.client.storage
                    .from('company-logos')
                    .getPublicUrl(fileName);

                backgroundPhotoUrl = urlData.publicUrl + '?t=' + Date.now();
                document.getElementById('bg-photo-data').value = backgroundPhotoUrl;

                const preview = document.getElementById('bg-photo-preview');
                const previewImg = document.getElementById('bg-photo-preview-img');
                const removeBtn = document.getElementById('remove-bg-photo-btn');

                previewImg.src = backgroundPhotoUrl;
                preview.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
                bgText.textContent = 'Photo uploaded!';
                bgText.classList.remove('text-blue-600');
                bgText.classList.add('text-green-600');

                showSuccessToast('Background photo uploaded! Click Save Profile to save.');
            } catch (error) {
                console.error('Background photo upload error:', error);
                if (bgText) {
                    bgText.textContent = 'Click to upload hero photo';
                    bgText.classList.remove('text-blue-600');
                    bgText.classList.add('text-amber-600');
                }
                showErrorToast('Failed to upload photo: ' + error.message);
            }
        }

        function removeBgPhoto() {
            const preview = document.getElementById('bg-photo-preview');
            const removeBtn = document.getElementById('remove-bg-photo-btn');
            const bgText = document.getElementById('bg-photo-text');
            const input = document.getElementById('bg-photo-upload');

            preview.classList.add('hidden');
            removeBtn.classList.add('hidden');
            bgText.textContent = 'Click to upload hero photo';
            bgText.classList.remove('text-green-600');
            bgText.classList.add('text-amber-600');
            if (input) input.value = '';

            backgroundPhotoUrl = null;
            document.getElementById('bg-photo-data').value = '';
        }

        function loadBgPhoto(photoUrl) {
            if (!photoUrl) return;

            backgroundPhotoUrl = photoUrl;
            document.getElementById('bg-photo-data').value = photoUrl;

            const preview = document.getElementById('bg-photo-preview');
            const previewImg = document.getElementById('bg-photo-preview-img');
            const removeBtn = document.getElementById('remove-bg-photo-btn');
            const bgText = document.getElementById('bg-photo-text');

            if (preview && previewImg) {
                previewImg.src = photoUrl;
                preview.classList.remove('hidden');
                if (removeBtn) removeBtn.classList.remove('hidden');
                if (bgText) {
                    bgText.textContent = 'Photo uploaded!';
                    bgText.classList.add('text-green-600');
                    bgText.classList.remove('text-amber-600');
                }
            }
        }

        // Logo upload handlers for carousel config modal (legacy, will use profile logo)
        let carouselLogoData = null;

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showErrorToast('Please upload an image file');
                return;
            }

            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showErrorToast('Logo must be under 2MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                carouselLogoData = e.target.result;
                document.getElementById('carousel-logo-data').value = carouselLogoData;

                // Show preview
                const preview = document.getElementById('logo-preview');
                const previewImg = document.getElementById('logo-preview-img');
                const removeBtn = document.getElementById('remove-logo-btn');
                const uploadArea = document.getElementById('logo-upload-area');

                previewImg.src = carouselLogoData;
                preview.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
                uploadArea.innerHTML = `
                    <input type="file" id="carousel-logo-upload" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
                    <span class="text-sm text-green-600 font-medium">Logo uploaded!</span>
                    <span class="text-xs text-gray-500 block">Click to change</span>
                `;
            };
            reader.readAsDataURL(file);
        }

        function removeCarouselLogo() {
            carouselLogoData = null;
            document.getElementById('carousel-logo-data').value = '';

            // Reset UI
            const preview = document.getElementById('logo-preview');
            const removeBtn = document.getElementById('remove-logo-btn');
            const uploadArea = document.getElementById('logo-upload-area');

            preview.classList.add('hidden');
            removeBtn.classList.add('hidden');
            uploadArea.innerHTML = `
                <input type="file" id="carousel-logo-upload" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
                <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="text-sm text-gray-500">Click to upload logo</span>
            `;

            // Reset file input
            const input = document.getElementById('carousel-logo-upload');
            if (input) input.value = '';
        }

        // Show carousel generation progress modal
        function showCarouselProgressModal(totalSlides) {
            const existing = document.getElementById('carousel-progress-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'carousel-progress-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 32px 40px; max-width: 420px; width: 90%; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
                    <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #f97316, #ec4899); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <svg width="32" height="32" fill="none" stroke="white" viewBox="0 0 24 24" class="animate-pulse">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <h3 style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0 0 8px 0;">Creating Your Carousel</h3>
                    <p id="progress-status" style="font-size: 15px; color: #6b7280; margin: 0 0 20px 0;">Generating slide content...</p>

                    <!-- Progress Bar -->
                    <div style="background: #e5e7eb; border-radius: 10px; height: 12px; overflow: hidden; margin-bottom: 12px;">
                        <div id="progress-bar" style="background: linear-gradient(135deg, #f97316, #ec4899); height: 100%; width: 10%; transition: width 0.3s ease; border-radius: 10px;"></div>
                    </div>
                    <p id="progress-counter" style="font-size: 14px; font-weight: 600; color: #374151; margin: 0;">0 / ${totalSlides} slides</p>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function updateCarouselProgress(current, total, status) {
            const bar = document.getElementById('progress-bar');
            const counter = document.getElementById('progress-counter');
            const statusEl = document.getElementById('progress-status');

            if (bar) bar.style.width = `${(current / total) * 100}%`;
            if (counter) counter.textContent = `${current} / ${total} slides`;
            if (statusEl && status) statusEl.textContent = status;
        }

        function closeCarouselProgressModal() {
            const modal = document.getElementById('carousel-progress-modal');
            if (modal) modal.remove();
        }

        // Generate carousel from post
        async function generateCarouselFromPost() {
            if (!carouselSourcePost) return;

            const btn = document.getElementById('generate-visual-btn') || document.getElementById('generate-carousel-btn');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating...
                `;
            }

            // IMPORTANT: Read all form values BEFORE closing the modal
            const slideCount = parseInt(document.getElementById('carousel-slide-count').value);
            const theme = document.getElementById('carousel-theme').value;

            // Get focus options
            const focusOptions = {
                hook: document.getElementById('focus-hook').checked,
                solution: document.getElementById('focus-solution').checked,
                proof: document.getElementById('focus-proof').checked,
                cta: document.getElementById('focus-cta').checked
            };

            // Get company info from profile (this is outside the modal, so it's safe)
            const companyName = document.getElementById('company-name')?.value || '';
            const phoneNumber = document.getElementById('phone-number')?.value || '';
            const website = document.getElementById('website')?.value || '';
            const contactInfo = { companyName, phoneNumber, website };

            // Get logo URL - prefer profile logo (saved in brand settings), fallback to carousel modal logo
            const logoData = profileLogoUrl || carouselLogoData || null;

            try {
                // NOW close config modal and show progress modal
                closeCarouselConfigModal();
                showCarouselProgressModal(slideCount);

                updateCarouselProgress(0, slideCount, 'Generating slide content with AI...');

                // Call API to convert post to carousel slides
                const response = await fetch('/api/convert-post-to-carousel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        postContent: carouselSourcePost.content,
                        postTitle: carouselSourcePost.title,
                        slideCount,
                        focusOptions,
                        companyName
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate carousel');
                }

                // Render the carousel slides with progress updates
                let themeConfig = carouselThemes[theme];

                // If "mybrand" is selected, dynamically set colors from profile
                if (theme === 'mybrand') {
                    const brandPrimary = document.getElementById('brand-primary-color')?.value || '#1e3a5f';
                    const brandAccent = document.getElementById('brand-accent-color')?.value || '#c5a028';
                    const brandBg = document.getElementById('brand-bg-color')?.value || '#0d1f33';

                    // Create a lighter version of background for gradient
                    const lightenColor = (hex, percent) => {
                        const num = parseInt(hex.replace('#', ''), 16);
                        const r = Math.min(255, (num >> 16) + Math.floor((255 - (num >> 16)) * percent));
                        const g = Math.min(255, ((num >> 8) & 0x00FF) + Math.floor((255 - ((num >> 8) & 0x00FF)) * percent));
                        const b = Math.min(255, (num & 0x0000FF) + Math.floor((255 - (num & 0x0000FF)) * percent));
                        return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
                    };

                    themeConfig = {
                        name: 'My Brand Colors',
                        bg: `linear-gradient(135deg, ${brandBg} 0%, ${lightenColor(brandBg, 0.2)} 100%)`,
                        text: '#ffffff',
                        accent: brandAccent,
                        secondary: lightenColor(brandAccent, 0.7)
                    };
                }

                carouselSlideImages = await renderCarouselSlidesWithProgress(result.slides, themeConfig, companyName, slideCount, logoData, contactInfo);

                // Close progress modal and show the carousel preview modal
                closeCarouselProgressModal();
                showCarouselPreviewModal(result.slides, themeConfig);

            } catch (error) {
                console.error('Carousel generation error:', error);
                closeCarouselProgressModal();
                showErrorToast(error.message || 'Failed to generate carousel');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        }

        // Render carousel slides with progress updates
        async function renderCarouselSlidesWithProgress(slides, theme, companyName, totalSlides, logoData = null, contactInfo = {}) {
            const images = [];

            // Pre-load logo if provided (with CORS support for cross-origin images)
            let logoImg = null;
            if (logoData) {
                logoImg = await new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';  // Enable CORS for Supabase Storage
                    img.onload = () => resolve(img);
                    img.onerror = (e) => {
                        console.warn('Logo load failed:', e);
                        resolve(null);
                    };
                    img.src = logoData;
                });
            }

            // Check for user's brand colors
            let brandColors = null;
            const useBrandColors = document.getElementById('use-brand-colors')?.checked;
            if (useBrandColors) {
                const primary = document.getElementById('brand-primary-color')?.value;
                const accent = document.getElementById('brand-accent-color')?.value;
                const background = document.getElementById('brand-bg-color')?.value;
                if (primary && accent && background) {
                    brandColors = { primary, accent, background };
                }
            }

            for (let i = 0; i < slides.length; i++) {
                // Update progress
                updateCarouselProgress(i + 1, totalSlides, `Creating slide ${i + 1} of ${totalSlides}...`);

                // Small delay to allow UI to update
                await new Promise(resolve => setTimeout(resolve, 50));

                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = 1350; // 4:5 aspect ratio for LinkedIn
                const ctx = canvas.getContext('2d');

                // Use brand colors if available, otherwise use theme
                let bgColor1, bgColor2, textColor, accentColor, secondaryText;

                if (brandColors) {
                    bgColor1 = brandColors.primary;
                    bgColor2 = adjustColor(brandColors.primary, 30);
                    textColor = isLightColor(brandColors.primary) ? '#1a1a1a' : '#ffffff';
                    accentColor = brandColors.accent;
                    secondaryText = isLightColor(brandColors.primary) ? '#4a4a4a' : 'rgba(255,255,255,0.85)';
                } else {
                    const colors = theme.bg.match(/#[a-fA-F0-9]{6}/g) || ['#1e3a5f', '#2d5a87'];
                    bgColor1 = colors[0];
                    bgColor2 = colors[1] || colors[0];
                    textColor = theme.text;
                    accentColor = theme.accent;
                    secondaryText = theme.secondary || theme.text;
                }

                // Draw background gradient
                const gradient = ctx.createLinearGradient(0, 0, 1080, 1350);
                gradient.addColorStop(0, bgColor1);
                gradient.addColorStop(1, bgColor2);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1080, 1350);

                // ===== GOVCON-THEMED DECORATIVE ELEMENTS =====
                // Top-left corner accent
                ctx.fillStyle = accentColor + '15';
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(350, 0);
                ctx.lineTo(0, 350);
                ctx.closePath();
                ctx.fill();

                // Circuit board pattern
                ctx.strokeStyle = accentColor + '12';
                ctx.fillStyle = accentColor + '20';
                ctx.lineWidth = 2;
                const circuitNodes = [
                    {x: 850, y: 80}, {x: 950, y: 120}, {x: 1020, y: 60},
                    {x: 900, y: 180}, {x: 1000, y: 200}, {x: 820, y: 150}
                ];
                circuitNodes.forEach(node => {
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.beginPath();
                ctx.moveTo(850, 80); ctx.lineTo(950, 120);
                ctx.moveTo(950, 120); ctx.lineTo(1020, 60);
                ctx.moveTo(950, 120); ctx.lineTo(1000, 200);
                ctx.moveTo(850, 80); ctx.lineTo(820, 150);
                ctx.moveTo(820, 150); ctx.lineTo(900, 180);
                ctx.stroke();

                // Stars
                ctx.fillStyle = accentColor + '18';
                const drawStar = (cx, cy, size) => {
                    ctx.beginPath();
                    for (let j = 0; j < 5; j++) {
                        const angle = (j * 4 * Math.PI / 5) - Math.PI / 2;
                        const x = cx + size * Math.cos(angle);
                        const y = cy + size * Math.sin(angle);
                        if (j === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                };
                drawStar(40, 1280, 18);
                drawStar(90, 1300, 12);
                drawStar(130, 1270, 10);

                // Eagle wing silhouette
                ctx.fillStyle = accentColor + '08';
                ctx.beginPath();
                ctx.moveTo(1080, 1150);
                ctx.quadraticCurveTo(950, 1180, 880, 1250);
                ctx.quadraticCurveTo(920, 1280, 980, 1300);
                ctx.quadraticCurveTo(1020, 1280, 1050, 1320);
                ctx.lineTo(1080, 1350);
                ctx.lineTo(1080, 1150);
                ctx.closePath();
                ctx.fill();

                // Grid lines
                ctx.strokeStyle = accentColor + '08';
                ctx.lineWidth = 1;
                for (let y = 400; y < 1100; y += 80) {
                    ctx.beginPath();
                    ctx.moveTo(60, y);
                    ctx.lineTo(1020, y);
                    ctx.stroke();
                }

                // Slide number badge
                ctx.fillStyle = accentColor;
                roundRect(ctx, 60, 50, 100, 50, 25);
                ctx.fill();
                ctx.fillStyle = isLightColor(accentColor) ? '#1a1a1a' : '#ffffff';
                ctx.font = 'bold 24px Inter, system-ui, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${i + 1}/${slides.length}`, 110, 83);
                ctx.textAlign = 'left';

                // Draw logo in top-left (if provided)
                if (logoImg) {
                    const logoMaxWidth = 120;
                    const logoMaxHeight = 60;
                    const logoRatio = logoImg.width / logoImg.height;
                    let logoW, logoH;

                    if (logoRatio > logoMaxWidth / logoMaxHeight) {
                        logoW = logoMaxWidth;
                        logoH = logoMaxWidth / logoRatio;
                    } else {
                        logoH = logoMaxHeight;
                        logoW = logoMaxHeight * logoRatio;
                    }

                    // Position logo top-left with padding (next to slide number badge)
                    const logoX = 180;
                    const logoY = 55;

                    // Draw white background for logo visibility
                    ctx.fillStyle = 'rgba(255,255,255,0.95)';
                    roundRect(ctx, logoX - 10, logoY - 5, logoW + 20, logoH + 10, 8);
                    ctx.fill();

                    ctx.drawImage(logoImg, logoX, logoY, logoW, logoH);
                }

                const slide = slides[i];

                // Text shadow helper
                const drawTextWithShadow = (text, x, y, shadowColor = 'rgba(0,0,0,0.3)') => {
                    ctx.save();
                    ctx.shadowColor = shadowColor;
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                    ctx.fillText(text, x, y);
                    ctx.restore();
                };

                // ===== TITLE - CENTERED, BOLD =====
                ctx.fillStyle = textColor;
                ctx.font = 'bold 68px Inter, system-ui, sans-serif';
                ctx.textAlign = 'center';
                const titleLines = wrapTextWithLimit(ctx, slide.title, 820, 2);
                let yPos = 200;
                titleLines.forEach(line => {
                    drawTextWithShadow(line, 540, yPos); // Centered at 540 (half of 1080)
                    yPos += 90;
                });
                ctx.textAlign = 'left';

                // Accent underline - centered
                const underlineGradient = ctx.createLinearGradient(340, 0, 740, 0);
                underlineGradient.addColorStop(0, accentColor + '00');
                underlineGradient.addColorStop(0.5, accentColor);
                underlineGradient.addColorStop(1, accentColor + '00');
                ctx.fillStyle = underlineGradient;
                ctx.fillRect(340, yPos + 15, 400, 8);

                // ===== CONTENT SECTION =====
                yPos += 80;
                ctx.fillStyle = secondaryText;

                // Check if this is the last slide - show contact info
                const isLastSlide = i === slides.length - 1;

                if (isLastSlide && (contactInfo.companyName || contactInfo.phoneNumber || contactInfo.website)) {
                    // LAST SLIDE - Show Contact Information
                    ctx.textAlign = 'center';

                    // "For more information:" header
                    ctx.font = '38px Inter, system-ui, sans-serif';
                    ctx.fillStyle = secondaryText;
                    drawTextWithShadow('For more information:', 540, yPos, 'rgba(0,0,0,0.15)');
                    yPos += 100;

                    // Company Name - large and bold
                    if (contactInfo.companyName) {
                        ctx.font = 'bold 56px Inter, system-ui, sans-serif';
                        ctx.fillStyle = textColor;
                        drawTextWithShadow(contactInfo.companyName, 540, yPos);
                        yPos += 90;
                    }

                    // Website
                    if (contactInfo.website) {
                        ctx.font = '44px Inter, system-ui, sans-serif';
                        ctx.fillStyle = accentColor;
                        let displayWebsite = contactInfo.website.replace(/^https?:\/\//, '');
                        drawTextWithShadow(displayWebsite, 540, yPos, 'rgba(0,0,0,0.15)');
                        yPos += 80;
                    }

                    // Phone Number
                    if (contactInfo.phoneNumber) {
                        ctx.font = '44px Inter, system-ui, sans-serif';
                        ctx.fillStyle = secondaryText;
                        drawTextWithShadow(contactInfo.phoneNumber, 540, yPos, 'rgba(0,0,0,0.15)');
                    }

                    ctx.textAlign = 'left';
                } else {
                    // REGULAR SLIDE - Show content with bullet support
                    const contentText = slide.content || '';
                    const hasBullets = contentText.includes('') || contentText.includes('- ') || contentText.includes('\n');

                    if (hasBullets) {
                        // Parse bullet points
                        const bulletLines = contentText
                            .split(/\n|(?= )|(?=- )/)
                            .map(line => line.trim())
                            .filter(line => line.length > 0);

                        ctx.font = '42px Inter, system-ui, sans-serif';
                        const bulletIndent = 100;
                        const textIndent = 140;

                        bulletLines.forEach(line => {
                            // Check if this line starts with a bullet
                            const isBullet = line.startsWith('') || line.startsWith('-');
                            const cleanLine = line.replace(/^[\-]\s*/, '');

                            if (isBullet) {
                                // Draw bullet point with accent color
                                ctx.fillStyle = accentColor;
                                ctx.beginPath();
                                ctx.arc(bulletIndent, yPos - 15, 10, 0, Math.PI * 2);
                                ctx.fill();

                                // Draw text
                                ctx.fillStyle = secondaryText;
                                const wrappedBullet = wrapTextWithLimit(ctx, cleanLine, 820, 2);
                                wrappedBullet.forEach((bulletText, idx) => {
                                    drawTextWithShadow(bulletText, textIndent, yPos + (idx * 55), 'rgba(0,0,0,0.15)');
                                });
                                yPos += 55 * Math.max(wrappedBullet.length, 1) + 20;
                            } else {
                                // Regular text line
                                const wrappedLine = wrapTextWithLimit(ctx, cleanLine, 860, 2);
                                wrappedLine.forEach(text => {
                                    drawTextWithShadow(text, 100, yPos, 'rgba(0,0,0,0.15)');
                                    yPos += 55;
                                });
                                yPos += 10;
                            }
                        });
                    } else {
                        // No bullets - render as centered paragraph
                        ctx.font = '46px Inter, system-ui, sans-serif';
                        ctx.textAlign = 'center';
                        const contentLines = wrapTextWithLimit(ctx, contentText, 820, 6);
                        contentLines.forEach(line => {
                            drawTextWithShadow(line, 540, yPos, 'rgba(0,0,0,0.15)');
                            yPos += 65;
                        });
                        ctx.textAlign = 'left';
                    }

                    // Company branding at bottom-right (only on non-last slides)
                    if (companyName) {
                        ctx.textAlign = 'right';
                        ctx.fillStyle = textColor;
                        ctx.font = 'bold 38px Inter, system-ui, sans-serif';
                        drawTextWithShadow(companyName, 980, 1260);
                        const companyWidth = ctx.measureText(companyName).width;
                        ctx.fillStyle = accentColor;
                        ctx.fillRect(980 - companyWidth, 1270, companyWidth, 4);
                        ctx.textAlign = 'left';
                    }
                }

                images.push(canvas.toDataURL('image/png'));
            }

            return images;
        }

        // Render carousel slides to images with brand colors support
        async function renderCarouselSlides(slides, theme, companyName) {
            const images = [];

            // Check for user's brand colors
            let brandColors = null;
            const useBrandColors = document.getElementById('use-brand-colors')?.checked;
            if (useBrandColors) {
                const primary = document.getElementById('brand-primary-color')?.value;
                const accent = document.getElementById('brand-accent-color')?.value;
                const background = document.getElementById('brand-bg-color')?.value;
                if (primary && accent && background) {
                    brandColors = { primary, accent, background };
                }
            }

            for (let i = 0; i < slides.length; i++) {
                const canvas = document.createElement('canvas');
                canvas.width = 1080;
                canvas.height = 1350; // 4:5 aspect ratio for LinkedIn
                const ctx = canvas.getContext('2d');

                // Use brand colors if available, otherwise use theme
                let bgColor1, bgColor2, textColor, accentColor, secondaryText;

                if (brandColors) {
                    bgColor1 = brandColors.primary;
                    bgColor2 = adjustColor(brandColors.primary, 30);
                    textColor = isLightColor(brandColors.primary) ? '#1a1a1a' : '#ffffff';
                    accentColor = brandColors.accent;
                    secondaryText = isLightColor(brandColors.primary) ? '#4a4a4a' : 'rgba(255,255,255,0.85)';
                } else {
                    const colors = theme.bg.match(/#[a-fA-F0-9]{6}/g) || ['#1e3a5f', '#2d5a87'];
                    bgColor1 = colors[0];
                    bgColor2 = colors[1] || colors[0];
                    textColor = theme.text;
                    accentColor = theme.accent;
                    secondaryText = theme.secondary || theme.text;
                }

                // Draw background gradient
                const gradient = ctx.createLinearGradient(0, 0, 1080, 1350);
                gradient.addColorStop(0, bgColor1);
                gradient.addColorStop(1, bgColor2);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 1080, 1350);

                // ===== GOVCON-THEMED DECORATIVE ELEMENTS =====

                // Top-left corner accent with gradient fade
                ctx.fillStyle = accentColor + '15';
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.lineTo(350, 0);
                ctx.lineTo(0, 350);
                ctx.closePath();
                ctx.fill();

                // Circuit board pattern - subtle dots and lines (top right area)
                ctx.strokeStyle = accentColor + '12';
                ctx.fillStyle = accentColor + '20';
                ctx.lineWidth = 2;

                // Circuit nodes (dots)
                const circuitNodes = [
                    {x: 850, y: 80}, {x: 950, y: 120}, {x: 1020, y: 60},
                    {x: 900, y: 180}, {x: 1000, y: 200}, {x: 820, y: 150}
                ];
                circuitNodes.forEach(node => {
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Circuit lines connecting nodes
                ctx.beginPath();
                ctx.moveTo(850, 80); ctx.lineTo(950, 120);
                ctx.moveTo(950, 120); ctx.lineTo(1020, 60);
                ctx.moveTo(950, 120); ctx.lineTo(1000, 200);
                ctx.moveTo(850, 80); ctx.lineTo(820, 150);
                ctx.moveTo(820, 150); ctx.lineTo(900, 180);
                ctx.stroke();

                // Subtle stars - GovCon patriotic touch (3 small stars)
                ctx.fillStyle = accentColor + '18';
                const drawStar = (cx, cy, size) => {
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * 4 * Math.PI / 5) - Math.PI / 2;
                        const x = cx + size * Math.cos(angle);
                        const y = cy + size * Math.sin(angle);
                        if (i === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fill();
                };
                drawStar(40, 1280, 18);
                drawStar(90, 1300, 12);
                drawStar(130, 1270, 10);

                // Eagle wing silhouette (bottom right, subtle)
                ctx.fillStyle = accentColor + '08';
                ctx.beginPath();
                ctx.moveTo(1080, 1150);
                ctx.quadraticCurveTo(950, 1180, 880, 1250);
                ctx.quadraticCurveTo(920, 1280, 980, 1300);
                ctx.quadraticCurveTo(1020, 1280, 1050, 1320);
                ctx.lineTo(1080, 1350);
                ctx.lineTo(1080, 1150);
                ctx.closePath();
                ctx.fill();

                // Subtle horizontal grid lines (tech/blueprint feel)
                ctx.strokeStyle = accentColor + '08';
                ctx.lineWidth = 1;
                for (let y = 400; y < 1100; y += 80) {
                    ctx.beginPath();
                    ctx.moveTo(60, y);
                    ctx.lineTo(1020, y);
                    ctx.stroke();
                }

                // Slide number badge
                ctx.fillStyle = accentColor;
                roundRect(ctx, 60, 50, 100, 50, 25);
                ctx.fill();
                ctx.fillStyle = isLightColor(accentColor) ? '#1a1a1a' : '#ffffff';
                ctx.font = 'bold 24px Inter, system-ui, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${i + 1}/${slides.length}`, 110, 83);
                ctx.textAlign = 'left';

                const slide = slides[i];

                // Add text shadow function for better readability
                const drawTextWithShadow = (text, x, y, shadowColor = 'rgba(0,0,0,0.3)') => {
                    ctx.save();
                    ctx.shadowColor = shadowColor;
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetX = 2;
                    ctx.shadowOffsetY = 2;
                    ctx.fillText(text, x, y);
                    ctx.restore();
                };

                // LARGE TITLE - bold for maximum impact
                ctx.fillStyle = textColor;
                ctx.font = 'bold 68px Inter, system-ui, sans-serif';
                const titleLines = wrapTextWithLimit(ctx, slide.title, 860, 2); // Max 2 lines
                let yPos = 220;
                titleLines.forEach(line => {
                    drawTextWithShadow(line, 80, yPos);
                    yPos += 90;
                });

                // Accent underline - thicker and more prominent
                const underlineGradient = ctx.createLinearGradient(60, 0, 450, 0);
                underlineGradient.addColorStop(0, accentColor);
                underlineGradient.addColorStop(1, accentColor + '00');
                ctx.fillStyle = underlineGradient;
                ctx.fillRect(60, yPos + 10, 400, 10);

                // LARGE CONTENT - for readability
                ctx.fillStyle = secondaryText;
                ctx.font = '46px Inter, system-ui, sans-serif';
                yPos += 80;
                const contentLines = wrapTextWithLimit(ctx, slide.content, 860, 8); // Max 8 lines
                contentLines.forEach(line => {
                    drawTextWithShadow(line, 80, yPos, 'rgba(0,0,0,0.2)');
                    yPos += 65;
                });

                // Company branding at BOTTOM-RIGHT - prominent and professional
                if (companyName) {
                    ctx.textAlign = 'right';

                    // Accent bar at right side
                    ctx.fillStyle = accentColor;
                    ctx.fillRect(984, 1220, 6, 70);

                    // Company name - right-aligned with margin
                    ctx.fillStyle = textColor;
                    ctx.font = 'bold 36px Inter, system-ui, sans-serif';
                    drawTextWithShadow(companyName, 970, 1260);

                    // Subtle tagline
                    ctx.font = '20px Inter, system-ui, sans-serif';
                    ctx.fillStyle = secondaryText;
                    drawTextWithShadow('Government Contracting Excellence', 970, 1288, 'rgba(0,0,0,0.15)');

                    ctx.textAlign = 'left'; // Reset alignment
                }

                images.push(canvas.toDataURL('image/png'));
            }

            return images;
        }

        // Helper: Draw rounded rectangle
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // Helper: Check if color is light
        function isLightColor(color) {
            const hex = color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 128;
        }

        // Helper: Adjust color brightness
        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const r = Math.min(255, Math.max(0, parseInt(hex.substr(0, 2), 16) + amount));
            const g = Math.min(255, Math.max(0, parseInt(hex.substr(2, 2), 16) + amount));
            const b = Math.min(255, Math.max(0, parseInt(hex.substr(4, 2), 16) + amount));
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        // Text wrapping helper with line limit
        function wrapTextWithLimit(ctx, text, maxWidth, maxLines) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            for (const word of words) {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                    if (lines.length >= maxLines) {
                        // Truncate last line with ellipsis
                        let lastLine = lines[lines.length - 1];
                        while (ctx.measureText(lastLine + '...').width > maxWidth && lastLine.length > 0) {
                            lastLine = lastLine.slice(0, -1);
                        }
                        lines[lines.length - 1] = lastLine + '...';
                        return lines;
                    }
                } else {
                    currentLine = testLine;
                }
            }
            if (currentLine && lines.length < maxLines) {
                lines.push(currentLine);
            }

            return lines;
        }

        // Legacy wrapper for backward compatibility
        function wrapText(ctx, text, maxWidth) {
            return wrapTextWithLimit(ctx, text, maxWidth, 20);
        }

        // Show carousel preview modal with Swiper.js
        let carouselSwiper = null;

        function showCarouselPreviewModal(slides, theme) {
            const existing = document.getElementById('carousel-preview-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'carousel-preview-modal';
            // Use inline styles to ensure fullscreen overlay works
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; overflow: hidden;';

            modal.innerHTML = `
                <!-- Header - Carousel Ready with Clear Close -->
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(16,185,129,0.1)); border-bottom: 1px solid rgba(34,197,94,0.3); flex-shrink: 0;">
                    <div style="display: flex; align-items: center; gap: 14px;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #22c55e, #16a34a); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(34,197,94,0.4);">
                            <svg width="24" height="24" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <div>
                            <h3 style="font-size: 1.25rem; font-weight: 700; color: white; margin: 0;">Carousel Ready!</h3>
                            <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 2px 0 0 0;">Download or schedule your ${slides.length}-slide carousel</p>
                        </div>
                    </div>
                    <button onclick="closeCarouselPreviewModal()" style="display: flex; align-items: center; gap: 8px; color: white; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); cursor: pointer; padding: 10px 16px; border-radius: 10px; transition: all 0.2s; font-weight: 600; font-size: 14px;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Close
                    </button>
                </div>

                <!-- Main Content Area - 50/50 Split -->
                <div style="flex: 1; display: flex; min-height: 0; overflow: hidden;">

                    <!-- LEFT 50% - Large Preview -->
                    <div style="width: 50%; display: flex; align-items: center; justify-content: center; padding: 24px; background: #0f172a; position: relative;">
                        <div class="swiper carousel-swiper" style="width: 100%; height: 100%; max-height: calc(100vh - 180px);">
                            <div class="swiper-wrapper">
                                ${carouselSlideImages.map((img, i) => `
                                    <div class="swiper-slide" style="display: flex; align-items: center; justify-content: center; height: 100%; position: relative;">
                                        <img src="${img}" style="max-height: 100%; max-width: 100%; width: auto; height: auto; object-fit: contain; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);" alt="Slide ${i + 1}">
                                    </div>
                                `).join('')}
                            </div>
                            <!-- Navigation Arrows on Preview -->
                            <div class="swiper-button-prev" style="color: white; width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; backdrop-filter: blur(8px); left: 20px;"></div>
                            <div class="swiper-button-next" style="color: white; width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; backdrop-filter: blur(8px); right: 20px;"></div>
                        </div>
                        <!-- Slide Counter Overlay -->
                        <div id="slide-counter-overlay" style="position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 24px; border-radius: 25px; font-weight: 600; font-size: 16px; backdrop-filter: blur(8px);">
                            Slide 1 of ${slides.length}
                        </div>
                    </div>

                    <!-- RIGHT 50% - Controls & Actions -->
                    <div style="width: 50%; display: flex; flex-direction: column; background: #1e293b; overflow-y: auto;">

                        <!-- Thumbnail Strip -->
                        <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <p style="color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 12px; font-weight: 500;">Click to preview slide:</p>
                            <div class="carousel-thumbnails" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px;">
                                ${carouselSlideImages.map((img, i) => `
                                    <div class="carousel-thumb ${i === 0 ? 'active' : ''}" data-slide="${i}" style="width: 100px; height: 125px; border-radius: 8px; overflow: hidden; border: 3px solid ${i === 0 ? '#22c55e' : 'transparent'}; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; flex-shrink: 0;">
                                        <img src="${img}" style="width: 100%; height: 100%; object-fit: cover;" alt="Slide ${i + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Navigation Controls -->
                        <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                                <button class="nav-prev-btn" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                                </button>
                                <span id="swiper-fraction-counter" style="color: white; font-size: 20px; font-weight: 700; min-width: 80px; text-align: center;">
                                    1 / ${slides.length}
                                </span>
                                <button class="nav-next-btn" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                                </button>
                            </div>
                            <div class="swiper-pagination carousel-pagination" style="margin-top: 16px;"></div>
                        </div>

                        <!-- Export Actions -->
                        <div style="padding: 20px; flex: 1;">
                            <!-- Primary Download -->
                            <div style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 12px;">
                                <button onclick="downloadCarouselFromPostPNGs()" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding: 20px 16px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.2s; box-shadow: 0 8px 20px -5px rgba(249,115,22,0.4);">
                                    <svg width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <span>Download ${slides.length} Slide Images</span>
                                    <span style="font-size: 10px; font-weight: 400; opacity: 0.9;">PNG files for LinkedIn carousel post</span>
                                </button>
                            </div>

                            <!-- Secondary Actions -->
                            <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                                <button onclick="scheduleCarouselFromPost(${slides.length})" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 16px; background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s; box-shadow: 0 6px 16px -4px rgba(236,72,153,0.4);">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <span>Schedule</span>
                                </button>
                            </div>

                            <p style="color: rgba(255,255,255,0.4); text-align: center; font-size: 11px; margin-top: 16px;">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline; vertical-align: middle; margin-right: 4px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Upload images to LinkedIn  Select all slides when creating your post
                            </p>
                        </div>
                    </div>
                </div>

                <style>
                    #carousel-preview-modal * { box-sizing: border-box; }

                    /* Pulse animation for ready indicator */
                    @keyframes pulse {
                        0%, 100% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.7; transform: scale(1.1); }
                    }

                    /* Navigation arrows */
                    .carousel-swiper .swiper-button-prev,
                    .carousel-swiper .swiper-button-next {
                        --swiper-navigation-size: 22px;
                        transition: all 0.2s ease;
                    }
                    .carousel-swiper .swiper-button-prev:hover,
                    .carousel-swiper .swiper-button-next:hover {
                        background: rgba(255,255,255,0.3) !important;
                        transform: scale(1.05);
                    }

                    /* Pagination dots - larger and animated */
                    .carousel-pagination {
                        position: relative !important;
                        bottom: auto !important;
                    }
                    .carousel-pagination .swiper-pagination-bullet {
                        width: 14px;
                        height: 14px;
                        background: rgba(255,255,255,0.25);
                        opacity: 1;
                        margin: 0 8px !important;
                        transition: all 0.3s ease;
                        cursor: pointer;
                    }
                    .carousel-pagination .swiper-pagination-bullet:hover {
                        background: rgba(255,255,255,0.5);
                        transform: scale(1.1);
                    }
                    .carousel-pagination .swiper-pagination-bullet-active {
                        background: white;
                        width: 40px;
                        border-radius: 7px;
                        box-shadow: 0 0 10px rgba(255,255,255,0.5);
                    }

                    /* Secondary nav buttons */
                    .nav-prev-btn:hover, .nav-next-btn:hover {
                        background: rgba(255,255,255,0.2) !important;
                        transform: scale(1.05);
                    }

                    /* Slide number overlay styling */
                    .slide-number-overlay {
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    }

                    /* Export button hover effects */
                    .export-btn-primary:hover,
                    .export-btn-secondary:hover {
                        transform: translateY(-2px) scale(1.02);
                        box-shadow: 0 15px 40px -5px currentColor;
                    }
                    .export-btn-tertiary:hover {
                        transform: translateY(-2px);
                    }

                    /* Tooltip hover effect */
                    .tooltip-wrapper:hover .tooltip {
                        opacity: 1 !important;
                    }

                    /* Thumbnail sidebar styles */
                    .carousel-thumbnails {
                        scrollbar-width: thin;
                        scrollbar-color: rgba(255,255,255,0.3) transparent;
                    }
                    .carousel-thumbnails::-webkit-scrollbar {
                        width: 6px;
                    }
                    .carousel-thumbnails::-webkit-scrollbar-track {
                        background: transparent;
                    }
                    .carousel-thumbnails::-webkit-scrollbar-thumb {
                        background: rgba(255,255,255,0.3);
                        border-radius: 3px;
                    }
                    .carousel-thumb {
                        transition: all 0.3s ease !important;
                    }
                    .carousel-thumb:hover {
                        border-color: rgba(34, 197, 94, 0.5) !important;
                        transform: scale(1.02) !important;
                    }
                    .carousel-thumb.active {
                        border-color: #22c55e !important;
                        transform: scale(1.05) !important;
                        box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3) !important;
                    }

                    @media (max-width: 768px) {
                        #carousel-preview-modal > div:last-child > div > div {
                            grid-template-columns: 1fr !important;
                        }
                        .carousel-swiper .swiper-button-prev,
                        .carousel-swiper .swiper-button-next {
                            display: none !important;
                        }
                        .carousel-thumbnails {
                            display: none !important;
                        }
                        .tooltip {
                            display: none !important;
                        }
                    }
                </style>
            `;

            document.body.appendChild(modal);

            // Initialize main Swiper carousel
            carouselSwiper = new Swiper('.carousel-swiper', {
                slidesPerView: 1,
                spaceBetween: 30,
                centeredSlides: true,
                loop: false,
                effect: 'slide',
                speed: 300,
                keyboard: {
                    enabled: true,
                },
                pagination: {
                    el: '.carousel-pagination',
                    clickable: true,
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                on: {
                    slideChange: function() {
                        // Update fraction counter
                        const counter = document.getElementById('swiper-fraction-counter');
                        if (counter) {
                            counter.textContent = `${this.activeIndex + 1} / ${slides.length}`;
                        }
                        // Update slide counter overlay on preview
                        const overlay = document.getElementById('slide-counter-overlay');
                        if (overlay) {
                            overlay.textContent = `Slide ${this.activeIndex + 1} of ${slides.length}`;
                        }
                        // Sync thumbnails
                        updateThumbnailActive(this.activeIndex);
                    }
                }
            });

            // Function to update thumbnail active state
            function updateThumbnailActive(activeIdx) {
                const thumbs = modal.querySelectorAll('.carousel-thumb');
                thumbs.forEach((thumb, i) => {
                    if (i === activeIdx) {
                        thumb.classList.add('active');
                        thumb.style.borderColor = '#22c55e';
                        thumb.style.transform = 'scale(1.05)';
                        // Scroll thumbnail into view
                        thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        thumb.classList.remove('active');
                        thumb.style.borderColor = 'transparent';
                        thumb.style.transform = 'scale(1)';
                    }
                });
            }

            // Add click handlers to thumbnails
            const thumbs = modal.querySelectorAll('.carousel-thumb');
            thumbs.forEach((thumb, i) => {
                thumb.addEventListener('click', () => {
                    carouselSwiper.slideTo(i);
                });
            });

            // Connect secondary nav buttons to swiper
            const prevBtn = modal.querySelector('.nav-prev-btn');
            const nextBtn = modal.querySelector('.nav-next-btn');
            if (prevBtn) prevBtn.addEventListener('click', () => carouselSwiper.slidePrev());
            if (nextBtn) nextBtn.addEventListener('click', () => carouselSwiper.slideNext());

            // Close on backdrop click (only if clicking the modal itself)
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeCarouselPreviewModal();
            });

            // Close on Escape key
            document.addEventListener('keydown', handleCarouselEscape);
        }

        function handleCarouselEscape(e) {
            if (e.key === 'Escape') {
                closeCarouselPreviewModal();
            }
        }

        function closeCarouselPreviewModal() {
            const modal = document.getElementById('carousel-preview-modal');
            if (modal) {
                modal.remove();
                if (carouselSwiper) {
                    carouselSwiper.destroy();
                    carouselSwiper = null;
                }
            }
            document.removeEventListener('keydown', handleCarouselEscape);
        }

        // Get a clean filename from the post title
        function getCarouselFilename() {
            // Try to get title from the source post
            let title = carouselSourcePost?.title || '';

            // If no title, extract first line or first few words from content
            if (!title && carouselSourcePost?.content) {
                const firstLine = carouselSourcePost.content.split('\n')[0];
                title = firstLine.substring(0, 50);
            }

            // Default fallback
            if (!title) title = 'LinkedIn-Carousel';

            // Sanitize: remove special chars, replace spaces with hyphens, limit length
            return title
                .replace(/[^a-zA-Z0-9\s]/g, '')
                .trim()
                .replace(/\s+/g, '-')
                .substring(0, 50)
                .replace(/-+$/, ''); // Remove trailing hyphens
        }

        // Download carousel as PDF (A4 landscape for better LinkedIn upload)
        function downloadCarouselFromPostPDF() {
            try {
                const { jsPDF } = window.jspdf;

                // A4 landscape dimensions in points (pt)
                // A4 = 595.28 x 841.89 pt, landscape = 841.89 x 595.28 pt
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'pt',
                    format: 'a4'
                });

                const pageWidth = pdf.internal.pageSize.getWidth();   // 841.89
                const pageHeight = pdf.internal.pageSize.getHeight(); // 595.28

                // Original slide aspect ratio is 4:5 (1080x1350)
                // Calculate image dimensions to fit within page while maintaining aspect ratio
                const slideRatio = 1080 / 1350; // 0.8 (width/height)
                let imgWidth, imgHeight;

                // Fit to page height, then calculate width
                imgHeight = pageHeight - 40; // Leave 20pt margin top/bottom
                imgWidth = imgHeight * slideRatio;

                // Center horizontally on page
                const xOffset = (pageWidth - imgWidth) / 2;
                const yOffset = 20; // 20pt top margin

                carouselSlideImages.forEach((imgUrl, i) => {
                    if (i > 0) {
                        pdf.addPage('a4', 'landscape');
                    }
                    pdf.addImage(imgUrl, 'PNG', xOffset, yOffset, imgWidth, imgHeight);
                });

                const filename = `${getCarouselFilename()}.pdf`;
                pdf.save(filename);
                showSuccessToast('PDF downloaded! Upload to LinkedIn as a document.');
            } catch (error) {
                console.error('PDF generation error:', error);
                showErrorToast('Failed to generate PDF. Try downloading PNGs instead.');
            }
        }

        // Download carousel as PNGs
        function downloadCarouselFromPostPNGs() {
            const baseName = getCarouselFilename();
            carouselSlideImages.forEach((imgUrl, i) => {
                const link = document.createElement('a');
                link.download = `${baseName}-slide-${i + 1}.png`;
                link.href = imgUrl;
                link.click();
            });
            showSuccessToast(`Downloaded ${carouselSlideImages.length} slides! Upload all images to LinkedIn to create your carousel.`);
        }

        // Compress image to reduce payload size
        async function compressImage(base64Image, quality = 0.7, maxWidth = 1200) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Scale down if too large
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to JPEG for better compression
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = base64Image;
            });
        }

        // Save carousel to library
        async function saveCarouselToLibrary() {
            if (!carouselSlideImages || carouselSlideImages.length === 0) {
                showErrorToast('No carousel to save');
                return;
            }

            const user = SupabaseAuth.user;
            if (!user) {
                showErrorToast('Please sign in to save carousels');
                return;
            }

            // Show saving state
            const saveBtn = document.querySelector('[onclick="saveCarouselToLibrary()"]');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Saving...';
            }

            try {
                // Create carousel title
                let title = carouselSourcePost?.title || '';
                if (!title && carouselSourcePost?.content) {
                    const firstLine = carouselSourcePost.content.split('\n')[0];
                    title = firstLine.replace(/[*#]/g, '').trim().substring(0, 50);
                }
                title = title || 'LinkedIn Carousel';

                // Compress images to reduce payload size (Vercel has 4.5MB limit)
                console.log('[Carousel Save] Compressing images...');
                const compressedImages = await Promise.all(
                    carouselSlideImages.map(img => compressImage(img, 0.8, 1200))
                );
                console.log('[Carousel Save] Original size:', Math.round(JSON.stringify(carouselSlideImages).length / 1024), 'KB');
                console.log('[Carousel Save] Compressed size:', Math.round(JSON.stringify(compressedImages).length / 1024), 'KB');

                // Use server-side upload (bypasses RLS)
                const response = await fetch('/api/upload-carousel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...SupabaseAuth.getAuthHeaders()
                    },
                    body: JSON.stringify({
                        images: compressedImages,
                        title: `[Carousel] ${title}`,
                        content: carouselSourcePost?.content || '',
                        tags: ['carousel', `${carouselSlideImages.length}-slides`]
                    })
                });

                // Check for HTTP errors
                if (!response.ok) {
                    const text = await response.text();
                    console.error('[Carousel Save] HTTP Error:', response.status, text.substring(0, 200));
                    throw new Error(`Upload failed (${response.status})`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to save carousel');
                }

                showSuccessToast(`Carousel saved to library! (${carouselSlideImages.length} slides)`);

                // Update button to show saved state
                if (saveBtn) {
                    saveBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Saved!';
                    saveBtn.classList.remove('from-green-500', 'to-green-600');
                    saveBtn.classList.add('from-emerald-400', 'to-emerald-500');
                }

            } catch (error) {
                console.error('Save carousel error:', error);
                showErrorToast('Failed to save carousel: ' + error.message);

                // Reset button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg><span>Save to Library</span>';
                }
            }
        }

        // Schedule carousel - shows a quick scheduling modal
        function scheduleCarouselFromPost(slideCount) {
            const today = new Date();
            const dates = [
                { label: 'Tomorrow', date: new Date(today.getTime() + 24 * 60 * 60 * 1000) },
                { label: 'In 2 days', date: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000) },
                { label: 'Next Week', date: new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000) },
            ];

            // Set default time to 9:00 AM
            dates.forEach(d => {
                d.date.setHours(9, 0, 0, 0);
            });

            // Store carousel info for scheduling
            window.carouselToSchedule = {
                slideCount: slideCount || carouselSlideImages.length,
                images: carouselSlideImages,
                sourcePost: carouselSourcePost
            };

            // Create scheduling modal
            const modal = document.createElement('div');
            modal.id = 'carousel-schedule-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';

            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #ec4899, #db2777); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 style="font-size: 18px; font-weight: 700; color: #1f2937; margin: 0;">Schedule Carousel</h3>
                            <p style="font-size: 14px; color: #6b7280; margin: 4px 0 0 0;">Carousel post  ${slideCount || carouselSlideImages.length} slides</p>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                        ${dates.map((d, i) => `
                            <button onclick="scheduleCarouselQuick('${d.date.toISOString()}')" style="width: 100%; padding: 14px 16px; text-align: left; border-radius: 10px; border: 1px solid #e5e7eb; background: white; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;" onmouseover="this.style.borderColor='#ec4899'; this.style.background='#fdf2f8'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                <span style="font-weight: 600; color: #1f2937;">${d.label}</span>
                                <span style="font-size: 13px; color: #6b7280;">${d.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} at 9:00 AM</span>
                            </button>
                        `).join('')}
                    </div>

                    <div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-bottom: 16px;">
                        <label style="display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 8px;">Or pick a custom date & time:</label>
                        <input type="datetime-local" id="carousel-schedule-datetime" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button onclick="closeCarouselScheduleModal()" style="flex: 1; padding: 12px; background: #f3f4f6; color: #374151; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">Cancel</button>
                        <button onclick="scheduleCarouselCustom()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ec4899, #db2777); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">Schedule</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeCarouselScheduleModal();
            });
        }

        function closeCarouselScheduleModal() {
            const modal = document.getElementById('carousel-schedule-modal');
            if (modal) modal.remove();
        }

        async function scheduleCarouselQuick(dateStr) {
            await scheduleCarousel(new Date(dateStr));
        }

        async function scheduleCarouselCustom() {
            const dateInput = document.getElementById('carousel-schedule-datetime');
            if (!dateInput.value) {
                showInfoToast('Please select a date and time');
                return;
            }
            await scheduleCarousel(new Date(dateInput.value));
        }

        async function scheduleCarousel(scheduledDate) {
            const carousel = window.carouselToSchedule;
            if (!carousel) return;

            try {
                // Save to scheduled_posts with carousel type
                // Note: metadata column doesn't exist, so we include slide count in title
                const { error } = await SupabaseAuth.safeInsert('scheduled_posts', {
                    title: `Carousel post  ${carousel.slideCount} slides`,
                    content: carousel.sourcePost?.content || 'LinkedIn carousel post',
                    scheduled_at: scheduledDate.toISOString(),
                    status: 'scheduled',
                    post_type: 'carousel'
                });

                if (error) throw error;

                closeCarouselScheduleModal();
                closeCarouselPreviewModal();

                showSuccessToast(`Carousel scheduled for ${scheduledDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} at ${scheduledDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`);

                // Update scheduled count
                loadScheduledPostsCount();
            } catch (error) {
                console.error('Schedule carousel error:', error);
                showErrorToast('Error scheduling carousel. Please try again.');
            }
        }

        // Success toast notification
        // Styled toast notification system
        function createStyledToast(message, type = 'success') {
            // Remove any existing toast
            const existingToast = document.getElementById('styled-toast');
            if (existingToast) existingToast.remove();

            const configs = {
                success: {
                    bg: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                    icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>`,
                    shadow: 'rgba(34, 197, 94, 0.4)'
                },
                error: {
                    bg: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                    icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>`,
                    shadow: 'rgba(239, 68, 68, 0.4)'
                },
                info: {
                    bg: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                    icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>`,
                    shadow: 'rgba(59, 130, 246, 0.4)'
                }
            };

            const config = configs[type] || configs.success;

            const toast = document.createElement('div');
            toast.id = 'styled-toast';
            toast.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                background: ${config.bg};
                color: white;
                padding: 16px 20px;
                border-radius: 16px;
                box-shadow: 0 20px 40px -10px ${config.shadow}, 0 10px 20px -5px rgba(0,0,0,0.2);
                z-index: 99999;
                display: flex;
                align-items: center;
                gap: 14px;
                max-width: 400px;
                backdrop-filter: blur(10px);
                transform: translateX(120%);
                transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                font-family: Inter, system-ui, sans-serif;
            `;

            toast.innerHTML = `
                <div style="width: 42px; height: 42px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        ${config.icon}
                    </svg>
                </div>
                <span style="font-weight: 500; font-size: 15px; line-height: 1.4; flex: 1;">${message}</span>
                <button onclick="this.parentElement.remove()" style="background: rgba(255,255,255,0.2); border: none; border-radius: 8px; padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <svg width="18" height="18" fill="none" stroke="white" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;

            document.body.appendChild(toast);

            // Slide in animation
            requestAnimationFrame(() => {
                toast.style.transform = 'translateX(0)';
            });

            // Auto-dismiss
            const duration = type === 'error' ? 6000 : 4000;
            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        function showSuccessToast(message) {
            createStyledToast(message, 'success');
        }

        function showErrorToast(message) {
            createStyledToast(message, 'error');
        }

        function showInfoToast(message) {
            createStyledToast(message, 'info');
        }

        async function schedulePostQuick(dateStr) {
            await schedulePost(new Date(dateStr));
        }

        async function schedulePostCustom() {
            const dateInput = document.getElementById('custom-schedule-date');
            if (!dateInput.value) {
                showInfoToast('Please select a date');
                return;
            }
            await schedulePost(new Date(dateInput.value));
        }

        async function schedulePost(scheduledDate) {
            const post = window.postToSchedule;
            if (!post) return;

            try {
                // Use safeInsert - bulletproof user_id validation
                const { error } = await SupabaseAuth.safeInsert('scheduled_posts', {
                    title: post.title || `Post ${post.index + 1}`,
                    content: post.content,
                    scheduled_at: scheduledDate.toISOString(),
                    status: 'scheduled',
                    post_type: 'linkedin'
                });

                if (error) throw error;

                closeQuickScheduleModal();

                // Update Schedule button to "Scheduled"
                const scheduleBtn = document.getElementById(`schedule-btn-${post.index}`);
                if (scheduleBtn) {
                    scheduleBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Scheduled';
                    scheduleBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    scheduleBtn.classList.add('bg-emerald-500');
                    scheduleBtn.disabled = true;
                }

                showSuccessToast(`Post scheduled for ${scheduledDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} at ${scheduledDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`);

                // Update scheduled count
                loadScheduledPostsCount();
            } catch (error) {
                console.error('Schedule error:', error);
                showErrorToast('Error scheduling post. Please try again.');
            }
        }

        // Regenerate a single post
        async function regeneratePost(index) {
            // For now, just scroll to quick generate
            document.getElementById('quick-generate-section').scrollIntoView({ behavior: 'smooth' });
            showInfoToast('Click "Generate" to create new posts with different styles!');
        }

        // ============================================
        // USER PREFERENCES
        // ============================================

        // Default preferences
        const defaultPreferences = {
            default_posts: 3,
            content_style: 'mixed',
            geo_boost: true,
            govcon_ai: true
        };

        // Load user preferences from profile or localStorage
        function loadUserPreferences() {
            const profile = SupabaseAuth.profile;
            // Try Supabase first, then localStorage, then defaults
            let prefs = profile?.preferences;
            if (!prefs) {
                const stored = localStorage.getItem('gcg_preferences');
                prefs = stored ? JSON.parse(stored) : defaultPreferences;
            }

            // Apply to Quick Generate UI
            const numPostsEl = document.getElementById('quick-num-posts');
            const styleEl = document.getElementById('quick-content-style');
            const geoEl = document.getElementById('quick-geo-boost');
            const aiEl = document.getElementById('quick-fine-tuned');

            if (numPostsEl) numPostsEl.value = prefs.default_posts || 3;
            if (styleEl) styleEl.value = prefs.content_style || 'mixed';
            if (geoEl) geoEl.checked = prefs.geo_boost !== false;
            if (aiEl) aiEl.checked = prefs.govcon_ai !== false;

            // Update button text
            const countEl = document.getElementById('quick-post-count');
            if (countEl) countEl.textContent = prefs.default_posts || 3;

            console.log('Loaded preferences:', prefs);
        }

        // Save user preferences to localStorage and Supabase
        async function saveUserPreferences() {
            const prefs = {
                default_posts: parseInt(document.getElementById('quick-num-posts')?.value || 3),
                content_style: document.getElementById('quick-content-style')?.value || 'mixed',
                geo_boost: document.getElementById('quick-geo-boost')?.checked !== false,
                govcon_ai: document.getElementById('quick-fine-tuned')?.checked !== false
            };

            // Always save to localStorage (instant, reliable)
            localStorage.setItem('gcg_preferences', JSON.stringify(prefs));
            console.log('Preferences saved to localStorage:', prefs);

            // Also try to save to Supabase (for cross-device sync)
            // Note: This requires a 'preferences' JSONB column in user_profiles table
            try {
                if (SupabaseAuth?.user?.id) {
                    const userId = SupabaseAuth.getValidatedUserId();
                    const { error } = await SupabaseAuth.client
                        .from('user_profiles')
                        .update({ preferences: prefs })
                        .eq('user_id', userId);
                    if (error) {
                        // Column might not exist - that's okay, localStorage is primary
                        console.log('Supabase preferences sync skipped:', error.message);
                    }
                }
            } catch (error) {
                // Silently fail - localStorage is the primary storage
                console.log('Supabase preferences sync skipped:', error.message);
            }
        }

        // Setup preference auto-save listeners
        function setupPreferenceListeners() {
            const elements = [
                'quick-num-posts',
                'quick-content-style',
                'quick-geo-boost',
                'quick-fine-tuned'
            ];

            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', () => {
                        // Update button text for post count
                        if (id === 'quick-num-posts') {
                            document.getElementById('quick-post-count').textContent = el.value;
                        }
                        // Debounced save
                        clearTimeout(window.prefSaveTimeout);
                        window.prefSaveTimeout = setTimeout(saveUserPreferences, 1000);
                    });
                }
            });
        }

        // Generate 30-day content calendar
        async function generate30DayCalendar() {
            closeWelcomeModal();

            // Check if SupabaseAuth is available
            if (typeof SupabaseAuth === 'undefined') {
                alert('Authentication service not loaded. Please refresh the page.');
                return;
            }

            // Check if user is authenticated
            if (!SupabaseAuth.user?.id) {
                alert('Please sign in to generate your 30-day calendar.');
                window.location.href = getAppUrl('auth.html');
                return;
            }

            // VALIDATE BEFORE SHOWING MODAL
            const supabaseProfile = SupabaseAuth.profile;
            const formData = getCompanyProfile();

            const companyName = supabaseProfile?.company_name || formData.companyName;
            const coreServices = supabaseProfile?.core_services || formData.coreServices;
            const naicsCodes = supabaseProfile?.naics_codes || (formData.naicsCodes ? formData.naicsCodes.split(',').map(s => s.trim()).filter(Boolean) : []);
            const differentiators = supabaseProfile?.differentiators || formData.differentiators || '';
            const certifications = supabaseProfile?.certifications || (formData.certifications ? formData.certifications.split(',').map(s => s.trim()).filter(Boolean) : []);
            const contractVehicles = supabaseProfile?.contract_vehicles || (formData.contractVehicles ? formData.contractVehicles.split(',').map(s => s.trim()).filter(Boolean) : []);
            const businessFormation = supabaseProfile?.business_type || formData.businessFormation || '';

            // Validate required fields BEFORE showing modal
            if (!companyName) {
                showInfoToast('Please enter your company name first');
                document.getElementById('company-name')?.focus();
                return;
            }
            if (!coreServices) {
                showInfoToast('Please enter your core services/capabilities first');
                document.getElementById('core-services')?.focus();
                return;
            }
            if (!naicsCodes.length) {
                showInfoToast('Please enter at least one NAICS code first');
                document.getElementById('naics-codes')?.focus();
                return;
            }

            // Show progress modal early
            const progressModal = document.getElementById('generation-progress-modal');
            progressModal.classList.remove('hidden');
            progressModal.classList.add('flex');

            const progressText = document.getElementById('generation-progress-text');
            const progressBar = document.getElementById('generation-progress-bar');
            const progressCount = document.getElementById('generation-count');

            // Check for agencies - auto-find if needed
            let agencies = foundAgencies.slice(0, 15);
            if (!agencies.length && naicsCodes.length) {
                try {
                    progressText.textContent = 'Finding target agencies...';
                    progressBar.style.width = '10%';

                    const agencyResponse = await fetch('/api/agencies/lookup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            naicsCodes: naicsCodes,
                            businessFormation: businessFormation || ''
                        })
                    });
                    const agencyResult = await agencyResponse.json();
                    if (agencyResult.success && agencyResult.agencies?.length) {
                        agencies = agencyResult.agencies.slice(0, 15);
                        foundAgencies = agencies;
                    }
                } catch (e) {
                    console.error('Error finding agencies:', e);
                }
            }

            // If still no agencies, use defaults
            if (!agencies.length) {
                agencies = [
                    { name: 'Department of Defense' },
                    { name: 'Department of Homeland Security' },
                    { name: 'General Services Administration' }
                ];
            }

            console.log('[30-Day] Starting generation for user:', SupabaseAuth.user.id);
            console.log('[30-Day] Company:', companyName);
            console.log('[30-Day] Agencies:', agencies.map(a => a.name || a));

            try {
                progressText.textContent = 'Generating your content (this takes 15-30 seconds)...';
                progressBar.style.width = '30%';

                const generateResponse = await fetch('/api/generate-30day', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...SupabaseAuth.getAuthHeaders()
                    },
                    body: JSON.stringify({
                        profile: {
                            companyName: companyName,
                            coreServices: coreServices,
                            differentiators: differentiators,
                            certifications: Array.isArray(certifications) ? certifications.join(', ') : certifications,
                            contractVehicles: Array.isArray(contractVehicles) ? contractVehicles.join(', ') : contractVehicles,
                            businessFormation: businessFormation
                        },
                        agencies: agencies.map(a => a.name),
                        userId: SupabaseAuth.user.id
                    })
                });

                const result = await generateResponse.json();
                console.log('[30-Day] Response:', result);

                if (result.success) {
                    progressBar.style.width = '100%';
                    progressText.textContent = `Created ${result.postsCreated} posts! Redirecting...`;
                    progressCount.textContent = `${result.postsCreated} posts created`;

                    setTimeout(() => {
                        window.location.href = '/library';
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to generate posts');
                }

            } catch (error) {
                console.error('Error generating calendar:', error);
                progressModal.classList.add('hidden');
                progressModal.classList.remove('flex');
                showErrorToast('Error generating calendar: ' + error.message);
            }
        }

        // Manual save profile with user feedback
        async function saveProfileManually() {
            const btn = document.getElementById('save-profile-btn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<svg class="w-3.5 h-3.5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Saving...';
            btn.disabled = true;

            const success = await saveCompanyProfile(false);

            if (success) {
                btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Saved!';

                // Update the profile card summary
                updateProfileCardSummary();

                // Enable generate button and update form validation
                checkFormValidity();

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    // Scroll to the Find Target Agencies button
                    const findAgenciesBtn = document.getElementById('find-agencies-btn');
                    if (findAgenciesBtn) {
                        findAgenciesBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Highlight the button briefly
                        findAgenciesBtn.classList.add('ring-4', 'ring-govcon-gold', 'ring-opacity-75');
                        setTimeout(() => {
                            findAgenciesBtn.classList.remove('ring-4', 'ring-govcon-gold', 'ring-opacity-75');
                        }, 2000);
                    }
                }, 1000);
            } else {
                btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> Error - Try Again';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700');
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Update profile card summary after save
        function updateProfileCardSummary() {
            const profile = getCompanyProfile();
            const cardName = document.getElementById('card-company-name');
            const cardSummary = document.getElementById('card-summary');

            if (cardName && profile.companyName) {
                cardName.textContent = profile.companyName;
            }

            if (cardSummary) {
                const summaryParts = [];
                if (profile.naicsCodes) summaryParts.push(`NAICS: ${profile.naicsCodes.split(',')[0]}`);
                if (profile.businessFormation) summaryParts.push(profile.businessFormation.replace(/-/g, ' '));
                cardSummary.textContent = summaryParts.join('  ') || 'Click to expand and edit';
            }
        }

        // Save company profile to Supabase
        async function saveCompanyProfile(showWelcome = false) {
            const formProfile = getCompanyProfile();

            // Check if this is the first complete profile save
            const existingProfile = SupabaseAuth.profile;
            const isFirstCompleteSave = !existingProfile?.company_name || !existingProfile?.core_services;

            // Get brand colors (Full Fix feature)
            const brandColors = {
                primary: document.getElementById('brand-primary-color')?.value || '#1e3a5f',
                accent: document.getElementById('brand-accent-color')?.value || '#c5a028',
                background: document.getElementById('brand-bg-color')?.value || '#0d1f33',
                enabled: document.getElementById('use-brand-colors')?.checked || false,
                logo_url: profileLogoUrl || null,  // Store URL from Supabase Storage
                photo_url: profilePhotoUrl || null,  // Profile photo for avatar circles
                background_photo_url: backgroundPhotoUrl || null,  // Hero photo for Photo Quote background
                tagline: document.getElementById('profile-tagline')?.value?.trim() || null,  // Tagline for Photo Quote
                display_name: document.getElementById('display-name')?.value?.trim() || null  // Person's name for quote graphics
            };

            const profileData = {
                company_name: formProfile.companyName,
                role_title: formProfile.userRole,
                phone_number: formProfile.phoneNumber,
                website: formProfile.website,
                naics_codes: formProfile.naicsCodes ? formProfile.naicsCodes.split(',').map(s => s.trim()).filter(Boolean) : [],
                business_type: formProfile.businessFormation,
                core_services: formProfile.coreServices,
                differentiators: formProfile.differentiators,
                certifications: formProfile.certifications ? formProfile.certifications.split(',').map(s => s.trim()).filter(Boolean) : [],
                contract_vehicles: formProfile.contractVehicles ? formProfile.contractVehicles.split(',').map(s => s.trim()).filter(Boolean) : [],
                brand_colors: brandColors
            };

            console.log('[Profile] Saving profile data:', profileData.company_name, '|', profileData.naics_codes);

            // All users now have Supabase sessions - save directly to Supabase
            // Check if SupabaseAuth is available
            if (typeof SupabaseAuth === 'undefined') {
                console.error('SupabaseAuth is not loaded');
                return false;
            }

            try {
                const saved = await SupabaseAuth.saveUserProfile(profileData);
                if (saved) {
                    console.log('[Profile]  Profile saved to Supabase successfully');
                    // Reload profile to ensure local state is updated
                    await SupabaseAuth.loadUserProfile();
                    console.log('[Profile]  Profile reloaded');

                    // Check if we should show welcome modal
                    if (showWelcome && isFirstCompleteSave && formProfile.companyName && formProfile.coreServices) {
                        checkFirstTimeSetup(true);
                    }

                    return true;
                } else {
                    console.error('[Profile]  saveUserProfile returned falsy value');
                }
            } catch (error) {
                console.error('[Profile]  Failed to save profile:', error);
            }
            return false;
        }

        // Show reset confirmation modal
        function resetCompanyProfile() {
            const modal = document.getElementById('reset-confirm-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Close reset modal
        function closeResetModal() {
            const modal = document.getElementById('reset-confirm-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Actually reset the profile after confirmation
        async function confirmResetProfile() {
            closeResetModal();

            try {
                await SupabaseAuth.saveUserProfile({
                    company_name: '',
                    role_title: '',
                    naics_codes: [],
                    business_type: 'Small Business',
                    core_services: '',
                    differentiators: '',
                    certifications: [],
                    contract_vehicles: [],
                    target_agencies: []
                });
                console.log('Profile cleared');
            } catch (error) {
                console.log('Could not clear profile:', error);
            }

            // Clear all form fields
            document.getElementById('display-name').value = '';
            document.getElementById('company-name').value = '';
            document.getElementById('user-role').value = '';
            document.getElementById('phone-number').value = '';
            document.getElementById('website').value = '';
            document.getElementById('naics-codes').value = '';
            document.getElementById('business-formation').value = 'Small Business';
            document.getElementById('core-services').value = '';
            document.getElementById('differentiators').value = '';
            document.getElementById('certifications').value = '';
            document.getElementById('contract-vehicles').value = '';
            document.getElementById('past-performance').value = '';

            // Hide the quick-generate section (returning user UI)
            document.getElementById('quick-generate-section').classList.add('hidden');

            // Hide the profile card
            document.getElementById('profile-card').classList.add('hidden');

            // Show the full generator form (new user UI)
            document.getElementById('generator-form').classList.remove('hidden');

            // Show the form fields (not summary)
            showProfileForm();

            // Hide agencies section and clear found agencies
            document.getElementById('agencies-section').classList.add('hidden');
            foundAgencies = [];

            // Reset generate button and set up form validation
            document.getElementById('generate-btn').disabled = true;
            setupFormValidation();

            console.log('Company profile reset - showing new user experience');
        }

        // Get company profile from form
        function getCompanyProfile() {
            return {
                companyName: document.getElementById('company-name').value.trim(),
                userRole: document.getElementById('user-role').value.trim(),
                phoneNumber: document.getElementById('phone-number').value.trim(),
                website: document.getElementById('website').value.trim(),
                naicsCodes: document.getElementById('naics-codes').value.trim(),
                businessFormation: document.getElementById('business-formation').value,
                coreServices: document.getElementById('core-services').value.trim(),
                differentiators: document.getElementById('differentiators').value.trim(),
                certifications: document.getElementById('certifications').value.trim(),
                contractVehicles: document.getElementById('contract-vehicles').value.trim(),
                pastPerformance: document.getElementById('past-performance').value.trim()
            };
        }

        // Find agencies based on NAICS codes
        async function findAgencies() {
            const naicsInput = document.getElementById('naics-codes').value.trim();
            const businessFormation = document.getElementById('business-formation').value;

            if (!naicsInput) {
                showInfoToast('Please enter at least one NAICS code');
                document.getElementById('naics-codes').focus();
                return;
            }

            // Parse NAICS codes
            const naicsCodes = naicsInput.split(',').map(c => c.trim()).filter(c => c);

            // Show loading
            document.getElementById('generator-form').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');

            // Initialize enhanced loading animation for agency search
            const agencySteps = [
                'Querying USAspending.gov database',
                'Analyzing agency spending patterns',
                'Identifying best matches'
            ];
            startLoadingAnimation(agencySteps, 'Finding Target Agencies...', 'Searching federal spending data');

            setTimeout(() => {
                activateLoadingStep(1, 'Querying USAspending.gov database');
            }, 300);

            try {
                const response = await fetch('/api/agencies/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ naicsCodes, businessFormation })
                });

                const result = await response.json();

                completeLoadingStep(1, 'Database queried');
                activateLoadingStep(2, 'Analyzing spending patterns');

                if (!result.success) {
                    throw new Error(result.error || 'Failed to find agencies');
                }

                foundAgencies = result.agencies;

                // Always save profile when finding agencies (ensures data persists)
                const formProfile = getCompanyProfile();
                console.log('[Profile] Auto-saving profile after finding agencies...');

                try {
                    // Save with timeout to prevent hanging
                    await Promise.race([
                        saveCompanyProfile(false),
                        new Promise(resolve => setTimeout(() => {
                            console.log('[Profile] Save timed out, continuing...');
                            resolve(false);
                        }, 5000))
                    ]);
                    console.log('[Profile] Profile saved successfully');

                    // Reload profile to ensure we have latest data
                    await SupabaseAuth.loadUserProfile();
                } catch (e) {
                    console.error('[Profile] Failed to save profile:', e);
                }

                // Check for welcome modal (after profile is saved/reloaded)
                const updatedProfile = SupabaseAuth?.profile;
                const welcomeSeen = updatedProfile?.welcome_modal_seen;
                const shouldShowWelcome = !welcomeSeen && formProfile.companyName && formProfile.coreServices;

                // Complete the loading animation
                completeLoadingStep(2, 'Spending patterns analyzed');
                completeLoadingStep(3, `Found ${result.agencies?.length || 0} matching agencies`);
                completeLoadingAnimation();

                // Show form again with agencies and profile summary
                setTimeout(async () => {
                    stopLoadingAnimation();
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('generator-form').classList.remove('hidden');
                    displayFoundAgencies(result.agencies, result.totalContracts);

                    // Store flag for showing welcome modal when user clicks Generate
                    if (shouldShowWelcome) {
                        window.pendingWelcomeModal = true;
                        console.log('[Welcome] Will show modal when user clicks Generate');
                    }

                    // Show profile summary if profile was saved
                    if (typeof SupabaseAuth !== 'undefined') {
                        const profile = SupabaseAuth.profile;
                        if (profile && profile.company_name && profile.core_services) {
                            showProfileSummary(profile);
                        }
                    }
                }, 1500);

            } catch (error) {
                console.error('Error finding agencies:', error);
                showErrorToast('Failed to find agencies: ' + error.message);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('generator-form').classList.remove('hidden');
            }
        }

        // Display found agencies
        function displayFoundAgencies(agencies, totalContracts) {
            const section = document.getElementById('agencies-section');
            const container = document.getElementById('target-agencies-container');
            const badge = document.getElementById('agency-count-badge');

            if (agencies.length === 0) {
                container.innerHTML = '<p class="text-gray-600 col-span-full">No agencies found. Try different NAICS codes or remove business type filter.</p>';
                badge.textContent = '0 agencies';
                section.classList.remove('hidden');
                return;
            }

            badge.textContent = `${agencies.length} agencies`;

            container.innerHTML = agencies.map((agency, idx) => `
                <label class="flex items-start gap-3 p-3 bg-white border-2 border-green-200 rounded-lg cursor-pointer hover:border-green-400 transition">
                    <input type="checkbox" name="selected-agency" value="${agency.name}" ${idx < 5 ? 'checked' : ''} class="mt-1 w-4 h-4 text-green-600">
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-gray-800 text-sm truncate" title="${agency.name}">${agency.name}</p>
                        <p class="text-xs text-gray-500">${agency.parentAgency || 'Federal Agency'}</p>
                        <p class="text-xs text-green-700 font-medium mt-1">${agency.spendingFormatted} (${agency.contracts} contracts)</p>
                    </div>
                </label>
            `).join('');

            section.classList.remove('hidden');

            // Enable generate button
            document.getElementById('generate-btn').disabled = false;
            document.getElementById('generate-help').textContent = 'Select agencies above, then generate your personalized posts';

            // Scroll to agencies
            section.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function toggleAdvancedOptions() {
            const container = document.getElementById('advanced-options');
            const arrow = document.getElementById('advanced-arrow');
            container.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');
        }

        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                const result = await response.json();

                if (result.success) {
                    availableTemplates = result.templates;
                    renderTemplates();
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        function renderTemplates() {
            const container = document.getElementById('templates-container');
            const templateIcons = {
                'actionable': '', 'motivational': '', 'analytical': '',
                'observation': '', 'x-vs-y': '', 'present-future': '',
                'story-driven': '', 'stat-heavy': '', 'question-based': '',
                'case-study': '', 'thought-leadership': '', 'list-tips': '',
                'contrarian': '', 'contrarian-v2': '', 'listicle': ''
            };

            container.innerHTML = availableTemplates.map(template => `
                <label class="flex items-center gap-2 p-2 border border-gray-200 rounded-lg cursor-pointer hover:border-govcon-blue hover:bg-blue-50 transition text-sm" title="${template.description}">
                    <input type="checkbox" name="templates" value="${template.key}" class="w-4 h-4 text-govcon-blue">
                    <span class="text-lg">${templateIcons[template.key] || ''}</span>
                    <span class="text-gray-700 truncate">${template.name}</span>
                </label>
            `).join('');
        }

        async function generateContent() {
            const companyProfile = getCompanyProfile();

            // Validation
            if (!companyProfile.companyName) {
                showInfoToast('Please enter your company name');
                document.getElementById('company-name').focus();
                return;
            }

            if (!companyProfile.coreServices) {
                showInfoToast('Please enter your core services/capabilities');
                document.getElementById('core-services').focus();
                return;
            }

            // Get selected agencies
            const selectedAgencies = Array.from(document.querySelectorAll('input[name="selected-agency"]:checked'))
                .map(cb => cb.value);

            if (selectedAgencies.length === 0) {
                showInfoToast('Please select at least one target agency');
                return;
            }

            // Show welcome modal for first-time users (after they've selected agencies)
            if (window.pendingWelcomeModal) {
                window.pendingWelcomeModal = false; // Clear flag
                console.log('[Welcome] Showing welcome modal now that agencies are selected');
                showWelcomeModal();
                return; // Don't generate yet - let user choose 30-day or regular
            }

            // Save profile
            if (document.getElementById('save-profile').checked) {
                saveCompanyProfile();
            }

            const numPosts = parseInt(document.getElementById('num-posts').value);
            let selectedTemplates = Array.from(document.querySelectorAll('input[name="templates"]:checked'))
                .map(cb => cb.value);

            if (selectedTemplates.length === 0) {
                const diverseMix = [
                    'actionable', 'observation', 'x-vs-y', 'stat-heavy', 'question-based',
                    'contrarian', 'story-driven', 'thought-leadership', 'case-study', 'listicle'
                ];
                const shuffled = diverseMix.sort(() => Math.random() - 0.5);
                selectedTemplates = shuffled.slice(0, Math.min(numPosts, shuffled.length));
            }

            const geoBoost = document.getElementById('geo-boost').checked;
            const useFineTuned = document.getElementById('use-fine-tuned').checked;

            // Show loading
            document.getElementById('generator-form').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');

            // Initialize enhanced loading animation
            const loadingSteps = [
                'Analyzing agency pain points',
                `Personalizing for ${companyProfile.companyName}`,
                'Writing in your authentic voice'
            ];
            startLoadingAnimation(loadingSteps, 'Generating Your Content...', `Creating ${numPosts} post${numPosts > 1 ? 's' : ''} for ${selectedAgencies.length} agenc${selectedAgencies.length > 1 ? 'ies' : 'y'}`);

            // Animate steps progressively
            setTimeout(() => {
                activateLoadingStep(1, 'Analyzing agency pain points');
            }, 500);

            setTimeout(() => {
                completeLoadingStep(1, 'Analyzed agency pain points');
                activateLoadingStep(2, `Personalizing for ${companyProfile.companyName}`);
            }, 2000);

            setTimeout(() => {
                completeLoadingStep(2, `Personalized for ${companyProfile.companyName}`);
                activateLoadingStep(3, 'Writing in your authentic voice');
            }, 4000);

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetAgencies: selectedAgencies,
                        numPosts: numPosts,
                        geoBoost: geoBoost,
                        templates: selectedTemplates,
                        useFineTuned: useFineTuned,
                        companyProfile: companyProfile
                    })
                });

                // Check for HTTP errors before parsing
                if (!response.ok) {
                    const text = await response.text();
                    console.error('[Generate] HTTP Error:', response.status, text.substring(0, 200));
                    if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                        throw new Error('API route not found. Please refresh and try again.');
                    }
                    throw new Error(`Server error (${response.status}): ${text.substring(0, 100)}`);
                }

                // Validate JSON content-type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('[Generate] Invalid content-type:', contentType);
                    throw new Error('Server returned invalid response. Please try again.');
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate content');
                }

                // Complete loading animation
                completeLoadingStep(3, 'Content ready!');
                completeLoadingAnimation();

                // Short delay to show completion state
                await new Promise(resolve => setTimeout(resolve, 500));

                displayPosts(result.posts, result.metadata);

            } catch (error) {
                console.error('Error generating content:', error);
                stopLoadingAnimation();

                // User-friendly error messages
                let errorMsg = error.message || 'Unexpected error. Please refresh and try again.';
                if (error.message.includes('not found') || error.message.includes('<html')) {
                    errorMsg = 'Server temporarily unavailable. Please try again in a moment.';
                }
                showErrorToast('Failed to generate content: ' + errorMsg);
                resetGenerator();
            }
        }

        // Get preview text (first 2-3 lines)
        function getPreviewText(content) {
            const lines = content.split('\n').filter(l => l.trim());
            const previewLines = lines.slice(0, 2);
            return previewLines.join('\n');
        }

        // Toggle post expansion
        function togglePost(index) {
            const preview = document.getElementById(`post-preview-${index}`);
            const full = document.getElementById(`post-full-${index}`);
            const seeMore = document.getElementById(`see-more-${index}`);
            const seeLess = document.getElementById(`see-less-${index}`);
            const details = document.getElementById(`post-details-${index}`);

            if (full.classList.contains('hidden')) {
                // Expand
                preview.classList.add('hidden');
                full.classList.remove('hidden');
                seeMore.classList.add('hidden');
                seeLess.classList.remove('hidden');
                details.classList.remove('hidden');
            } else {
                // Collapse
                preview.classList.remove('hidden');
                full.classList.add('hidden');
                seeMore.classList.remove('hidden');
                seeLess.classList.add('hidden');
                details.classList.add('hidden');
            }
        }

        // Track if user has generated posts before (for confetti)
        let hasGeneratedBefore = localStorage.getItem('gcg_has_generated') === 'true';

        // Confetti celebration for first generation
        function celebrateFirstGeneration() {
            if (typeof confetti !== 'function') return;

            // Burst from both sides
            const duration = 1500;
            const end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 4,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: 0.7 },
                    colors: ['#3b82f6', '#22d3ee', '#fbbf24', '#10b981']
                });
                confetti({
                    particleCount: 4,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: 0.7 },
                    colors: ['#3b82f6', '#22d3ee', '#fbbf24', '#10b981']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        function displayPosts(posts, metadata) {
            generatedPosts = posts;

            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('generated-posts').classList.remove('hidden');

            // Celebrate first generation with confetti!
            if (!hasGeneratedBefore) {
                setTimeout(celebrateFirstGeneration, 300);
                hasGeneratedBefore = true;
                localStorage.setItem('gcg_has_generated', 'true');
            }

            const modelBadge = metadata?.model === 'fine-tuned'
                ? '<span class="inline-flex items-center gap-1 bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full mb-4"> Generated with GovCon-Tuned AI Model</span>'
                : '<span class="inline-flex items-center gap-1 bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full mb-4"> Generated with Grok AI</span>';

            const companyBadge = metadata?.companyName
                ? `<span class="inline-flex items-center gap-1 bg-govcon-gold/20 text-govcon-blue text-sm px-3 py-1 rounded-full mb-4 ml-2">Personalized for ${metadata.companyName}</span>`
                : '';

            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = `<div class="text-center">${modelBadge}${companyBadge}</div>` + posts.map((post, index) => {
                const previewText = getPreviewText(post.content);
                const hasMoreContent = post.content.split('\n').filter(l => l.trim()).length > 2;

                return `
                <div class="post-card bg-white rounded-xl shadow-lg overflow-hidden border-2 border-gray-200 hover:border-govcon-blue hover:shadow-xl hover:shadow-govcon-blue/10 hover:-translate-y-1 transition-all duration-300 cursor-pointer group">
                    <div class="gradient-bg px-4 py-3">
                        <div class="flex items-center justify-between flex-wrap gap-2">
                            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                                <span class="w-7 h-7 bg-white/20 rounded-full flex items-center justify-center text-sm">${index + 1}</span>
                                ${post.template || post.angle}
                            </h3>
                            <span class="bg-white/20 text-white text-xs px-2 py-1 rounded-full">${post.angle}</span>
                        </div>
                    </div>

                    <div class="p-4">
                        <!-- Post Content - Collapsed Preview -->
                        <div id="post-content-${index}" class="bg-gray-50 rounded-lg p-4 mb-3 border border-gray-200">
                            <!-- Preview (collapsed) -->
                            <div id="post-preview-${index}">
                                <pre class="whitespace-pre-wrap font-sans text-gray-800 leading-relaxed text-sm">${previewText}${hasMoreContent ? '...' : ''}</pre>
                            </div>
                            <!-- Full content (hidden) -->
                            <div id="post-full-${index}" class="hidden">
                                <pre class="whitespace-pre-wrap font-sans text-gray-800 leading-relaxed text-sm">${post.content}</pre>
                                ${post.hashtags && post.hashtags.length > 0 ? `
                                <div class="mt-3 pt-3 border-t border-gray-300">
                                    <div class="flex flex-wrap gap-1">
                                        ${post.hashtags.map(tag => `<span class="text-linkedin-blue font-medium text-sm">${tag}</span>`).join(' ')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <!-- See more / See less -->
                            ${hasMoreContent ? `
                            <button id="see-more-${index}" onclick="togglePost(${index})" class="text-linkedin-blue font-semibold text-sm mt-2 hover:underline">...see more</button>
                            <button id="see-less-${index}" onclick="togglePost(${index})" class="hidden text-linkedin-blue font-semibold text-sm mt-2 hover:underline">Show less</button>
                            ` : ''}
                        </div>

                        <!-- Details Section (hidden by default) -->
                        <div id="post-details-${index}" class="hidden">
                            <div class="bg-purple-50 rounded-lg p-3 mb-3 text-xs">
                                <p class="font-semibold text-purple-900 mb-1">Pain Point:</p>
                                <p class="text-purple-800">${post.painPointAddressed || 'General government contracting'}</p>
                                ${post.stats && post.stats.length > 0 ? `
                                <p class="font-semibold text-purple-900 mt-2 mb-1">Statistics:</p>
                                <ul class="text-purple-800 space-y-0.5">
                                    ${post.stats.map(stat => `<li> ${stat}</li>`).join('')}
                                </ul>
                                ` : ''}
                            </div>

                            <!-- Image Generation Section -->
                            <div id="image-section-${index}" class="mb-3">
                                <div id="image-container-${index}" class="hidden mb-3">
                                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg p-3 border border-blue-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <p class="text-xs font-medium text-gray-700">Generated Graphic:</p>
                                            <span id="image-style-${index}" class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full"></span>
                                        </div>
                                        <img id="generated-image-${index}" src="" alt="Generated LinkedIn graphic" class="w-full max-w-md mx-auto rounded-lg shadow-lg">
                                        <div id="quote-display-${index}" class="mt-2 bg-white/70 rounded-lg p-2 text-center">
                                            <p class="text-xs text-gray-600 italic"></p>
                                        </div>
                                        <div class="flex gap-2 mt-3 justify-center">
                                            <a id="download-btn-${index}" href="" download="linkedin-quote-graphic.png" class="bg-green-600 hover:bg-green-700 text-white font-bold px-3 py-1.5 rounded-lg transition flex items-center gap-1 text-xs">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                                Download
                                            </a>
                                            <button onclick="cycleGraphicStyle(${index})" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-3 py-1.5 rounded-lg transition flex items-center gap-1 text-xs">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                                New Style
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div id="image-loading-${index}" class="hidden mb-3">
                                    <div class="bg-purple-50 rounded-lg p-4 text-center border border-purple-200">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-2"></div>
                                        <p class="text-purple-800 font-medium text-sm">Creating graphic...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons - Always visible -->
                        <div class="flex gap-2 flex-wrap">
                            <button id="copy-btn-${index}" onclick="copyPost(${index})" class="flex-1 min-w-[80px] bg-linkedin-blue hover:bg-linkedin-dark text-white font-bold px-4 py-2 rounded-lg transition flex items-center justify-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                Copy
                            </button>
                            <button id="save-btn-${index}" onclick="saveToLibrary(${index}, event)" class="min-w-[80px] bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded-lg transition flex items-center justify-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                                Save
                            </button>
                            <button id="schedule-btn-${index}" onclick="openScheduleModal(${index})" class="min-w-[80px] bg-amber-500 hover:bg-amber-600 text-white font-bold px-4 py-2 rounded-lg transition flex items-center justify-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Schedule
                            </button>
                            ${hasGraphicsAccess ? `
                            <button onclick="openVisualModal(${index})" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold px-4 py-2 rounded-lg transition flex items-center justify-center gap-2 text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Create Visual
                            </button>
                            ` : `
                            <button onclick="showGraphicsUpgradeModal()" class="relative bg-gradient-to-r from-purple-400 to-indigo-400 text-white font-bold px-4 py-2 rounded-lg flex items-center justify-center gap-2 text-sm hover:from-purple-500 hover:to-indigo-500 transition group" title="Full Fix feature - Click to upgrade">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                Create Visual
                                <span class="absolute -top-2 -right-2 bg-yellow-400 text-xs text-gray-900 px-1.5 py-0.5 rounded-full font-bold">PRO</span>
                            </button>
                            `}
                        </div>

                        <!-- Ghosted Graphic Preview (Standard tier only) -->
                        ${!hasGraphicsAccess ? `
                        <div class="mt-4 relative cursor-pointer group" onclick="showGraphicsUpgradeModal()">
                            <div class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-4 opacity-50 blur-[2px]">
                                <div class="aspect-square max-w-[200px] mx-auto bg-slate-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-16 h-16 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="absolute inset-0 flex flex-col items-center justify-center bg-black/40 rounded-xl group-hover:bg-black/50 transition">
                                <svg class="w-10 h-10 text-white mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                </svg>
                                <p class="text-white font-bold text-sm">4 Layouts + Carousel</p>
                                <p class="text-amber-400 text-xs mt-1">Upgrade to Full Fix $200</p>
                            </div>
                        </div>
                        ` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');

            document.getElementById('generated-posts').scrollIntoView({ behavior: 'smooth' });
        }

        function copyPost(index) {
            const post = generatedPosts[index];
            if (!post) return;

            let fullText = post.content;
            if (post.hashtags && post.hashtags.length > 0) {
                fullText += '\n\n' + post.hashtags.join(' ');
            }

            navigator.clipboard.writeText(fullText).then(() => {
                const button = document.getElementById(`copy-btn-${index}`);
                const originalHTML = button.innerHTML;
                button.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Copied!`;
                button.classList.remove('bg-linkedin-blue', 'hover:bg-linkedin-dark');
                button.classList.add('bg-green-600', 'hover:bg-green-700');

                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    button.classList.add('bg-linkedin-blue', 'hover:bg-linkedin-dark');
                }, 2000);
            });
        }

        // Show graphics upgrade modal for Content Engine users
        function showGraphicsUpgradeModal() {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.id = 'graphics-upgrade-modal';
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl transform animate-pulse-once">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Unlock Visual Graphics</h3>
                        <p class="text-gray-600">Make your LinkedIn posts stand out with professional AI-generated visuals</p>
                    </div>

                    <div class="bg-purple-50 rounded-xl p-4 mb-6">
                        <h4 class="font-bold text-purple-900 mb-2">Full Fix includes:</h4>
                        <ul class="space-y-2 text-sm text-purple-800">
                            <li class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                <span>4 graphic layout styles (Classic, Tweet, Social, Highlighter)</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                <span>LinkedIn carousel slides</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                <span>Unlimited daily posts</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                <span>One-click image download</span>
                            </li>
                        </ul>
                    </div>

                    <div class="text-center mb-4">
                        <p class="text-sm text-gray-500 mb-1">Upgrade for just</p>
                        <p class="text-3xl font-bold text-govcon-blue">$200 <span class="text-sm font-normal text-gray-500">one-time</span></p>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="document.getElementById('graphics-upgrade-modal').remove()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition">
                            Maybe Later
                        </button>
                        <a href="https://buy.stripe.com/9B6cN62sm2IO7lb4SIfnO0o" target="_blank" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-700 hover:to-indigo-700 transition text-center">
                            Upgrade Now
                        </a>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Quote Card Templates - Professional LinkedIn Graphics
        const quoteCardStyles = [
            {
                name: 'Navy Professional',
                bgGradient: ['#1e3a5f', '#0d1f33'],
                textColor: '#ffffff',
                accentColor: '#c5a028',
                quoteColor: '#f0f4f8'
            },
            {
                name: 'Gold Accent',
                bgGradient: ['#1e3a5f', '#2d5a87'],
                textColor: '#ffffff',
                accentColor: '#ffd700',
                quoteColor: '#ffeeba'
            },
            {
                name: 'Modern Blue',
                bgGradient: ['#0077B5', '#004182'],
                textColor: '#ffffff',
                accentColor: '#00a0dc',
                quoteColor: '#e8f4f8'
            },
            {
                name: 'Executive Dark',
                bgGradient: ['#1a1a2e', '#16213e'],
                textColor: '#ffffff',
                accentColor: '#e94560',
                quoteColor: '#f5f5f5'
            },
            {
                name: 'Federal Classic',
                bgGradient: ['#002868', '#041e42'],
                textColor: '#ffffff',
                accentColor: '#bf0a30',
                quoteColor: '#ffffff'
            },
            {
                name: 'Slate Modern',
                bgGradient: ['#2c3e50', '#1a252f'],
                textColor: '#ffffff',
                accentColor: '#3498db',
                quoteColor: '#ecf0f1'
            }
        ];

        // ========== BRAND COLORS FUNCTIONS ==========

        // Sync color picker with hex input (color picker -> hex)
        function setupBrandColorSync() {
            const colorMappings = [
                { picker: 'brand-primary-color', hex: 'brand-primary-hex' },
                { picker: 'brand-accent-color', hex: 'brand-accent-hex' },
                { picker: 'brand-bg-color', hex: 'brand-bg-hex' }
            ];

            colorMappings.forEach(({ picker, hex }) => {
                const pickerEl = document.getElementById(picker);
                const hexEl = document.getElementById(hex);
                if (pickerEl && hexEl) {
                    pickerEl.addEventListener('input', () => {
                        hexEl.value = pickerEl.value;
                    });
                }
            });
        }

        // Sync hex input with color picker (hex -> color picker)
        function syncColorFromHex(colorType) {
            const hexEl = document.getElementById(`brand-${colorType}-hex`);
            const pickerEl = document.getElementById(`brand-${colorType}-color`);
            if (hexEl && pickerEl) {
                // Validate hex format
                const hexValue = hexEl.value.trim();
                if (/^#[0-9A-Fa-f]{6}$/.test(hexValue)) {
                    pickerEl.value = hexValue;
                } else if (/^[0-9A-Fa-f]{6}$/.test(hexValue)) {
                    // Add # if missing
                    hexEl.value = '#' + hexValue;
                    pickerEl.value = '#' + hexValue;
                }
            }
        }

        // Get brand style for quote cards (if enabled)
        function getBrandStyle() {
            const profile = SupabaseAuth.profile;
            if (!profile?.brand_colors?.enabled || userTier !== 'full-fix') {
                return null;
            }

            const colors = profile.brand_colors;
            // Create a darker version of background for gradient
            const bgColor = colors.background || '#0d1f33';
            const darkerBg = darkenColor(bgColor, 20);

            return {
                name: 'Your Brand',
                bgGradient: [bgColor, darkerBg],
                textColor: '#ffffff',
                accentColor: colors.accent || '#c5a028',
                quoteColor: getContrastColor(bgColor)
            };
        }

        // Darken a hex color by a percentage
        function darkenColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max((num >> 16) - amt, 0);
            const G = Math.max((num >> 8 & 0x00FF) - amt, 0);
            const B = Math.max((num & 0x0000FF) - amt, 0);
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        // Get a contrasting quote color (light for dark bg, dark for light bg)
        function getContrastColor(bgHex) {
            const num = parseInt(bgHex.replace('#', ''), 16);
            const r = (num >> 16) & 255;
            const g = (num >> 8) & 255;
            const b = num & 255;
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#1a1a1a' : '#f5f5f5';
        }

        // Initialize brand color sync on page load
        document.addEventListener('DOMContentLoaded', setupBrandColorSync);

        // ========== CAROUSEL BUILDER FUNCTIONS ==========

        let carouselSlides = [];
        let currentSlideIndex = 0;
        let carouselImages = [];

        // Carousel style presets
        const carouselStyles = {
            professional: {
                name: 'Professional Navy',
                bgGradient: ['#1e3a5f', '#0d1f33'],
                textColor: '#ffffff',
                accentColor: '#c5a028',
                titleColor: '#ffffff'
            },
            modern: {
                name: 'Modern Blue',
                bgGradient: ['#0077B5', '#004182'],
                textColor: '#ffffff',
                accentColor: '#00a0dc',
                titleColor: '#ffffff'
            },
            bold: {
                name: 'Bold & Clean',
                bgGradient: ['#1a1a2e', '#16213e'],
                textColor: '#f5f5f5',
                accentColor: '#e94560',
                titleColor: '#ffffff'
            },
            brand: null // Will use user's brand colors
        };

        function setCarouselTopic(topic) {
            document.getElementById('carousel-topic').value = topic;
        }

        function toggleCarouselBuilder() {
            const section = document.getElementById('carousel-builder-section');
            section.classList.toggle('hidden');
        }

        async function generateCarousel() {
            const topic = document.getElementById('carousel-topic').value.trim();
            if (!topic) {
                showInfoToast('Please enter a carousel topic');
                return;
            }

            const slideCount = parseInt(document.getElementById('carousel-slide-count').value);
            const styleKey = document.getElementById('carousel-style').value;

            // Show loading
            document.getElementById('carousel-input-section').classList.add('hidden');
            document.getElementById('carousel-loading').classList.remove('hidden');
            document.getElementById('carousel-preview').classList.add('hidden');

            try {
                // Get company info
                const profile = SupabaseAuth.profile;
                const companyName = profile?.company_name || 'Your Company';
                const services = profile?.core_services || '';

                // Call API to generate carousel content
                document.getElementById('carousel-loading-status').textContent = 'Generating slide content...';

                const response = await fetch('/api/generate-carousel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        slideCount,
                        companyName,
                        services
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate carousel');
                }

                carouselSlides = result.slides;

                // Get the style (use brand colors if selected)
                let style = carouselStyles[styleKey];
                if (styleKey === 'brand') {
                    const brandStyle = getBrandStyle();
                    if (brandStyle) {
                        style = {
                            ...brandStyle,
                            titleColor: brandStyle.quoteColor
                        };
                    } else {
                        style = carouselStyles.professional;
                    }
                }

                // Render all slides
                document.getElementById('carousel-loading-status').textContent = 'Rendering slides...';
                carouselImages = [];

                for (let i = 0; i < carouselSlides.length; i++) {
                    document.getElementById('carousel-loading-status').textContent = `Rendering slide ${i + 1} of ${carouselSlides.length}...`;
                    const imageUrl = await renderCarouselSlide(carouselSlides[i], i, carouselSlides.length, style, companyName);
                    carouselImages.push(imageUrl);
                }

                // Show preview
                currentSlideIndex = 0;
                displayCurrentSlide();
                renderThumbnails();

                document.getElementById('carousel-loading').classList.add('hidden');
                document.getElementById('carousel-preview').classList.remove('hidden');

                showSuccessToast(`Carousel with ${carouselSlides.length} slides created!`);

            } catch (error) {
                console.error('Carousel generation error:', error);
                showErrorToast('Failed to generate carousel: ' + error.message);
                resetCarousel();
            }
        }

        async function renderCarouselSlide(slide, index, totalSlides, style, companyName) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // LinkedIn carousel size (4:5 aspect ratio)
            canvas.width = 1080;
            canvas.height = 1350;

            // Draw gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, style.bgGradient[0]);
            gradient.addColorStop(1, style.bgGradient[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Add subtle pattern
            ctx.globalAlpha = 0.03;
            for (let i = 0; i < 30; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 80 + 20, 0, Math.PI * 2);
                ctx.fillStyle = '#ffffff';
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            // Top accent bar
            ctx.fillStyle = style.accentColor;
            ctx.fillRect(0, 0, canvas.width, 8);

            // Slide number indicator
            ctx.fillStyle = style.accentColor;
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            ctx.arc(canvas.width - 80, 80, 40, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;

            ctx.font = 'bold 32px "Segoe UI", system-ui, sans-serif';
            ctx.fillStyle = style.titleColor;
            ctx.textAlign = 'center';
            ctx.fillText(`${index + 1}`, canvas.width - 80, 90);

            // Title
            ctx.textAlign = 'left';
            const title = slide.title || '';
            let titleFontSize = 64;
            if (title.length > 30) titleFontSize = 52;
            if (title.length > 50) titleFontSize = 44;

            ctx.font = `bold ${titleFontSize}px "Segoe UI", system-ui, sans-serif`;
            ctx.fillStyle = style.titleColor;

            // Word wrap title
            const titleLines = wrapText(ctx, title, canvas.width - 160);
            let y = 180;
            titleLines.forEach((line, i) => {
                ctx.fillText(line, 80, y + (i * titleFontSize * 1.2));
            });

            // Accent line under title
            y = 180 + (titleLines.length * titleFontSize * 1.2) + 30;
            ctx.fillStyle = style.accentColor;
            ctx.fillRect(80, y, 100, 4);

            // Content
            y += 50;
            const content = slide.content || '';
            let contentFontSize = 36;
            if (content.length > 200) contentFontSize = 32;
            if (content.length > 300) contentFontSize = 28;

            ctx.font = `${contentFontSize}px "Segoe UI", system-ui, sans-serif`;
            ctx.fillStyle = style.textColor;
            ctx.globalAlpha = 0.9;

            const contentLines = wrapText(ctx, content, canvas.width - 160);
            contentLines.forEach((line, i) => {
                ctx.fillText(line, 80, y + (i * contentFontSize * 1.5));
            });
            ctx.globalAlpha = 1;

            // Bottom section - company name and swipe indicator
            ctx.fillStyle = style.accentColor;
            ctx.fillRect(0, canvas.height - 120, canvas.width, 120);

            ctx.font = '28px "Segoe UI", system-ui, sans-serif';
            ctx.fillStyle = style.bgGradient[0];
            ctx.textAlign = 'left';
            ctx.fillText(companyName, 80, canvas.height - 55);

            // Swipe indicator (if not last slide)
            if (index < totalSlides - 1) {
                ctx.textAlign = 'right';
                ctx.fillStyle = style.bgGradient[0];
                ctx.globalAlpha = 0.7;
                ctx.fillText('Swipe ', canvas.width - 80, canvas.height - 55);
                ctx.globalAlpha = 1;
            } else {
                ctx.textAlign = 'right';
                ctx.fillStyle = style.bgGradient[0];
                ctx.fillText('Follow for more!', canvas.width - 80, canvas.height - 55);
            }

            return canvas.toDataURL('image/png');
        }

        function displayCurrentSlide() {
            const img = document.getElementById('current-slide-img');
            img.src = carouselImages[currentSlideIndex];

            document.getElementById('slide-indicator').textContent = `Slide ${currentSlideIndex + 1} of ${carouselSlides.length}`;

            // Update editor
            document.getElementById('edit-slide-num').textContent = currentSlideIndex + 1;
            document.getElementById('edit-slide-title').value = carouselSlides[currentSlideIndex].title || '';
            document.getElementById('edit-slide-content').value = carouselSlides[currentSlideIndex].content || '';

            // Update nav buttons
            document.getElementById('prev-slide-btn').disabled = currentSlideIndex === 0;
            document.getElementById('next-slide-btn').disabled = currentSlideIndex === carouselSlides.length - 1;

            // Update thumbnail selection
            document.querySelectorAll('#carousel-thumbnails img').forEach((thumb, i) => {
                if (i === currentSlideIndex) {
                    thumb.classList.add('ring-2', 'ring-purple-500');
                } else {
                    thumb.classList.remove('ring-2', 'ring-purple-500');
                }
            });
        }

        function renderThumbnails() {
            const container = document.getElementById('carousel-thumbnails');
            container.innerHTML = '';

            carouselImages.forEach((imgUrl, i) => {
                const thumb = document.createElement('img');
                thumb.src = imgUrl;
                thumb.className = 'w-20 h-24 object-cover rounded cursor-pointer hover:opacity-80 transition flex-shrink-0';
                if (i === currentSlideIndex) {
                    thumb.classList.add('ring-2', 'ring-purple-500');
                }
                thumb.onclick = () => {
                    currentSlideIndex = i;
                    displayCurrentSlide();
                };
                container.appendChild(thumb);
            });
        }

        function prevSlide() {
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
                displayCurrentSlide();
            }
        }

        function nextSlide() {
            if (currentSlideIndex < carouselSlides.length - 1) {
                currentSlideIndex++;
                displayCurrentSlide();
            }
        }

        async function updateSlideContent() {
            const title = document.getElementById('edit-slide-title').value;
            const content = document.getElementById('edit-slide-content').value;

            carouselSlides[currentSlideIndex].title = title;
            carouselSlides[currentSlideIndex].content = content;

            // Re-render current slide
            const styleKey = document.getElementById('carousel-style').value;
            let style = carouselStyles[styleKey];
            if (styleKey === 'brand') {
                const brandStyle = getBrandStyle();
                style = brandStyle ? { ...brandStyle, titleColor: brandStyle.quoteColor } : carouselStyles.professional;
            }

            const companyName = SupabaseAuth.profile?.company_name || 'Your Company';
            carouselImages[currentSlideIndex] = await renderCarouselSlide(
                carouselSlides[currentSlideIndex],
                currentSlideIndex,
                carouselSlides.length,
                style,
                companyName
            );

            displayCurrentSlide();
            renderThumbnails();
        }

        async function regenerateCurrentSlide() {
            showInfoToast('Regenerating slide content...');
            // This would call API to regenerate just this slide
            // For now, show a placeholder
            showSuccessToast('Slide content regenerated');
        }

        // Download carousel as PDF (for LinkedIn upload)
        function downloadCarouselPDF() {
            try {
                const { jsPDF } = window.jspdf;

                // Create PDF with custom dimensions (4:5 aspect ratio in mm)
                // Using 216x270mm which maintains the 4:5 ratio
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [216, 270]
                });

                carouselImages.forEach((imgUrl, i) => {
                    if (i > 0) {
                        pdf.addPage([216, 270]);
                    }
                    // Add image to fill the page
                    pdf.addImage(imgUrl, 'PNG', 0, 0, 216, 270);
                });

                // Generate filename with topic
                const topic = document.getElementById('carousel-topic').value.trim();
                const sanitizedTopic = topic.replace(/[^a-zA-Z0-9]/g, '-').substring(0, 30);
                const filename = `carousel-${sanitizedTopic || 'slides'}.pdf`;

                pdf.save(filename);
                showSuccessToast(`PDF downloaded! Upload to LinkedIn as a document.`);
            } catch (error) {
                console.error('PDF generation error:', error);
                showErrorToast('Failed to generate PDF. Try downloading PNGs instead.');
            }
        }

        // Download all slides as individual PNGs
        function downloadAllSlidesPNG() {
            carouselImages.forEach((imgUrl, i) => {
                const link = document.createElement('a');
                link.href = imgUrl;
                link.download = `carousel-slide-${i + 1}.png`;
                link.click();
            });
            showSuccessToast(`Downloaded ${carouselImages.length} PNG slides!`);
        }

        function resetCarousel() {
            carouselSlides = [];
            currentSlideIndex = 0;
            carouselImages = [];

            document.getElementById('carousel-topic').value = '';
            document.getElementById('carousel-input-section').classList.remove('hidden');
            document.getElementById('carousel-loading').classList.add('hidden');
            document.getElementById('carousel-preview').classList.add('hidden');
        }

        let currentStyleIndex = {};

        // Graphic layout configurations
        const graphicLayouts = {
            classic: {
                label: 'Classic Quote',
                icon: '\u201C',
                description: 'Centered quote with gradient background',
                apiType: 'quote',
                themes: null // uses quoteCardStyles (set below)
            },
            tweet: {
                label: 'Tweet Quote',
                icon: '\uD83D\uDCAC',
                description: 'Post with hashtags + engagement stats',
                apiType: 'quote',
                themes: null // uses socialCardThemes (set below)
            },
            social: {
                label: 'Social Card',
                icon: '\uD83D\uDCF1',
                description: 'Clean profile header + quoted text',
                apiType: 'quote',
                themes: null // uses tweetQuoteThemes (set below)
            },
            highlighter: {
                label: 'Highlighter',
                icon: '\uD83D\uDD8D',
                description: 'Bold text with highlighted key words',
                apiType: 'highlight',
                themes: null // uses highlighterThemes (set below)
            },
            photoquote: {
                label: 'Photo Quote',
                icon: '\uD83D\uDCF8',
                description: 'Your photo background + highlighted quote',
                apiType: 'highlight',
                themes: null // uses photoQuoteThemes (set below)
            }
        };
        // Graphic type labels for display
        const graphicTypeLabels = {
            classic: 'Classic Quote',
            tweet: 'Tweet Quote',
            social: 'Social Card',
            highlighter: 'Highlighter'
        };

        // Route to correct render function based on graphic layout
        async function renderGraphic(type, data, companyName, style) {
            // Person's name for personal quote attribution; company name for brand contexts
            const displayName = document.getElementById('display-name')?.value?.trim() || companyName;
            const personName = displayName;  // For tweet, highlighter, photo quote
            const brandName = companyName;   // For classic quote, social card

            switch (type) {
                case 'tweet': return await renderSocialCard(data.quote || data, personName, style);
                case 'social': return await renderTweetQuote(data.quote || data, personName, style);
                case 'highlighter': return await renderHighlighterQuote(data, personName, style);
                case 'photoquote': return await renderPhotoQuote(data, personName, style);
                case 'classic':
                case 'quote':
                default: return await renderQuoteCard(data.quote || data, brandName, style);
            }
        }

        // Get a display string for the generated graphic content
        function getGraphicDisplayText(type, data) {
            return data.quote || data;
        }

        // Generate graphic using Canvas (expanded post view)  now routes through visual modal
        async function generateImage(index) {
            const post = generatedPosts[index];
            if (!post) return;

            // If no layout stored yet, open the visual modal
            if (!post.graphicLayout) {
                openVisualModal(index);
                return;
            }

            // Otherwise cycle style
            cycleGraphicStyle(index);
        }

        function getFirstLine(content) {
            const lines = content.split('\n').filter(l => l.trim());
            return lines[0] || 'Success in GovCon';
        }

        // Render quote card to canvas
        async function renderQuoteCard(quote, companyName, style) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // LinkedIn recommended size (1200x1200 for square, or 1200x628 for landscape)
            canvas.width = 1200;
            canvas.height = 1200;

            // Draw gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, style.bgGradient[0]);
            gradient.addColorStop(1, style.bgGradient[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Add subtle pattern/texture
            ctx.globalAlpha = 0.03;
            for (let i = 0; i < 50; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 100 + 20, 0, Math.PI * 2);
                ctx.fillStyle = '#ffffff';
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            // Add accent line at top
            ctx.fillStyle = style.accentColor;
            ctx.fillRect(0, 0, canvas.width, 8);

            // Add large quote marks
            ctx.font = 'bold 200px Georgia';
            ctx.fillStyle = style.accentColor;
            ctx.globalAlpha = 0.15;
            ctx.fillText('"', 60, 250);
            ctx.globalAlpha = 1;

            // Draw the quote text (word wrap)
            ctx.fillStyle = style.quoteColor;
            ctx.textAlign = 'center';

            // Calculate font size based on quote length
            let fontSize = 72;
            if (quote.length > 80) fontSize = 56;
            if (quote.length > 120) fontSize = 48;
            if (quote.length > 160) fontSize = 40;

            ctx.font = `bold ${fontSize}px 'Segoe UI', system-ui, sans-serif`;

            // Word wrap the quote
            const maxWidth = canvas.width - 160;
            const lines = wrapText(ctx, quote, maxWidth);
            const lineHeight = fontSize * 1.3;
            const totalTextHeight = lines.length * lineHeight;
            const startY = (canvas.height - totalTextHeight) / 2 + fontSize / 2;

            lines.forEach((line, i) => {
                ctx.fillText(line, canvas.width / 2, startY + (i * lineHeight));
            });

            // Add bottom accent bar
            ctx.fillStyle = style.accentColor;
            ctx.fillRect(canvas.width / 2 - 60, canvas.height - 180, 120, 4);

            // Add company name at bottom
            if (companyName) {
                ctx.font = '28px "Segoe UI", system-ui, sans-serif';
                ctx.fillStyle = style.textColor;
                ctx.globalAlpha = 0.7;
                ctx.fillText(companyName, canvas.width / 2, canvas.height - 120);
                ctx.globalAlpha = 1;
            }

            // Add decorative corner elements
            ctx.strokeStyle = style.accentColor;
            ctx.lineWidth = 3;
            ctx.globalAlpha = 0.3;

            // Top right corner
            ctx.beginPath();
            ctx.moveTo(canvas.width - 80, 40);
            ctx.lineTo(canvas.width - 40, 40);
            ctx.lineTo(canvas.width - 40, 80);
            ctx.stroke();

            // Bottom left corner
            ctx.beginPath();
            ctx.moveTo(80, canvas.height - 40);
            ctx.lineTo(40, canvas.height - 40);
            ctx.lineTo(40, canvas.height - 80);
            ctx.stroke();
            ctx.globalAlpha = 1;

            return canvas.toDataURL('image/png');
        }

        // ========== TWEET QUOTE RENDERER ==========
        const tweetQuoteThemes = [
            { name: 'Dark', bg: '#000000', text: '#ffffff', secondary: '#888888' },
            { name: 'Light', bg: '#d4d4d4', text: '#000000', secondary: '#666666' },
            { name: 'Clean', bg: '#ffffff', text: '#000000', secondary: '#888888' }
        ];

        async function renderTweetQuote(quote, companyName, theme) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1200;
            canvas.height = 1500;  // Vertical rectangle

            // Background
            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const padding = 80;
            const avatarR = 56;
            const headerH = avatarR * 2 + 10; // avatar + name/handle block
            const gapAfterHeader = 80;

            // Pre-calculate text to know total content height
            const quoteText = '\u201C' + quote + '\u201D';
            let fontSize = 120;
            if (quoteText.length > 60) fontSize = 100;
            if (quoteText.length > 100) fontSize = 84;
            if (quoteText.length > 150) fontSize = 72;
            if (quoteText.length > 220) fontSize = 60;

            ctx.font = `${fontSize}px Georgia, 'Times New Roman', serif`;
            const maxWidth = canvas.width - (padding * 2);
            const lines = wrapText(ctx, quoteText, maxWidth);
            const lineHeight = fontSize * 1.4;
            const textBlockH = lines.length * lineHeight;

            // Center entire block vertically
            const totalH = headerH + gapAfterHeader + textBlockH;
            const topY = (canvas.height - totalH) / 2;

            // Avatar
            const avatarCX = padding + avatarR;
            const avatarCY = topY + avatarR;
            if (profilePhotoUrl) {
                try {
                    const img = await loadImage(profilePhotoUrl);
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(avatarCX, avatarCY, avatarR, 0, Math.PI * 2);
                    ctx.clip();
                    ctx.drawImage(img, avatarCX - avatarR, avatarCY - avatarR, avatarR * 2, avatarR * 2);
                    ctx.restore();
                } catch (e) {
                    drawInitialsCircle(ctx, avatarCX, avatarCY, avatarR, companyName, theme);
                }
            } else {
                drawInitialsCircle(ctx, avatarCX, avatarCY, avatarR, companyName, theme);
            }

            // Name
            ctx.textAlign = 'left';
            ctx.font = `bold 64px 'Segoe UI', system-ui, sans-serif`;
            ctx.fillStyle = theme.text;
            ctx.fillText(companyName || 'Your Name', padding + avatarR * 2 + 28, avatarCY - 8);

            // Handle
            const handle = '@' + (companyName || 'user').toLowerCase().replace(/[^a-z0-9]/g, '');
            ctx.font = `44px 'Segoe UI', system-ui, sans-serif`;
            ctx.fillStyle = theme.secondary;
            ctx.fillText(handle, padding + avatarR * 2 + 28, avatarCY + 42);

            // Blue checkmark next to name  with gap
            ctx.font = `bold 64px 'Segoe UI', system-ui, sans-serif`;
            const nameWidth = ctx.measureText(companyName || 'Your Name').width;
            const checkX = padding + avatarR * 2 + 28 + nameWidth + 28;
            const checkCY = avatarCY - 22;
            const checkR = 16;
            // Blue circle
            ctx.beginPath();
            ctx.arc(checkX, checkCY, checkR, 0, Math.PI * 2);
            ctx.fillStyle = '#1d9bf0';
            ctx.fill();
            // White checkmark inside
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3.5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            ctx.moveTo(checkX - 6, checkCY);
            ctx.lineTo(checkX - 1, checkCY + 5);
            ctx.lineTo(checkX + 7, checkCY - 5);
            ctx.stroke();

            // Quote text  Georgia serif for elegant quote feel
            ctx.font = `${fontSize}px Georgia, 'Times New Roman', serif`;
            ctx.fillStyle = theme.text;
            ctx.textAlign = 'left';

            const textStartY = topY + headerH + gapAfterHeader + fontSize;
            lines.forEach((line, i) => {
                ctx.fillText(line, padding, textStartY + (i * lineHeight));
            });

            return canvas.toDataURL('image/png');
        }

        // ========== SOCIAL POST CARD RENDERER ==========
        const socialCardThemes = [
            { name: 'Dark', bg: '#1a1a1a', cardBg: '#2a2a2a', text: '#ffffff', secondary: '#888888', border: '#3a3a3a' },
            { name: 'Light', bg: '#e5e5e5', cardBg: '#f5f5f5', text: '#1a1a1a', secondary: '#666666', border: '#d0d0d0' },
            { name: 'Blue', bg: '#f0f7ff', cardBg: '#ffffff', text: '#1a1a1a', secondary: '#666666', border: '#3b82f6' }
        ];

        async function renderSocialCard(quote, companyName, theme) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1200;
            canvas.height = 1500;  // Rectangular

            // Outer background
            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Card fills most of canvas  minimal outer margin
            const outerMargin = 40;
            const cardX = outerMargin;
            const cardW = canvas.width - (outerMargin * 2);
            const innerPad = 55;
            const innerX = cardX + innerPad;
            const radius = 24;

            // Pre-calculate content height to size card dynamically
            const headerHeight = 70;
            const headerGap = 80;

            let fontSize = 72;
            if (quote.length > 80) fontSize = 62;
            if (quote.length > 120) fontSize = 52;
            if (quote.length > 180) fontSize = 44;

            ctx.font = `${fontSize}px 'Segoe UI', system-ui, sans-serif`;
            const textMaxWidth = cardW - (innerPad * 2);
            const textLines = wrapText(ctx, quote, textMaxWidth);
            const lineHeight = fontSize * 1.5;
            const textBlockHeight = textLines.length * lineHeight;

            const hashHeight = 40;
            const dividerGap = 40;
            const statsHeight = 40;
            const bottomPad = 30;

            const contentHeight = innerPad + headerHeight + headerGap + textBlockHeight + hashHeight + dividerGap + statsHeight + bottomPad + innerPad;
            // Card sizes to content  no empty space
            const cardH = Math.max(contentHeight, 500);

            // Center card vertically
            const cardY = (canvas.height - cardH) / 2;

            // Card shadow
            ctx.fillStyle = 'rgba(0,0,0,0.12)';
            roundedRect(ctx, cardX + 4, cardY + 6, cardW, cardH, radius);
            ctx.fill();

            // Card background
            ctx.fillStyle = theme.cardBg;
            roundedRect(ctx, cardX, cardY, cardW, cardH, radius);
            ctx.fill();

            // Card border
            ctx.strokeStyle = theme.border;
            ctx.lineWidth = 2;
            roundedRect(ctx, cardX, cardY, cardW, cardH, radius);
            ctx.stroke();

            // Avatar
            const avatarY = cardY + innerPad + 36;
            const avatarR = 36;
            if (profilePhotoUrl) {
                try {
                    const img = await loadImage(profilePhotoUrl);
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(innerX + avatarR, avatarY, avatarR, 0, Math.PI * 2);
                    ctx.clip();
                    ctx.drawImage(img, innerX, avatarY - avatarR, avatarR * 2, avatarR * 2);
                    ctx.restore();
                } catch (e) {
                    drawInitialsCircle(ctx, innerX + avatarR, avatarY, avatarR, companyName, theme);
                }
            } else {
                drawInitialsCircle(ctx, innerX + avatarR, avatarY, avatarR, companyName, theme);
            }

            // Name + handle
            ctx.textAlign = 'left';
            ctx.font = `bold 38px 'Segoe UI', system-ui, sans-serif`;
            ctx.fillStyle = theme.text;
            ctx.fillText(companyName || 'Your Company', innerX + 90, avatarY - 4);

            const handle = '@' + (companyName || 'company').toLowerCase().replace(/[^a-z0-9]/g, '');
            ctx.font = `28px 'Segoe UI', system-ui, sans-serif`;
            ctx.fillStyle = theme.secondary;
            ctx.fillText(handle, innerX + 90, avatarY + 32);

            // Three dots menu (horizontal )
            ctx.fillStyle = theme.secondary;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.arc(cardX + cardW - innerPad - 30 + (i * 18), avatarY - 5, 4, 0, Math.PI * 2);
                ctx.fill();
            }

            // Post text body
            ctx.font = `${fontSize}px 'Segoe UI', system-ui, sans-serif`;
            ctx.fillStyle = theme.text;
            ctx.textAlign = 'left';

            const textStartY = avatarY + avatarR + headerGap;
            textLines.forEach((line, i) => {
                ctx.fillText(line, innerX, textStartY + (i * lineHeight));
            });

            // Hashtag line
            const hashY = textStartY + textBlockHeight + 50;
            ctx.font = `28px 'Segoe UI', system-ui, sans-serif`;
            ctx.fillStyle = theme.secondary;
            ctx.fillText('#govcon #quoteoftheday #leadership', innerX, hashY);

            // Divider line  visible
            const dividerY = hashY + dividerGap;
            ctx.strokeStyle = theme.border;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(innerX, dividerY);
            ctx.lineTo(cardX + cardW - innerPad, dividerY);
            ctx.stroke();

            // Randomized engagement numbers
            const commentCount = Math.floor(Math.random() * 400) + 50;
            const likeCount = (Math.random() < 0.5)
                ? (Math.floor(Math.random() * 25) + 5) + 'K'
                : Math.floor(Math.random() * 900) + 100;
            const shareCount = Math.floor(Math.random() * 200) + 20;

            // Engagement stats  icons vertically centered with numbers
            const statsY = dividerY + 36;
            const iconS = 20;  // icon size
            ctx.fillStyle = theme.secondary;
            ctx.strokeStyle = theme.secondary;
            ctx.lineWidth = 2;
            ctx.font = `30px 'Segoe UI', system-ui, sans-serif`;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';

            // Comment icon (speech bubble outline)  centered on statsY
            const cX = innerX;
            const cTop = statsY - iconS / 2;
            ctx.beginPath();
            ctx.moveTo(cX + 3, cTop + iconS);
            ctx.lineTo(cX + 6, cTop + iconS - 5);
            ctx.lineTo(cX + iconS - 2, cTop + iconS - 5);
            ctx.quadraticCurveTo(cX + iconS + 2, cTop + iconS - 5, cX + iconS + 2, cTop + iconS - 10);
            ctx.lineTo(cX + iconS + 2, cTop + 4);
            ctx.quadraticCurveTo(cX + iconS + 2, cTop, cX + iconS - 2, cTop);
            ctx.lineTo(cX + 4, cTop);
            ctx.quadraticCurveTo(cX, cTop, cX, cTop + 4);
            ctx.lineTo(cX, cTop + iconS - 10);
            ctx.quadraticCurveTo(cX, cTop + iconS - 5, cX + 3, cTop + iconS - 5);
            ctx.closePath();
            ctx.stroke();
            ctx.fillText(String(commentCount), cX + iconS + 12, statsY);

            // Heart icon (FILLED)  centered on statsY
            const hX = innerX + 170;
            const hCY = statsY;
            const hs = 11;  // half-size of heart
            ctx.beginPath();
            ctx.moveTo(hX, hCY + hs * 0.7);
            ctx.bezierCurveTo(hX - hs * 1.1, hCY - hs * 0.3, hX - hs * 1.1, hCY - hs, hX - hs * 0.55, hCY - hs);
            ctx.bezierCurveTo(hX - hs * 0.1, hCY - hs, hX, hCY - hs * 0.4, hX, hCY - hs * 0.4);
            ctx.bezierCurveTo(hX, hCY - hs * 0.4, hX + hs * 0.1, hCY - hs, hX + hs * 0.55, hCY - hs);
            ctx.bezierCurveTo(hX + hs * 1.1, hCY - hs, hX + hs * 1.1, hCY - hs * 0.3, hX, hCY + hs * 0.7);
            ctx.closePath();
            ctx.fill();
            ctx.fillText(String(likeCount), hX + hs + 10, statsY);

            // Share icon (arrow outline)  centered on statsY
            const sX = innerX + 360;
            const sTop = statsY - iconS / 2;
            ctx.beginPath();
            ctx.moveTo(sX + 10, sTop);
            ctx.lineTo(sX + 22, sTop + iconS / 2);
            ctx.lineTo(sX + 10, sTop + iconS);
            ctx.lineTo(sX + 10, sTop + iconS * 0.65);
            ctx.quadraticCurveTo(sX, sTop + iconS * 0.65, sX, sTop + iconS);
            ctx.lineTo(sX, sTop + iconS);
            ctx.quadraticCurveTo(sX - 2, sTop + iconS * 0.4, sX + 10, sTop + iconS * 0.35);
            ctx.closePath();
            ctx.stroke();
            ctx.fillText(String(shareCount), sX + 30, statsY);

            ctx.textBaseline = 'alphabetic';

            return canvas.toDataURL('image/png');
        }

        // Load image helper (returns Promise<HTMLImageElement>)
        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = url;
            });
        }

        // Draw initials circle helper
        function drawInitialsCircle(ctx, cx, cy, r, companyName, theme) {
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.fillStyle = theme.secondary;
            ctx.globalAlpha = 0.3;
            ctx.fill();
            ctx.globalAlpha = 1;

            const initials = (companyName || 'GC').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            ctx.font = `bold ${Math.round(r * 0.9)}px 'Segoe UI', system-ui, sans-serif`;
            ctx.fillStyle = theme.text;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initials, cx, cy);
            ctx.textBaseline = 'alphabetic';
        }

        // Rounded rectangle helper
        function roundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        // ========== HIGHLIGHTER QUOTE RENDERER ==========
        const highlighterThemes = [
            { name: 'Lime', bg: '#f0ece0', text: '#000000', highlight: '#c8f542' },
            { name: 'Peach', bg: '#f0ece0', text: '#000000', highlight: '#e8b88a' },
            { name: 'Blue', bg: '#f0ece0', text: '#000000', highlight: '#5bb5f0' },
            { name: 'Dark Blue', bg: '#1a1a1a', text: '#ffffff', highlight: '#5bb5f0' }
        ];

        // Assign themes to layouts now that all arrays are defined
        graphicLayouts.classic.themes = quoteCardStyles;
        graphicLayouts.tweet.themes = socialCardThemes;
        graphicLayouts.social.themes = tweetQuoteThemes;
        graphicLayouts.highlighter.themes = highlighterThemes;

        // ========== PHOTO QUOTE RENDERER ==========
        const photoQuoteThemes = [
            { name: 'Gold', accent: '#c5a028', gradientStart: 'rgba(0,0,0,0)', gradientEnd: 'rgba(0,0,0,0.92)' },
            { name: 'Blue', accent: '#4a9eff', gradientStart: 'rgba(0,0,0,0)', gradientEnd: 'rgba(0,0,0,0.92)' },
            { name: 'Green', accent: '#34d399', gradientStart: 'rgba(0,0,0,0)', gradientEnd: 'rgba(0,0,0,0.92)' },
            { name: 'Red', accent: '#f87171', gradientStart: 'rgba(0,0,0,0)', gradientEnd: 'rgba(0,0,0,0.92)' }
        ];
        graphicLayouts.photoquote.themes = photoQuoteThemes;

        async function renderHighlighterQuote(data, companyName, theme) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1200;
            canvas.height = 1500;  // Taller for vertical text flow

            // Background
            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Subtle paper texture
            ctx.globalAlpha = 0.03;
            for (let i = 0; i < 200; i++) {
                ctx.fillStyle = theme.text;
                ctx.fillRect(
                    Math.random() * canvas.width,
                    Math.random() * canvas.height,
                    Math.random() * 3 + 1,
                    Math.random() * 3 + 1
                );
            }
            ctx.globalAlpha = 1;

            const rawQuote = data.quote || '';
            const quote = '\u201C' + rawQuote + '\u201D';  // Wrap in curly quotes
            const highlights = (data.highlights || []).map(h => h.toLowerCase());
            const padding = 120;

            // Narrower max width = fewer words per line = taller vertical flow
            const narrowWidth = canvas.width * 0.70;

            // Dynamic font size  start big, shrink to fit
            let fontSize = 80;
            const minFont = 44;
            let lines, lineHeight, totalHeight;
            const attrSpace = 100; // space for attribution below text
            const availableH = canvas.height - padding * 2 - attrSpace;

            while (fontSize >= minFont) {
                ctx.font = `bold ${fontSize}px Georgia, 'Times New Roman', serif`;
                lines = wrapText(ctx, quote, narrowWidth);
                lineHeight = fontSize * 1.6;
                totalHeight = lines.length * lineHeight;
                if (totalHeight <= availableH) break;
                fontSize -= 4;
            }

            // Center text block + attribution as one unit
            const totalBlockH = totalHeight + attrSpace;
            const startY = (canvas.height - totalBlockH) / 2 + fontSize / 2;

            // Draw each line LEFT-ALIGNED, word by word with highlights
            lines.forEach((line, lineIdx) => {
                const y = startY + (lineIdx * lineHeight);
                const words = line.split(' ');

                // Left-aligned with padding (like reference image)
                let x = padding;

                words.forEach((word) => {
                    ctx.font = `bold ${fontSize}px Georgia, 'Times New Roman', serif`;
                    const wordOnlyWidth = ctx.measureText(word).width;
                    const spaceWidth = ctx.measureText(' ').width;
                    const cleanWord = word.replace(/[.,!?;:\u201C\u201D'"]/g, '').toLowerCase();

                    // Check if this word matches any highlight
                    const isHighlighted = highlights.some(h => {
                        return cleanWord === h || cleanWord.includes(h) || h.includes(cleanWord);
                    });

                    if (isHighlighted) {
                        const highlightPad = 8;
                        ctx.fillStyle = theme.highlight;
                        ctx.globalAlpha = 0.85;
                        ctx.fillRect(
                            x - highlightPad,
                            y - fontSize * 0.75,
                            wordOnlyWidth + highlightPad * 2,
                            fontSize * 1.1
                        );
                        ctx.globalAlpha = 1;
                    }

                    // Draw the word
                    ctx.fillStyle = theme.text;
                    ctx.textAlign = 'left';
                    ctx.fillText(word, x, y);
                    x += wordOnlyWidth + spaceWidth;
                });
            });

            // Attribution right below the last line of text
            if (companyName) {
                const lastLineY = startY + ((lines.length - 1) * lineHeight);
                ctx.font = `italic 34px Georgia, 'Times New Roman', serif`;
                ctx.fillStyle = theme.text;
                ctx.globalAlpha = 0.5;
                ctx.textAlign = 'left';
                ctx.fillText('\u2014 ' + companyName, padding, lastLineY + lineHeight + 30);
                ctx.globalAlpha = 1;
            }

            return canvas.toDataURL('image/png');
        }

        // ========== PHOTO QUOTE RENDERER ==========
        async function renderPhotoQuote(data, companyName, theme) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1200;
            canvas.height = 1500;

            // Dark base
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const quote = data.quote || '';
            const highlights = (data.highlights || []).map(h => h.toLowerCase());
            const padding = 60;
            const tagline = document.getElementById('profile-tagline')?.value?.trim() || '';

            // === LAYOUT CONSTANTS ===
            const accentBarH = 8;
            const avatarR = 44;                  // Bigger avatar
            const attrPaddingBottom = 30;        // Space below attribution to accent bar
            const attrHeight = avatarR * 2 + 10; // Attribution block height
            const attrTopY = canvas.height - accentBarH - attrPaddingBottom - attrHeight;
            const quoteMarkH = 90;               // Space for opening quote mark
            const textPaddingBottom = 30;         // Gap between last text line and attribution

            // Text zone: from 45% of canvas down to just above attribution
            const textStartY = canvas.height * 0.45;
            const textZoneTop = textStartY + quoteMarkH;
            const textZoneBottom = attrTopY - textPaddingBottom;
            const availableTextHeight = textZoneBottom - textZoneTop;
            const maxWidth = canvas.width - (padding * 2);

            // === DYNAMIC FONT SIZING ===
            // Try progressively smaller sizes until text fits the available area
            let fontSize = 120; // Start large
            const minFontSize = 40;
            let lines, lineHeight, totalTextHeight;

            while (fontSize >= minFontSize) {
                ctx.font = `bold ${fontSize}px 'Segoe UI', system-ui, sans-serif`;
                lines = wrapText(ctx, quote, maxWidth);
                lineHeight = fontSize * 1.25;
                totalTextHeight = lines.length * lineHeight;

                if (totalTextHeight <= availableTextHeight) {
                    break;
                }
                fontSize -= 4;
            }

            // Center the text block vertically within the text zone
            const textBlockStartY = textZoneTop + (availableTextHeight - totalTextHeight) / 2 + fontSize;

            // === DRAW PHOTO ===
            if (backgroundPhotoUrl) {
                try {
                    const img = await loadImage(backgroundPhotoUrl);
                    const imgRatio = img.width / img.height;
                    const canvasRatio = canvas.width / canvas.height;

                    let sx = 0, sy = 0, sw = img.width, sh = img.height;
                    if (imgRatio > canvasRatio) {
                        sw = img.height * canvasRatio;
                        sx = (img.width - sw) / 2;
                    } else {
                        sh = img.width / canvasRatio;
                        sy = 0;
                    }
                    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
                } catch (e) {
                    console.error('Failed to load photo for Photo Quote:', e);
                }
            }

            // === GRADIENT OVERLAY ===
            // Fade from clear photo to dark where text begins
            const gradStart = textStartY - canvas.height * 0.18;
            const gradEnd = textStartY + canvas.height * 0.06;
            const grad = ctx.createLinearGradient(0, gradStart, 0, gradEnd);
            grad.addColorStop(0, 'rgba(0,0,0,0)');
            grad.addColorStop(0.35, 'rgba(0,0,0,0.35)');
            grad.addColorStop(0.65, 'rgba(0,0,0,0.75)');
            grad.addColorStop(1, 'rgba(0,0,0,0.93)');
            ctx.fillStyle = grad;
            ctx.fillRect(0, gradStart, canvas.width, gradEnd - gradStart);

            // Solid dark from gradient end to bottom
            ctx.fillStyle = 'rgba(0,0,0,0.93)';
            ctx.fillRect(0, gradEnd, canvas.width, canvas.height - gradEnd);

            // === ACCENT BAR at bottom ===
            ctx.fillStyle = theme.accent;
            ctx.fillRect(0, canvas.height - accentBarH, canvas.width, accentBarH);

            // === OPENING QUOTE MARK ===
            ctx.font = `bold 120px Georgia, 'Times New Roman', serif`;
            ctx.fillStyle = theme.accent;
            ctx.textAlign = 'left';
            ctx.textBaseline = 'alphabetic';
            ctx.fillText('\u201C', padding - 10, textStartY + quoteMarkH - 10);

            // === QUOTE TEXT (word-by-word with highlights) ===
            lines.forEach((line, lineIdx) => {
                const y = textBlockStartY + (lineIdx * lineHeight);
                const words = line.split(' ');
                let x = padding;

                words.forEach((word) => {
                    ctx.font = `bold ${fontSize}px 'Segoe UI', system-ui, sans-serif`;
                    ctx.textBaseline = 'alphabetic';
                    ctx.textAlign = 'left';
                    const wordWidth = ctx.measureText(word).width;
                    const spaceWidth = ctx.measureText(' ').width;
                    const cleanWord = word.replace(/[.,!?;:\u201C\u201D'"]/g, '').toLowerCase();

                    const isHighlighted = highlights.some(h => {
                        return cleanWord === h || cleanWord.includes(h) || h.includes(cleanWord);
                    });

                    ctx.fillStyle = isHighlighted ? theme.accent : '#ffffff';
                    ctx.fillText(word, x, y);
                    x += wordWidth + spaceWidth;
                });
            });

            // === ATTRIBUTION  larger avatar, name, tagline ===
            const attrCenterY = attrTopY + avatarR; // Vertical center of avatar
            const attrX = padding;

            if (profilePhotoUrl) {
                try {
                    const img = await loadImage(profilePhotoUrl);
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(attrX + avatarR, attrCenterY, avatarR, 0, Math.PI * 2);
                    ctx.clip();
                    ctx.drawImage(img, attrX, attrCenterY - avatarR, avatarR * 2, avatarR * 2);
                    ctx.restore();

                    ctx.strokeStyle = theme.accent;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(attrX + avatarR, attrCenterY, avatarR, 0, Math.PI * 2);
                    ctx.stroke();
                } catch (e) {
                    drawInitialsCircle(ctx, attrX + avatarR, attrCenterY, avatarR, companyName, { text: '#ffffff', secondary: theme.accent });
                }
            } else {
                drawInitialsCircle(ctx, attrX + avatarR, attrCenterY, avatarR, companyName, { text: '#ffffff', secondary: theme.accent });
            }

            // Name + tagline next to avatar
            const nameX = attrX + avatarR * 2 + 22;
            ctx.textBaseline = 'alphabetic';
            ctx.textAlign = 'left';

            if (tagline) {
                // Two lines: name + tagline, vertically centered on avatar
                ctx.font = `bold 52px 'Segoe UI', system-ui, sans-serif`;
                ctx.fillStyle = '#ffffff';
                ctx.fillText(companyName || 'Your Name', nameX, attrCenterY - 4);
                ctx.font = `36px 'Segoe UI', system-ui, sans-serif`;
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fillText(tagline, nameX, attrCenterY + 40);
            } else {
                // Single line: name centered on avatar
                ctx.font = `bold 52px 'Segoe UI', system-ui, sans-serif`;
                ctx.fillStyle = '#ffffff';
                ctx.fillText(companyName || 'Your Name', nameX, attrCenterY + 16);
            }

            return canvas.toDataURL('image/png');
        }

        // Word wrap helper function
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            words.forEach(word => {
                const testLine = currentLine ? currentLine + ' ' + word : word;
                const metrics = ctx.measureText(testLine);

                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            });

            if (currentLine) {
                lines.push(currentLine);
            }

            return lines;
        }

        function resetGenerator() {
            // Stop any running animations
            stopLoadingAnimation();

            document.getElementById('generated-posts').classList.add('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('generator-form').classList.remove('hidden');

            // Reset progress bar
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) progressBar.style.width = '0%';

            // Reset steps to default state
            const defaultSteps = [
                'Querying USAspending.gov database',
                'Analyzing agency spending patterns',
                'Generating personalized content'
            ];
            defaultSteps.forEach((stepText, index) => {
                const step = document.getElementById(`step-${index + 1}`);
                if (step) {
                    step.className = 'flex items-center gap-3 text-gray-400 transition-all duration-300';
                    step.innerHTML = `
                        <div class="step-icon w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0">
                            <span class="step-number text-xs">${index + 1}</span>
                        </div>
                        <span class="step-text">${stepText}</span>
                    `;
                }
            });

            // Reset post count dropdown to 10 so users don't accidentally re-run 30
            const numPostsEl = document.getElementById('quick-num-posts');
            if (numPostsEl) numPostsEl.value = '10';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // NOTE: saveToLibrary is defined earlier in the file (around line 1036)
        // using direct Supabase insert with proper user.id UUID

        // NOTE: logout() and user display functions are defined earlier using SupabaseAuth
    </script>
</body>
</html>
