// USAspending API Helper Functions
import type { AlternativeSearchOption } from '@/types/federal-market-assassin';

// Map business types to USAspending set-aside codes
export const setAsideMap: Record<string, string[]> = {
  'Women Owned': ['WOSB', 'EDWOSB'],
  'HUBZone': ['HZBZ', 'HUBZ'],
  '8(a) Certified': ['8A', '8AN', '8A COMPETED', '8A SOLE SOURCE'],
  'Small Business': ['SBA', 'SBP', 'SMALL BUSINESS SET-ASIDE', 'TOTAL SMALL BUSINESS SET-ASIDE (FAR 19.5)'],
  'DOT Certified': ['SBP'],
  'Native American/Tribal': ['IND']
};

export const veteranMap: Record<string, string[]> = {
  'Veteran Owned': ['VOSB', 'VO'],
  'Service Disabled Veteran': ['SDVOSB', 'SDVOSBC']
};

// NAICS expansion mapping for all sectors and common subsectors
export const naicsExpansion: Record<string, string[]> = {
  // ============================================
  // SECTOR 11: Agriculture, Forestry, Fishing and Hunting
  // ============================================
  '11': ['111110', '111120', '111130', '111140', '111150', '111160', '111191', '111199', '111211', '111219', '111310', '111320', '111331', '111332', '111333', '111334', '111335', '111336', '111339', '111411', '111419', '111421', '111422', '111910', '111920', '111930', '111940', '111991', '111992', '111998', '112111', '112112', '112120', '112130', '112210', '112310', '112320', '112330', '112340', '112390', '112410', '112420', '112511', '112512', '112519', '112910', '112920', '112930', '112990', '113110', '113210', '113310', '114111', '114112', '114119', '114210', '115111', '115112', '115113', '115114', '115115', '115116', '115210', '115310'],
  '111': ['111110', '111120', '111130', '111140', '111150', '111160', '111191', '111199', '111211', '111219', '111310', '111320', '111331', '111332', '111333', '111334', '111335', '111336', '111339', '111411', '111419', '111421', '111422', '111910', '111920', '111930', '111940', '111991', '111992', '111998'],
  '112': ['112111', '112112', '112120', '112130', '112210', '112310', '112320', '112330', '112340', '112390', '112410', '112420', '112511', '112512', '112519', '112910', '112920', '112930', '112990'],
  '113': ['113110', '113210', '113310'],
  '114': ['114111', '114112', '114119', '114210'],
  '115': ['115111', '115112', '115113', '115114', '115115', '115116', '115210', '115310'],

  // ============================================
  // SECTOR 21: Mining, Quarrying, and Oil and Gas Extraction
  // ============================================
  '21': ['211120', '211130', '212111', '212112', '212113', '212114', '212115', '212210', '212220', '212230', '212290', '212311', '212312', '212313', '212319', '212321', '212322', '212323', '212390', '213111', '213112', '213113', '213114', '213115'],
  '211': ['211120', '211130'],
  '212': ['212111', '212112', '212113', '212114', '212115', '212210', '212220', '212230', '212290', '212311', '212312', '212313', '212319', '212321', '212322', '212323', '212390'],
  '213': ['213111', '213112', '213113', '213114', '213115'],

  // ============================================
  // SECTOR 22: Utilities
  // ============================================
  '22': ['221111', '221112', '221113', '221114', '221115', '221116', '221117', '221118', '221121', '221122', '221210', '221310', '221320', '221330'],
  '221': ['221111', '221112', '221113', '221114', '221115', '221116', '221117', '221118', '221121', '221122', '221210', '221310', '221320', '221330'],

  // ============================================
  // SECTOR 23: Construction
  // ============================================
  '23': ['236115', '236116', '236117', '236118', '236210', '236220', '237110', '237120', '237130', '237210', '237310', '237990', '238110', '238120', '238130', '238140', '238150', '238160', '238170', '238190', '238210', '238220', '238290', '238310', '238320', '238330', '238340', '238350', '238390', '238910', '238990'],
  '236': ['236115', '236116', '236117', '236118', '236210', '236220'],
  '237': ['237110', '237120', '237130', '237210', '237310', '237990'],
  '238': ['238110', '238120', '238130', '238140', '238150', '238160', '238170', '238190', '238210', '238220', '238290', '238310', '238320', '238330', '238340', '238350', '238390', '238910', '238990'],

  // ============================================
  // SECTOR 31-33: Manufacturing
  // ============================================
  '31': ['311111', '311119', '311211', '311212', '311213', '311221', '311224', '311225', '311230', '311313', '311314', '311340', '311351', '311352', '311411', '311412', '311421', '311422', '311423', '311511', '311512', '311513', '311514', '311520', '311611', '311612', '311613', '311615', '311710', '311811', '311812', '311813', '311821', '311824', '311830', '311911', '311919', '311920', '311930', '311941', '311942', '311991', '311999', '312111', '312112', '312113', '312120', '312130', '312140', '312230', '313110', '313210', '313220', '313230', '313240', '313310', '313320', '314110', '314120', '314910', '314994', '314999', '315110', '315190', '315210', '315220', '315240', '315280', '315990', '316110', '316210', '316992', '316998'],
  '32': ['321113', '321114', '321211', '321212', '321213', '321214', '321219', '321911', '321912', '321918', '321920', '321991', '321992', '321999', '322110', '322120', '322130', '322211', '322212', '322219', '322220', '322230', '322291', '322299', '323111', '323113', '323117', '323120', '324110', '324121', '324122', '324191', '324199', '325110', '325120', '325130', '325180', '325193', '325194', '325199', '325211', '325212', '325220', '325311', '325312', '325314', '325320', '325411', '325412', '325413', '325414', '325510', '325520', '325611', '325612', '325613', '325620', '325910', '325920', '325991', '325992', '325998', '326111', '326112', '326113', '326121', '326122', '326130', '326140', '326150', '326160', '326191', '326199', '326211', '326212', '326220', '326291', '326299', '327110', '327120', '327211', '327212', '327213', '327310', '327320', '327331', '327332', '327390', '327410', '327420', '327910', '327991', '327992', '327993', '327999'],
  '33': ['331110', '331210', '331221', '331222', '331313', '331314', '331315', '331318', '331410', '331420', '331491', '331492', '331511', '331512', '331513', '331523', '331524', '331529', '332111', '332112', '332114', '332117', '332119', '332215', '332216', '332311', '332312', '332313', '332321', '332322', '332323', '332410', '332420', '332431', '332439', '332510', '332613', '332618', '332710', '332721', '332722', '332811', '332812', '332813', '332911', '332912', '332913', '332919', '332991', '332992', '332993', '332994', '332996', '332999', '333111', '333112', '333120', '333131', '333132', '333241', '333242', '333243', '333244', '333249', '333310', '333413', '333414', '333415', '333511', '333514', '333515', '333517', '333519', '333611', '333612', '333613', '333618', '333912', '333914', '333921', '333922', '333923', '333924', '333991', '333992', '333993', '333994', '333995', '333996', '333997', '333998', '334111', '334112', '334118', '334210', '334220', '334290', '334310', '334412', '334413', '334416', '334417', '334418', '334419', '334510', '334511', '334512', '334513', '334514', '334515', '334516', '334517', '334519', '334610', '334614', '335131', '335132', '335139', '335210', '335220', '335311', '335312', '335313', '335314', '335910', '335921', '335929', '335931', '335932', '335991', '335999', '336110', '336120', '336211', '336212', '336213', '336214', '336310', '336320', '336330', '336340', '336350', '336360', '336370', '336390', '336411', '336412', '336413', '336414', '336415', '336419', '336510', '336611', '336612', '336991', '336992', '336999', '337110', '337121', '337122', '337124', '337125', '337127', '337211', '337212', '337214', '337215', '337910', '337920', '339112', '339113', '339114', '339115', '339116', '339910', '339920', '339930', '339940', '339950', '339991', '339992', '339999'],
  '311': ['311111', '311119', '311211', '311212', '311213', '311221', '311224', '311225', '311230', '311313', '311314', '311340', '311351', '311352', '311411', '311412', '311421', '311422', '311423', '311511', '311512', '311513', '311514', '311520', '311611', '311612', '311613', '311615', '311710', '311811', '311812', '311813', '311821', '311824', '311830', '311911', '311919', '311920', '311930', '311941', '311942', '311991', '311999'],
  '312': ['312111', '312112', '312113', '312120', '312130', '312140', '312230'],
  '313': ['313110', '313210', '313220', '313230', '313240', '313310', '313320'],
  '314': ['314110', '314120', '314910', '314994', '314999'],
  '315': ['315110', '315190', '315210', '315220', '315240', '315280', '315990'],
  '316': ['316110', '316210', '316992', '316998'],
  '321': ['321113', '321114', '321211', '321212', '321213', '321214', '321219', '321911', '321912', '321918', '321920', '321991', '321992', '321999'],
  '322': ['322110', '322120', '322130', '322211', '322212', '322219', '322220', '322230', '322291', '322299'],
  '323': ['323111', '323113', '323117', '323120'],
  '324': ['324110', '324121', '324122', '324191', '324199'],
  '325': ['325110', '325120', '325130', '325180', '325193', '325194', '325199', '325211', '325212', '325220', '325311', '325312', '325314', '325320', '325411', '325412', '325413', '325414', '325510', '325520', '325611', '325612', '325613', '325620', '325910', '325920', '325991', '325992', '325998'],
  '326': ['326111', '326112', '326113', '326121', '326122', '326130', '326140', '326150', '326160', '326191', '326199', '326211', '326212', '326220', '326291', '326299'],
  '327': ['327110', '327120', '327211', '327212', '327213', '327310', '327320', '327331', '327332', '327390', '327410', '327420', '327910', '327991', '327992', '327993', '327999'],
  '331': ['331110', '331210', '331221', '331222', '331313', '331314', '331315', '331318', '331410', '331420', '331491', '331492', '331511', '331512', '331513', '331523', '331524', '331529'],
  '332': ['332111', '332112', '332114', '332117', '332119', '332215', '332216', '332311', '332312', '332313', '332321', '332322', '332323', '332410', '332420', '332431', '332439', '332510', '332613', '332618', '332710', '332721', '332722', '332811', '332812', '332813', '332911', '332912', '332913', '332919', '332991', '332992', '332993', '332994', '332996', '332999'],
  '333': ['333111', '333112', '333120', '333131', '333132', '333241', '333242', '333243', '333244', '333249', '333310', '333413', '333414', '333415', '333511', '333514', '333515', '333517', '333519', '333611', '333612', '333613', '333618', '333912', '333914', '333921', '333922', '333923', '333924', '333991', '333992', '333993', '333994', '333995', '333996', '333997', '333998'],
  '334': ['334111', '334112', '334118', '334210', '334220', '334290', '334310', '334412', '334413', '334416', '334417', '334418', '334419', '334510', '334511', '334512', '334513', '334514', '334515', '334516', '334517', '334519', '334610', '334614'],
  '335': ['335131', '335132', '335139', '335210', '335220', '335311', '335312', '335313', '335314', '335910', '335921', '335929', '335931', '335932', '335991', '335999'],
  '336': ['336110', '336120', '336211', '336212', '336213', '336214', '336310', '336320', '336330', '336340', '336350', '336360', '336370', '336390', '336411', '336412', '336413', '336414', '336415', '336419', '336510', '336611', '336612', '336991', '336992', '336999'],
  '337': ['337110', '337121', '337122', '337124', '337125', '337127', '337211', '337212', '337214', '337215', '337910', '337920'],
  '339': ['339112', '339113', '339114', '339115', '339116', '339910', '339920', '339930', '339940', '339950', '339991', '339992', '339999'],

  // ============================================
  // SECTOR 42: Wholesale Trade
  // ============================================
  '42': ['423110', '423120', '423130', '423140', '423210', '423220', '423310', '423320', '423330', '423390', '423410', '423420', '423430', '423440', '423450', '423460', '423490', '423510', '423520', '423610', '423620', '423690', '423710', '423720', '423730', '423740', '423810', '423820', '423830', '423840', '423850', '423860', '423910', '423920', '423930', '423940', '423990', '424110', '424120', '424130', '424210', '424310', '424320', '424330', '424340', '424410', '424420', '424430', '424440', '424450', '424460', '424470', '424480', '424490', '424510', '424520', '424590', '424610', '424690', '424710', '424720', '424810', '424820', '424910', '424920', '424930', '424940', '424950', '424990', '425110', '425120'],
  '423': ['423110', '423120', '423130', '423140', '423210', '423220', '423310', '423320', '423330', '423390', '423410', '423420', '423430', '423440', '423450', '423460', '423490', '423510', '423520', '423610', '423620', '423690', '423710', '423720', '423730', '423740', '423810', '423820', '423830', '423840', '423850', '423860', '423910', '423920', '423930', '423940', '423990'],
  '424': ['424110', '424120', '424130', '424210', '424310', '424320', '424330', '424340', '424410', '424420', '424430', '424440', '424450', '424460', '424470', '424480', '424490', '424510', '424520', '424590', '424610', '424690', '424710', '424720', '424810', '424820', '424910', '424920', '424930', '424940', '424950', '424990'],
  '425': ['425110', '425120'],

  // ============================================
  // SECTOR 44-45: Retail Trade
  // ============================================
  '44': ['441110', '441120', '441210', '441222', '441227', '441330', '442110', '442210', '442291', '442299', '443141', '443142', '444110', '444120', '444130', '444180', '444190', '444210', '444220', '445110', '445120', '445131', '445132', '445230', '445240', '445250', '445291', '445292', '445298', '445320', '446110', '446120', '446130', '446191', '446199', '447110', '447190', '448110', '448120', '448130', '448140', '448150', '448190', '448210', '448310', '448320', '449110', '449121', '449122', '449129', '449210'],
  '45': ['451110', '451120', '451130', '451140', '452210', '452311', '452319', '453110', '453210', '453220', '453310', '453910', '453920', '453930', '453991', '453998', '454110', '454310', '454390'],
  '441': ['441110', '441120', '441210', '441222', '441227', '441330'],
  '442': ['442110', '442210', '442291', '442299'],
  '443': ['443141', '443142'],
  '444': ['444110', '444120', '444130', '444180', '444190', '444210', '444220'],
  '445': ['445110', '445120', '445131', '445132', '445230', '445240', '445250', '445291', '445292', '445298', '445320'],
  '446': ['446110', '446120', '446130', '446191', '446199'],
  '447': ['447110', '447190'],
  '448': ['448110', '448120', '448130', '448140', '448150', '448190', '448210', '448310', '448320'],
  '449': ['449110', '449121', '449122', '449129', '449210'],
  '451': ['451110', '451120', '451130', '451140'],
  '452': ['452210', '452311', '452319'],
  '453': ['453110', '453210', '453220', '453310', '453910', '453920', '453930', '453991', '453998'],
  '454': ['454110', '454310', '454390'],

  // ============================================
  // SECTOR 48-49: Transportation and Warehousing
  // ============================================
  '48': ['481111', '481112', '481211', '481212', '481219', '482111', '482112', '483111', '483112', '483113', '483114', '483211', '483212', '484110', '484121', '484122', '484210', '484220', '484230', '485111', '485112', '485113', '485119', '485210', '485310', '485320', '485410', '485510', '485991', '485999', '486110', '486210', '486910', '486990', '487110', '487210', '487990', '488111', '488119', '488190', '488210', '488310', '488320', '488330', '488390', '488410', '488490', '488510', '488991', '488999'],
  '49': ['491110', '492110', '492210', '493110', '493120', '493130', '493190'],
  '481': ['481111', '481112', '481211', '481212', '481219'],
  '482': ['482111', '482112'],
  '483': ['483111', '483112', '483113', '483114', '483211', '483212'],
  '484': ['484110', '484121', '484122', '484210', '484220', '484230'],
  '485': ['485111', '485112', '485113', '485119', '485210', '485310', '485320', '485410', '485510', '485991', '485999'],
  '486': ['486110', '486210', '486910', '486990'],
  '487': ['487110', '487210', '487990'],
  '488': ['488111', '488119', '488190', '488210', '488310', '488320', '488330', '488390', '488410', '488490', '488510', '488991', '488999'],
  '491': ['491110'],
  '492': ['492110', '492210'],
  '493': ['493110', '493120', '493130', '493190'],

  // ============================================
  // SECTOR 51: Information
  // ============================================
  '51': ['511110', '511120', '511130', '511140', '511191', '511199', '511210', '512110', '512120', '512131', '512132', '512191', '512199', '512230', '512240', '512250', '512290', '513110', '513120', '513130', '513140', '513191', '513199', '513210', '516110', '516120', '516210', '517111', '517112', '517121', '517122', '517410', '517810', '517911', '517919', '518210', '519110', '519120', '519130', '519190', '519210', '519290'],
  '511': ['511110', '511120', '511130', '511140', '511191', '511199', '511210'],
  '512': ['512110', '512120', '512131', '512132', '512191', '512199', '512230', '512240', '512250', '512290'],
  '513': ['513110', '513120', '513130', '513140', '513191', '513199', '513210'],
  '516': ['516110', '516120', '516210'],
  '517': ['517111', '517112', '517121', '517122', '517410', '517810', '517911', '517919'],
  '518': ['518210'],
  '519': ['519110', '519120', '519130', '519190', '519210', '519290'],

  // ============================================
  // SECTOR 52: Finance and Insurance
  // ============================================
  '52': ['522110', '522120', '522130', '522180', '522190', '522210', '522220', '522291', '522292', '522293', '522294', '522299', '522310', '522320', '522390', '523110', '523120', '523130', '523140', '523150', '523160', '523210', '523900', '524113', '524114', '524126', '524127', '524128', '524130', '524210', '524291', '524292', '524298', '525110', '525120', '525190', '525910', '525920', '525990'],
  '522': ['522110', '522120', '522130', '522180', '522190', '522210', '522220', '522291', '522292', '522293', '522294', '522299', '522310', '522320', '522390'],
  '523': ['523110', '523120', '523130', '523140', '523150', '523160', '523210', '523900'],
  '524': ['524113', '524114', '524126', '524127', '524128', '524130', '524210', '524291', '524292', '524298'],
  '525': ['525110', '525120', '525190', '525910', '525920', '525990'],

  // ============================================
  // SECTOR 53: Real Estate and Rental and Leasing
  // ============================================
  '53': ['531110', '531120', '531130', '531190', '531210', '531311', '531312', '531320', '531390', '532111', '532112', '532120', '532210', '532281', '532282', '532283', '532284', '532289', '532310', '532411', '532412', '532420', '532490', '533110'],
  '531': ['531110', '531120', '531130', '531190', '531210', '531311', '531312', '531320', '531390'],
  '532': ['532111', '532112', '532120', '532210', '532281', '532282', '532283', '532284', '532289', '532310', '532411', '532412', '532420', '532490'],
  '533': ['533110'],

  // ============================================
  // SECTOR 54: Professional, Scientific, and Technical Services
  // ============================================
  '54': ['541110', '541120', '541191', '541199', '541211', '541213', '541214', '541219', '541310', '541320', '541330', '541340', '541350', '541360', '541370', '541380', '541410', '541420', '541430', '541490', '541511', '541512', '541513', '541519', '541611', '541612', '541613', '541614', '541618', '541620', '541690', '541713', '541714', '541715', '541720', '541810', '541820', '541830', '541840', '541850', '541860', '541870', '541890', '541910', '541921', '541922', '541930', '541940', '541990'],
  '541': ['541110', '541120', '541191', '541199', '541211', '541213', '541214', '541219', '541310', '541320', '541330', '541340', '541350', '541360', '541370', '541380', '541410', '541420', '541430', '541490', '541511', '541512', '541513', '541519', '541611', '541612', '541613', '541614', '541618', '541620', '541690', '541713', '541714', '541715', '541720', '541810', '541820', '541830', '541840', '541850', '541860', '541870', '541890', '541910', '541921', '541922', '541930', '541940', '541990'],

  // ============================================
  // SECTOR 55: Management of Companies and Enterprises
  // ============================================
  '55': ['551111', '551112', '551114'],
  '551': ['551111', '551112', '551114'],

  // ============================================
  // SECTOR 56: Administrative and Support and Waste Management
  // ============================================
  '56': ['561110', '561210', '561311', '561312', '561320', '561330', '561410', '561421', '561422', '561431', '561439', '561440', '561450', '561491', '561492', '561499', '561510', '561520', '561591', '561599', '561611', '561612', '561613', '561621', '561622', '561710', '561720', '561730', '561740', '561790', '561910', '561920', '561990', '562111', '562112', '562119', '562211', '562212', '562213', '562219', '562910', '562920', '562991', '562998'],
  '561': ['561110', '561210', '561311', '561312', '561320', '561330', '561410', '561421', '561422', '561431', '561439', '561440', '561450', '561491', '561492', '561499', '561510', '561520', '561591', '561599', '561611', '561612', '561613', '561621', '561622', '561710', '561720', '561730', '561740', '561790', '561910', '561920', '561990'],
  '562': ['562111', '562112', '562119', '562211', '562212', '562213', '562219', '562910', '562920', '562991', '562998'],

  // ============================================
  // SECTOR 61: Educational Services
  // ============================================
  '61': ['611110', '611210', '611310', '611410', '611420', '611430', '611511', '611512', '611513', '611519', '611610', '611620', '611630', '611691', '611692', '611699', '611710'],
  '611': ['611110', '611210', '611310', '611410', '611420', '611430', '611511', '611512', '611513', '611519', '611610', '611620', '611630', '611691', '611692', '611699', '611710'],

  // ============================================
  // SECTOR 62: Health Care and Social Assistance
  // ============================================
  '62': ['621111', '621112', '621210', '621310', '621320', '621330', '621340', '621391', '621399', '621410', '621420', '621491', '621492', '621493', '621498', '621511', '621512', '621610', '621910', '621991', '621999', '622110', '622210', '622310', '623110', '623210', '623220', '623311', '623312', '623990', '624110', '624120', '624190', '624210', '624221', '624229', '624230', '624310', '624410'],
  '621': ['621111', '621112', '621210', '621310', '621320', '621330', '621340', '621391', '621399', '621410', '621420', '621491', '621492', '621493', '621498', '621511', '621512', '621610', '621910', '621991', '621999'],
  '622': ['622110', '622210', '622310'],
  '623': ['623110', '623210', '623220', '623311', '623312', '623990'],
  '624': ['624110', '624120', '624190', '624210', '624221', '624229', '624230', '624310', '624410'],

  // ============================================
  // SECTOR 71: Arts, Entertainment, and Recreation
  // ============================================
  '71': ['711110', '711120', '711130', '711190', '711211', '711212', '711219', '711310', '711320', '711410', '711510', '712110', '712120', '712130', '712190', '713110', '713120', '713210', '713290', '713910', '713920', '713930', '713940', '713950', '713990'],
  '711': ['711110', '711120', '711130', '711190', '711211', '711212', '711219', '711310', '711320', '711410', '711510'],
  '712': ['712110', '712120', '712130', '712190'],
  '713': ['713110', '713120', '713210', '713290', '713910', '713920', '713930', '713940', '713950', '713990'],

  // ============================================
  // SECTOR 72: Accommodation and Food Services
  // ============================================
  '72': ['721110', '721120', '721191', '721199', '721211', '721214', '721220', '721310', '722310', '722320', '722330', '722410', '722511', '722513', '722514', '722515'],
  '721': ['721110', '721120', '721191', '721199', '721211', '721214', '721220', '721310'],
  '722': ['722310', '722320', '722330', '722410', '722511', '722513', '722514', '722515'],

  // ============================================
  // SECTOR 81: Other Services (except Public Administration)
  // ============================================
  '81': ['811111', '811112', '811113', '811118', '811121', '811122', '811191', '811192', '811198', '811211', '811212', '811213', '811219', '811310', '811411', '811412', '811420', '811430', '811490', '812111', '812112', '812113', '812191', '812199', '812210', '812220', '812310', '812320', '812331', '812332', '812910', '812921', '812922', '812930', '812990', '813110', '813211', '813212', '813219', '813311', '813312', '813319', '813410', '813910', '813920', '813930', '813940', '813990'],
  '811': ['811111', '811112', '811113', '811118', '811121', '811122', '811191', '811192', '811198', '811211', '811212', '811213', '811219', '811310', '811411', '811412', '811420', '811430', '811490'],
  '812': ['812111', '812112', '812113', '812191', '812199', '812210', '812220', '812310', '812320', '812331', '812332', '812910', '812921', '812922', '812930', '812990'],
  '813': ['813110', '813211', '813212', '813219', '813311', '813312', '813319', '813410', '813910', '813920', '813930', '813940', '813990'],

  // ============================================
  // SECTOR 92: Public Administration
  // ============================================
  '92': ['921110', '921120', '921130', '921140', '921150', '921190', '922110', '922120', '922130', '922140', '922150', '922160', '922190', '923110', '923120', '923130', '923140', '924110', '924120', '925110', '925120', '926110', '926120', '926130', '926140', '926150', '927110', '928110', '928120'],
  '921': ['921110', '921120', '921130', '921140', '921150', '921190'],
  '922': ['922110', '922120', '922130', '922140', '922150', '922160', '922190'],
  '923': ['923110', '923120', '923130', '923140'],
  '924': ['924110', '924120'],
  '925': ['925110', '925120'],
  '926': ['926110', '926120', '926130', '926140', '926150'],
  '927': ['927110'],
  '928': ['928110', '928120'],
};

// Industry names for NAICS prefixes - All 20 sectors and common subsectors
export const industryNames: Record<string, string> = {
  // 2-digit sectors (all 20)
  '11': 'Agriculture, Forestry, Fishing and Hunting',
  '21': 'Mining, Quarrying, and Oil and Gas Extraction',
  '22': 'Utilities',
  '23': 'Construction',
  '31': 'Manufacturing (Food, Beverage, Textile, Apparel)',
  '32': 'Manufacturing (Wood, Paper, Printing, Petroleum, Chemical, Plastics)',
  '33': 'Manufacturing (Metal, Machinery, Electronics, Transportation Equipment)',
  '42': 'Wholesale Trade',
  '44': 'Retail Trade (Motor Vehicles, Furniture, Electronics, Building Materials, Food)',
  '45': 'Retail Trade (Sporting Goods, General Merchandise, Miscellaneous)',
  '48': 'Transportation',
  '49': 'Warehousing and Postal',
  '51': 'Information',
  '52': 'Finance and Insurance',
  '53': 'Real Estate and Rental and Leasing',
  '54': 'Professional, Scientific, and Technical Services',
  '55': 'Management of Companies and Enterprises',
  '56': 'Administrative and Support and Waste Management',
  '61': 'Educational Services',
  '62': 'Health Care and Social Assistance',
  '71': 'Arts, Entertainment, and Recreation',
  '72': 'Accommodation and Food Services',
  '81': 'Other Services (except Public Administration)',
  '92': 'Public Administration',

  // 3-digit subsectors
  '111': 'Crop Production',
  '112': 'Animal Production and Aquaculture',
  '113': 'Forestry and Logging',
  '114': 'Fishing, Hunting and Trapping',
  '115': 'Support Activities for Agriculture and Forestry',
  '211': 'Oil and Gas Extraction',
  '212': 'Mining (except Oil and Gas)',
  '213': 'Support Activities for Mining',
  '221': 'Utilities',
  '236': 'Construction of Buildings',
  '237': 'Heavy and Civil Engineering Construction',
  '238': 'Specialty Trade Contractors',
  '311': 'Food Manufacturing',
  '312': 'Beverage and Tobacco Product Manufacturing',
  '313': 'Textile Mills',
  '314': 'Textile Product Mills',
  '315': 'Apparel Manufacturing',
  '316': 'Leather and Allied Product Manufacturing',
  '321': 'Wood Product Manufacturing',
  '322': 'Paper Manufacturing',
  '323': 'Printing and Related Support Activities',
  '324': 'Petroleum and Coal Products Manufacturing',
  '325': 'Chemical Manufacturing',
  '326': 'Plastics and Rubber Products Manufacturing',
  '327': 'Nonmetallic Mineral Product Manufacturing',
  '331': 'Primary Metal Manufacturing',
  '332': 'Fabricated Metal Product Manufacturing',
  '333': 'Machinery Manufacturing',
  '334': 'Computer and Electronic Product Manufacturing',
  '335': 'Electrical Equipment, Appliance, and Component Manufacturing',
  '336': 'Transportation Equipment Manufacturing',
  '337': 'Furniture and Related Product Manufacturing',
  '339': 'Miscellaneous Manufacturing',
  '423': 'Merchant Wholesalers, Durable Goods',
  '424': 'Merchant Wholesalers, Nondurable Goods',
  '425': 'Wholesale Trade Agents and Brokers',
  '441': 'Motor Vehicle and Parts Dealers',
  '442': 'Furniture and Home Furnishings Stores',
  '443': 'Electronics and Appliance Stores',
  '444': 'Building Material and Garden Equipment Dealers',
  '445': 'Food and Beverage Retailers',
  '446': 'Health and Personal Care Retailers',
  '447': 'Gasoline Stations',
  '448': 'Clothing and Clothing Accessories Stores',
  '449': 'Furniture, Home Furnishings, Electronics, and Appliance Retailers',
  '451': 'Sporting Goods, Hobby, Musical Instrument, Book, and Miscellaneous Retailers',
  '452': 'General Merchandise Retailers',
  '453': 'Miscellaneous Store Retailers',
  '454': 'Nonstore Retailers',
  '481': 'Air Transportation',
  '482': 'Rail Transportation',
  '483': 'Water Transportation',
  '484': 'Truck Transportation',
  '485': 'Transit and Ground Passenger Transportation',
  '486': 'Pipeline Transportation',
  '487': 'Scenic and Sightseeing Transportation',
  '488': 'Support Activities for Transportation',
  '491': 'Postal Service',
  '492': 'Couriers and Messengers',
  '493': 'Warehousing and Storage',
  '511': 'Publishing Industries',
  '512': 'Motion Picture and Sound Recording Industries',
  '513': 'Broadcasting and Content Providers',
  '516': 'Internet Publishing and Broadcasting',
  '517': 'Telecommunications',
  '518': 'Data Processing, Hosting, and Related Services',
  '519': 'Web Search Portals, Libraries, Archives, and Other Information Services',
  '522': 'Credit Intermediation and Related Activities',
  '523': 'Securities, Commodity Contracts, and Other Financial Investments',
  '524': 'Insurance Carriers and Related Activities',
  '525': 'Funds, Trusts, and Other Financial Vehicles',
  '531': 'Real Estate',
  '532': 'Rental and Leasing Services',
  '533': 'Lessors of Nonfinancial Intangible Assets',
  '541': 'Professional, Scientific, and Technical Services',
  '551': 'Management of Companies and Enterprises',
  '561': 'Administrative and Support Services',
  '562': 'Waste Management and Remediation Services',
  '611': 'Educational Services',
  '621': 'Ambulatory Health Care Services',
  '622': 'Hospitals',
  '623': 'Nursing and Residential Care Facilities',
  '624': 'Social Assistance',
  '711': 'Performing Arts, Spectator Sports, and Related Industries',
  '712': 'Museums, Historical Sites, and Similar Institutions',
  '713': 'Amusement, Gambling, and Recreation Industries',
  '721': 'Accommodation',
  '722': 'Food Services and Drinking Places',
  '811': 'Repair and Maintenance',
  '812': 'Personal and Laundry Services',
  '813': 'Religious, Grantmaking, Civic, Professional, and Similar Organizations',
  '921': 'Executive, Legislative, and Other General Government Support',
  '922': 'Justice, Public Order, and Safety Activities',
  '923': 'Administration of Human Resource Programs',
  '924': 'Administration of Environmental Quality Programs',
  '925': 'Administration of Housing, Urban Planning, and Community Development',
  '926': 'Administration of Economic Programs',
  '927': 'Space Research and Technology',
  '928': 'National Security and International Affairs'
};

// Office name enhancements
export const officeNameEnhancements: Record<string, string> = {
  'Endist Omaha': 'U.S. Army Engineer District, Omaha',
  'W071': 'U.S. Army Engineer District, Omaha',
  'Endist Sacramento': 'U.S. Army Engineer District, Sacramento',
  'Endist Louisville': 'U.S. Army Engineer District, Louisville',
  'Endist Norfolk': 'U.S. Army Engineer District, Norfolk',
  'USA Eng Spt Ctr Huntsvil': 'U.S. Army Engineering and Support Center, Huntsville, Alabama',
  '2V6': 'U.S. Army Engineering and Support Center, Huntsville, Alabama',
  'ACC-PICA': 'Army Contracting Command - Program Integration and Contracting Activity',
  'W6QK': 'Army Contracting Command',
  'ACC-APG Natick': 'Army Contracting Command - Aberdeen Proving Ground, Natick',
  'ACC-RSA': 'Army Contracting Command - Redstone Arsenal',
  'ACC-APG': 'Army Contracting Command - Aberdeen Proving Ground',
  'Afmc Wpafb Oh': 'Air Force Materiel Command - Wright-Patterson AFB, Ohio',
  'Afsc Maxwell Afb Al': 'Air Force Sustainment Center - Maxwell AFB, Alabama',
  '772 ESS PKD': '772 Enterprise Sourcing Squadron - Wright-Patterson AFB',
  'Navfac Northwest': 'Naval Facilities Engineering Command Northwest',
  'Navfac Atlantic': 'Naval Facilities Engineering Command Atlantic',
  'Navfac Pacific': 'Naval Facilities Engineering Command Pacific',
  'Navsup Flc Norfolk': 'Naval Supply Systems Command Fleet Logistics Center Norfolk',
  'Cbp Oaq': 'U.S. Customs and Border Protection - Office of Acquisition',
  'Svc': 'Service',
  'Dept': 'Department',
  'Hq': 'Headquarters',
  'Cmd': 'Command',
  'Ctr': 'Center'
};

export function enhanceOfficeName(officeName: string | null): string | null {
  if (!officeName) return officeName;

  // Check for direct match
  if (officeNameEnhancements[officeName]) {
    return officeNameEnhancements[officeName];
  }

  // Check for partial matches
  for (const [abbrev, fullName] of Object.entries(officeNameEnhancements)) {
    if (officeName.includes(abbrev)) {
      return fullName;
    }
  }

  return officeName;
}

// State mapping (ZIP code to state) - Comprehensive implementation
export function getStateFromZip(zip: string): string | null {
  const zipNum = parseInt(zip.substring(0, 3));

  // New England
  if (zipNum >= 10 && zipNum <= 27) return 'MA';
  if (zipNum >= 28 && zipNum <= 29) return 'RI';
  if (zipNum >= 30 && zipNum <= 38) return 'NH';
  if (zipNum >= 39 && zipNum <= 49) return 'ME';
  if (zipNum >= 50 && zipNum <= 54) return 'VT';
  if (zipNum >= 60 && zipNum <= 69) return 'CT';

  // Mid-Atlantic
  if (zipNum >= 70 && zipNum <= 89) return 'NJ';
  if (zipNum >= 100 && zipNum <= 149) return 'NY';
  if (zipNum >= 150 && zipNum <= 196) return 'PA';
  if (zipNum >= 197 && zipNum <= 199) return 'DE';

  // DC/MD/VA Area
  if (zipNum >= 200 && zipNum <= 205) return 'DC';
  if (zipNum >= 206 && zipNum <= 219) return 'MD';
  if (zipNum >= 220 && zipNum <= 246) return 'VA';
  if (zipNum >= 247 && zipNum <= 268) return 'WV';

  // Southeast
  if (zipNum >= 270 && zipNum <= 289) return 'NC';
  if (zipNum >= 290 && zipNum <= 299) return 'SC';
  if (zipNum >= 300 && zipNum <= 319) return 'GA';
  if (zipNum >= 320 && zipNum <= 349) return 'FL';
  if (zipNum >= 350 && zipNum <= 369) return 'AL';
  if (zipNum >= 370 && zipNum <= 385) return 'TN';
  if (zipNum >= 386 && zipNum <= 397) return 'MS';
  if (zipNum >= 400 && zipNum <= 427) return 'KY';

  // Midwest
  if (zipNum >= 430 && zipNum <= 459) return 'OH';
  if (zipNum >= 460 && zipNum <= 479) return 'IN';
  if (zipNum >= 480 && zipNum <= 499) return 'MI';
  if (zipNum >= 500 && zipNum <= 528) return 'IA';
  if (zipNum >= 530 && zipNum <= 549) return 'WI';
  if (zipNum >= 550 && zipNum <= 567) return 'MN';
  if (zipNum >= 570 && zipNum <= 577) return 'SD';
  if (zipNum >= 580 && zipNum <= 588) return 'ND';
  if (zipNum >= 590 && zipNum <= 599) return 'MT';
  if (zipNum >= 600 && zipNum <= 629) return 'IL';
  if (zipNum >= 630 && zipNum <= 658) return 'MO';
  if (zipNum >= 660 && zipNum <= 679) return 'KS';
  if (zipNum >= 680 && zipNum <= 693) return 'NE';

  // South Central
  if (zipNum >= 700 && zipNum <= 714) return 'LA';
  if (zipNum >= 716 && zipNum <= 729) return 'AR';
  if (zipNum >= 730 && zipNum <= 749) return 'OK';
  if (zipNum >= 750 && zipNum <= 799) return 'TX';

  // Mountain West
  if (zipNum >= 800 && zipNum <= 816) return 'CO';
  if (zipNum >= 820 && zipNum <= 831) return 'WY';
  if (zipNum >= 832 && zipNum <= 838) return 'ID';
  if (zipNum >= 840 && zipNum <= 847) return 'UT';
  if (zipNum >= 850 && zipNum <= 865) return 'AZ';
  if (zipNum >= 870 && zipNum <= 884) return 'NM';
  if (zipNum >= 889 && zipNum <= 898) return 'NV';

  // Pacific
  if (zipNum >= 900 && zipNum <= 961) return 'CA';
  if (zipNum >= 967 && zipNum <= 968) return 'HI';
  if (zipNum >= 970 && zipNum <= 979) return 'OR';
  if (zipNum >= 980 && zipNum <= 994) return 'WA';
  if (zipNum >= 995 && zipNum <= 999) return 'AK';

  return null;
}

// Comprehensive bordering states mapping
const stateBorders: Record<string, string[]> = {
  // New England
  'ME': ['NH'],
  'NH': ['ME', 'VT', 'MA'],
  'VT': ['NH', 'MA', 'NY'],
  'MA': ['NH', 'VT', 'NY', 'CT', 'RI'],
  'RI': ['MA', 'CT'],
  'CT': ['MA', 'RI', 'NY'],

  // Mid-Atlantic
  'NY': ['VT', 'MA', 'CT', 'NJ', 'PA'],
  'NJ': ['NY', 'PA', 'DE'],
  'PA': ['NY', 'NJ', 'DE', 'MD', 'WV', 'OH'],
  'DE': ['PA', 'MD', 'NJ'],

  // DC/MD/VA Area
  'DC': ['VA', 'MD'],
  'MD': ['VA', 'DC', 'WV', 'PA', 'DE'],
  'VA': ['MD', 'DC', 'WV', 'KY', 'TN', 'NC'],
  'WV': ['VA', 'MD', 'PA', 'OH', 'KY'],

  // Southeast
  'NC': ['VA', 'TN', 'GA', 'SC'],
  'SC': ['NC', 'GA'],
  'GA': ['FL', 'AL', 'TN', 'NC', 'SC'],
  'FL': ['GA', 'AL'],
  'AL': ['FL', 'GA', 'TN', 'MS'],
  'TN': ['KY', 'VA', 'NC', 'GA', 'AL', 'MS', 'AR', 'MO'],
  'MS': ['TN', 'AL', 'LA', 'AR'],
  'KY': ['IN', 'OH', 'WV', 'VA', 'TN', 'MO', 'IL'],

  // Midwest
  'OH': ['PA', 'WV', 'KY', 'IN', 'MI'],
  'IN': ['MI', 'OH', 'KY', 'IL'],
  'MI': ['OH', 'IN', 'WI'],
  'IL': ['WI', 'IN', 'KY', 'MO', 'IA'],
  'WI': ['MI', 'IL', 'IA', 'MN'],
  'MN': ['WI', 'IA', 'SD', 'ND'],
  'IA': ['MN', 'WI', 'IL', 'MO', 'NE', 'SD'],
  'MO': ['IA', 'IL', 'KY', 'TN', 'AR', 'OK', 'KS', 'NE'],

  // Great Plains
  'ND': ['MN', 'SD', 'MT'],
  'SD': ['ND', 'MN', 'IA', 'NE', 'WY', 'MT'],
  'NE': ['SD', 'IA', 'MO', 'KS', 'CO', 'WY'],
  'KS': ['NE', 'MO', 'OK', 'CO'],

  // South Central
  'LA': ['TX', 'AR', 'MS'],
  'AR': ['MO', 'TN', 'MS', 'LA', 'TX', 'OK'],
  'OK': ['KS', 'MO', 'AR', 'TX', 'NM', 'CO'],
  'TX': ['LA', 'AR', 'OK', 'NM'],

  // Mountain West
  'MT': ['ND', 'SD', 'WY', 'ID'],
  'WY': ['MT', 'SD', 'NE', 'CO', 'UT', 'ID'],
  'CO': ['WY', 'NE', 'KS', 'OK', 'NM', 'AZ', 'UT'],
  'NM': ['CO', 'OK', 'TX', 'AZ'],
  'AZ': ['CA', 'NV', 'UT', 'CO', 'NM'],
  'UT': ['ID', 'WY', 'CO', 'AZ', 'NV'],
  'ID': ['MT', 'WY', 'UT', 'NV', 'OR', 'WA'],
  'NV': ['CA', 'OR', 'ID', 'UT', 'AZ'],

  // Pacific
  'WA': ['ID', 'OR'],
  'OR': ['WA', 'ID', 'NV', 'CA'],
  'CA': ['OR', 'NV', 'AZ'],

  // Non-contiguous
  'AK': [],
  'HI': [],
};

// Get bordering states (Tier 1 - immediate neighbors)
export function getBorderingStates(state: string): string[] {
  return stateBorders[state] || [];
}

// Get extended region states (Tier 2 - neighbors of neighbors, ~100-200 mile radius)
export function getExtendedRegionStates(state: string): string[] {
  const tier1 = getBorderingStates(state);
  const tier2Set = new Set<string>();

  // Add all states that border our bordering states
  for (const borderState of tier1) {
    const tier2States = getBorderingStates(borderState);
    for (const s of tier2States) {
      if (s !== state && !tier1.includes(s)) {
        tier2Set.add(s);
      }
    }
  }

  return Array.from(tier2Set);
}

// Get states in progressive tiers for search expansion
export function getStatesByTier(state: string): {
  tier1: string[];  // Just the state
  tier2: string[];  // State + bordering states
  tier3: string[];  // State + bordering + extended region
  nationwide: null; // All states (no filter)
} {
  const bordering = getBorderingStates(state);
  const extended = getExtendedRegionStates(state);

  return {
    tier1: [state],
    tier2: [state, ...bordering],
    tier3: [state, ...bordering, ...extended],
    nationwide: null,
  };
}


/**
 * Validate a NAICS code and suggest alternatives if invalid
 * Returns validation result with suggested similar codes
 *
 * IMPORTANT: This function is LENIENT by design. If a user enters something
 * like "81000" which isn't a real NAICS code, we normalize it to "81" (the sector)
 * rather than returning an error. The goal is to help users search, not block them.
 */
export function validateNaicsCode(naicsCode: string): {
  isValid: boolean;
  normalizedCode: string;
  errorMessage?: string;
  suggestedCodes: Array<{ code: string; name: string; }>;
} {
  const trimmed = naicsCode.trim();

  // Check for non-numeric characters
  if (!/^\d+$/.test(trimmed)) {
    return {
      isValid: false,
      normalizedCode: trimmed,
      errorMessage: `NAICS code "${trimmed}" contains invalid characters. NAICS codes must be numeric (2-6 digits).`,
      suggestedCodes: getSuggestedNaicsCodes(trimmed)
    };
  }

  // Check length (2-6 digits)
  if (trimmed.length < 2 || trimmed.length > 6) {
    return {
      isValid: false,
      normalizedCode: trimmed,
      errorMessage: `NAICS code "${trimmed}" has invalid length. NAICS codes are 2-6 digits (e.g., 54 for Professional Services, 541330 for Engineering).`,
      suggestedCodes: getSuggestedNaicsCodes(trimmed)
    };
  }

  // Check if it's a valid sector (2-digit)
  const sector = trimmed.substring(0, 2);
  const validSectors = ['11', '21', '22', '23', '31', '32', '33', '42', '44', '45', '48', '49', '51', '52', '53', '54', '55', '56', '61', '62', '71', '72', '81', '92'];

  if (!validSectors.includes(sector)) {
    return {
      isValid: false,
      normalizedCode: trimmed,
      errorMessage: `NAICS code "${trimmed}" starts with "${sector}" which is not a valid sector. Valid sectors are: 11 (Agriculture), 21 (Mining), 22 (Utilities), 23 (Construction), 31-33 (Manufacturing), 42 (Wholesale), 44-45 (Retail), 48-49 (Transportation), 51 (Information), 52 (Finance), 53 (Real Estate), 54 (Professional Services), 55 (Management), 56 (Administrative), 61 (Education), 62 (Healthcare), 71 (Arts/Entertainment), 72 (Accommodation/Food), 81 (Other Services), 92 (Public Admin).`,
      suggestedCodes: getSuggestedNaicsCodes(trimmed)
    };
  }

  // ============================================
  // SMART NORMALIZATION: Convert trailing-zero codes to their valid prefix
  // This handles cases like "81000" → "81", "811000" → "811", etc.
  // ============================================

  // Normalize codes with trailing zeros to their meaningful prefix
  // Examples: 81000 → 81, 8100 → 81, 810000 → 81, 811000 → 811, 81100 → 811
  let normalizedCode = trimmed;

  // Strip trailing zeros and find the meaningful prefix
  // But keep at least 2 digits (the sector)
  let strippedCode = trimmed.replace(/0+$/, '');
  if (strippedCode.length < 2) {
    strippedCode = sector;
  }

  // Check if the stripped code is a valid prefix we can expand
  if (strippedCode.length >= 2 && strippedCode.length <= 3) {
    // Check if we have an expansion for this prefix
    if (naicsExpansion[strippedCode]) {
      // The stripped code is valid - use it
      return { isValid: true, normalizedCode: strippedCode, suggestedCodes: [] };
    }
    // If 3-digit doesn't exist, try 2-digit sector
    if (strippedCode.length === 3 && naicsExpansion[sector]) {
      return { isValid: true, normalizedCode: sector, suggestedCodes: [] };
    }
  }

  // For 2-digit codes, check if we have expansion
  if (trimmed.length === 2) {
    if (naicsExpansion[trimmed]) {
      return { isValid: true, normalizedCode: trimmed, suggestedCodes: [] };
    }
  }

  // For 3-digit codes, check if we have expansion or if it's part of a valid sector
  if (trimmed.length === 3) {
    if (naicsExpansion[trimmed] || naicsExpansion[sector]) {
      return { isValid: true, normalizedCode: trimmed, suggestedCodes: [] };
    }
    // Check if this 3-digit code exists in any expansion
    const existsInExpansion = Object.values(naicsExpansion).some(codes =>
      codes.some(code => code.startsWith(trimmed))
    );
    if (existsInExpansion) {
      return { isValid: true, normalizedCode: trimmed, suggestedCodes: [] };
    }
    // 3-digit doesn't exist, but if the sector is valid, normalize to sector
    if (naicsExpansion[sector]) {
      return { isValid: true, normalizedCode: sector, suggestedCodes: [] };
    }
  }

  // For 4-6 digit codes, check if they exist in any expansion
  if (trimmed.length >= 4) {
    const existsInExpansion = Object.values(naicsExpansion).some(codes =>
      codes.includes(trimmed) || codes.some(code => code.startsWith(trimmed) || trimmed.startsWith(code))
    );

    if (existsInExpansion) {
      return { isValid: true, normalizedCode: trimmed, suggestedCodes: [] };
    }

    // Code doesn't exist exactly - try to find best valid prefix
    // Check 3-digit prefix first
    const prefix3 = trimmed.substring(0, 3);
    if (naicsExpansion[prefix3]) {
      // Normalize to the 3-digit prefix
      return { isValid: true, normalizedCode: prefix3, suggestedCodes: [] };
    }

    // Check if any 6-digit codes start with this 3-digit prefix
    const prefix3HasCodes = Object.values(naicsExpansion).some(codes =>
      codes.some(code => code.startsWith(prefix3))
    );
    if (prefix3HasCodes) {
      return { isValid: true, normalizedCode: prefix3, suggestedCodes: [] };
    }

    // Fall back to 2-digit sector if it's valid
    if (naicsExpansion[sector]) {
      return { isValid: true, normalizedCode: sector, suggestedCodes: [] };
    }
  }

  // If we get here with a valid sector, just use the sector
  if (naicsExpansion[sector]) {
    return { isValid: true, normalizedCode: sector, suggestedCodes: [] };
  }

  return { isValid: true, normalizedCode: trimmed, suggestedCodes: [] };
}

/**
 * Get suggested NAICS codes similar to the invalid input
 */
function getSuggestedNaicsCodes(invalidCode: string): Array<{ code: string; name: string; }> {
  const suggestions: Array<{ code: string; name: string; }> = [];
  const trimmed = invalidCode.trim().replace(/\D/g, ''); // Remove non-digits

  if (trimmed.length === 0) {
    // Return popular sectors
    return [
      { code: '54', name: 'Professional, Scientific, and Technical Services' },
      { code: '23', name: 'Construction' },
      { code: '56', name: 'Administrative and Support Services' },
      { code: '33', name: 'Manufacturing (Electronics, Transportation Equipment)' },
      { code: '51', name: 'Information' },
    ];
  }

  // Try to find codes that start with the same digits
  const prefix = trimmed.substring(0, Math.min(3, trimmed.length));

  // First, check 2-digit sector
  const sector = trimmed.substring(0, 2);
  if (industryNames[sector]) {
    suggestions.push({ code: sector, name: industryNames[sector] });
  }

  // Find 3-digit subsectors in this sector
  Object.keys(industryNames).forEach(code => {
    if (code.length === 3 && code.startsWith(sector) && code !== prefix) {
      suggestions.push({ code, name: industryNames[code] });
    }
  });

  // If we don't have sector matches, suggest popular codes
  if (suggestions.length === 0) {
    // Find codes that are numerically close
    const numericValue = parseInt(trimmed.substring(0, 2), 10);
    const closeSectors = ['11', '21', '22', '23', '31', '32', '33', '42', '44', '45', '48', '49', '51', '52', '53', '54', '55', '56', '61', '62', '71', '72', '81', '92']
      .map(s => ({ sector: s, diff: Math.abs(parseInt(s, 10) - numericValue) }))
      .sort((a, b) => a.diff - b.diff)
      .slice(0, 5);

    closeSectors.forEach(({ sector }) => {
      if (industryNames[sector]) {
        suggestions.push({ code: sector, name: industryNames[sector] });
      }
    });
  }

  // Limit to 5 suggestions
  return suggestions.slice(0, 5);
}

/**
 * Generate alternative search options when no results are found
 * Progressively relaxes filters to find more results
 */
export function generateAlternativeSearchOptions(inputs: {
  businessType?: string;
  naicsCode?: string;
  zipCode?: string;
  veteranStatus?: string;
  goodsOrServices?: string;
}): AlternativeSearchOption[] {
  const alternatives: AlternativeSearchOption[] = [];
  
  // Alternative 1: Remove location filter (keep NAICS and set-aside)
  if (inputs.zipCode) {
    alternatives.push({
      label: 'Expand to All Locations',
      description: `Remove location restriction (${inputs.zipCode}) but keep your NAICS code and business type filters`,
      filters: {
        naicsCode: inputs.naicsCode,
        businessType: inputs.businessType,
        veteranStatus: inputs.veteranStatus,
        zipCode: null,
      }
    });
  }

  // Alternative 2: Expand NAICS to 3-digit prefix
  if (inputs.naicsCode && inputs.naicsCode.length >= 4) {
    const prefix = inputs.naicsCode.substring(0, 3);
    if (naicsExpansion[prefix]) {
      const industryName = industryNames[prefix] || `${prefix}xx industry`;
      alternatives.push({
        label: `Expand to ${prefix}xx Industry (${industryName})`,
        description: `Search all codes in the ${prefix}xx industry category instead of just ${inputs.naicsCode}`,
        filters: {
          naicsCode: prefix,
          businessType: inputs.businessType,
          veteranStatus: inputs.veteranStatus,
          zipCode: inputs.zipCode,
        }
      });
    }
  }

  // Alternative 3: Remove set-aside restrictions (keep NAICS and location)
  if (inputs.businessType || inputs.veteranStatus) {
    alternatives.push({
      label: 'Remove Business Type Filter',
      description: 'Search all business types but keep your NAICS code and location filters',
      filters: {
        naicsCode: inputs.naicsCode,
        businessType: null,
        veteranStatus: null,
        zipCode: inputs.zipCode,
      }
    });
  }

  // Alternative 4: Remove both location and set-aside (keep NAICS only)
  if (inputs.zipCode && (inputs.businessType || inputs.veteranStatus)) {
    alternatives.push({
      label: 'Keep NAICS Only',
      description: `Remove location and business type filters, search only by NAICS code ${inputs.naicsCode}`,
      filters: {
        naicsCode: inputs.naicsCode,
        businessType: null,
        veteranStatus: null,
        zipCode: null,
      }
    });
  }

  // Alternative 5: Expand NAICS to 3-digit and remove location
  if (inputs.naicsCode && inputs.naicsCode.length >= 4 && inputs.zipCode) {
    const prefix = inputs.naicsCode.substring(0, 3);
    if (naicsExpansion[prefix]) {
      const industryName = industryNames[prefix] || `${prefix}xx industry`;
      alternatives.push({
        label: `Expand to ${prefix}xx Industry, All Locations`,
        description: `Search all codes in ${prefix}xx industry across all locations`,
        filters: {
          naicsCode: prefix,
          businessType: inputs.businessType,
          veteranStatus: inputs.veteranStatus,
          zipCode: null,
        }
      });
    }
  }

  // Alternative 6: Remove all filters except set-aside
  if (inputs.naicsCode && inputs.zipCode && (inputs.businessType || inputs.veteranStatus)) {
    alternatives.push({
      label: 'Keep Business Type Only',
      description: 'Remove NAICS and location filters, search only by your business type',
      filters: {
        naicsCode: null,
        businessType: inputs.businessType,
        veteranStatus: inputs.veteranStatus,
        zipCode: null,
      }
    });
  }

  // Alternative 7: Remove all filters (broadest search)
  if (inputs.naicsCode || inputs.zipCode || inputs.businessType || inputs.veteranStatus) {
    alternatives.push({
      label: 'Remove All Filters',
      description: 'Perform the broadest search with no filters applied',
      filters: {
        naicsCode: null,
        businessType: null,
        veteranStatus: null,
        zipCode: null,
      }
    });
  }

  return alternatives;
}

/**
 * Quick test search to estimate result count for an alternative search option
 * This makes a minimal API call to get result count
 */
export async function estimateAlternativeSearchResults(
  filters: AlternativeSearchOption['filters']
): Promise<number> {
  try {
    const apiFilters: any = {
      award_type_codes: ['A', 'B', 'C', 'D'],
      time_period: [{
        start_date: '2022-10-01',
        end_date: '2025-09-30'
      }]
    };

    // Add NAICS filter if provided
    if (filters.naicsCode) {
      const trimmedNaics = filters.naicsCode.trim();
      if (trimmedNaics.length === 3) {
        const expandedCodes = naicsExpansion[trimmedNaics];
        if (expandedCodes && expandedCodes.length > 0) {
          apiFilters.naics_codes = expandedCodes;
        } else {
          apiFilters.naics_codes = [trimmedNaics];
        }
      } else {
        apiFilters.naics_codes = [trimmedNaics];
      }
    }

    // Add set-aside filter if provided
    const setAsideTypeCodes: string[] = [];
    if (filters.businessType && setAsideMap[filters.businessType]) {
      setAsideTypeCodes.push(...setAsideMap[filters.businessType]);
    }
    if (filters.veteranStatus && veteranMap[filters.veteranStatus]) {
      setAsideTypeCodes.push(...veteranMap[filters.veteranStatus]);
    }
    if (setAsideTypeCodes.length > 0) {
      apiFilters.set_aside_type_codes = setAsideTypeCodes;
    }

    // Add location filter if provided
    if (filters.zipCode) {
      const stateFromZip = getStateFromZip(filters.zipCode);
      if (stateFromZip) {
        const borderingStates = getBorderingStates(stateFromZip);
        const stateCodes = [stateFromZip, ...borderingStates];
        apiFilters.place_of_performance_locations = stateCodes.map(state => ({
          country: 'USA',
          state: state
        }));
      }
    }

    const response = await fetch('https://api.usaspending.gov/api/v2/search/spending_by_award/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        filters: apiFilters,
        fields: ['Award ID'],
        page: 1,
        limit: 100,
        order: 'desc',
        sort: 'Award Amount'
      }),
      signal: AbortSignal.timeout(10000)
    });

    if (!response.ok) return 0;

    const data = await response.json();
    
    // Estimate based on first page results
    if (data?.results && data.results.length > 0) {
      // If we got 100 results, there are likely more
      if (data.results.length === 100) {
        return 500; // Estimate "500+"
      }
      // Otherwise, return actual count (this is just first page, so multiply by estimated pages)
      return data.results.length * 5; // Rough estimate
    }
    
    return 0;
  } catch (error) {
    console.error('Error estimating alternative search results:', error);
    return 0;
  }
}
